<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书院空间使用数据看板</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Dashboard layout overrides */
        :root {
            --sidebar-width: 260px;
            --header-height: 60px;
        }
        /* App Content Override for full layout */
        .app-content {
            padding: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }
        /* Ensure layout fills screen */
        .app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .dash-sidebar {
            width: var(--sidebar-width);
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 0; /* Changed from 16px */
            overflow: hidden; /* Changed from overflow-y: auto */
            transition: width 0.3s;
        }
        .dash-sidebar.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
            border: none;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--card);
            flex-shrink: 0;
        }
        .dash-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg);
            gap: 20px;
        }
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .kpi-card {
            background: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .kpi-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 8px 0;
        }
        .kpi-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .chart-card {
            background: var(--card);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .chart-container {
            flex: 1;
            width: 100%;
            height: 100%;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .filter-group {
            margin-bottom: 16px;
        }
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text);
        }
        .filter-input, .filter-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text);
        }
        .header-bar {
            height: var(--header-height);
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        /* Checkbox list */
        .checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .checkbox-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-tag.checked {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }
        .modal-backdrop {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5); z-index: 999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-backdrop.show { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--card); width: 500px; max-width: 90%;
            padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .week-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .week-item {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-item:hover {
            border-color: var(--primary);
        }
        .week-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }
/* Wizard Styles Removed */
    </style>
</head>
<body>

<div class="header-bar">
    <div style="display:flex;align-items:center;gap:16px">
        <button class="btn" id="toggleSidebar">☰</button>
    </div>
    <div style="display:flex;gap:12px">
        <!-- Buttons removed -->
    </div>
</div>

<div class="app-container">
    <div class="dash-sidebar" id="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border)">
            <h4 style="margin:0">筛选</h4>
            <button class="btn btn-sm" id="resetFilters">重置</button>
        </div>
        
        <div class="sidebar-content">
            <div class="filter-group">
                <label>统计月份</label>
                <input type="month" id="statsMonth" class="input" style="width:100%;padding:8px">
            </div>

            <div class="filter-group">
                <label>周次 / 日期范围</label>
                <div id="weekList" class="week-list"></div>
            </div>

            <div class="filter-group">
                <label>书院</label>
                <div id="academyFilter" class="checkbox-list"></div>
            </div>

            <div class="filter-group">
                <label>周几</label>
                <div id="weekdayFilter" class="checkbox-list"></div>
            </div>

            <div class="filter-group">
                <label>场地</label>
                <div id="locationFilter" class="checkbox-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <div class="filter-group">
                <label>活动类型</label>
                <div id="typeFilter" class="checkbox-list"></div>
            </div>

            <div class="filter-group">
                <label>起始时间</label>
                <div id="startTimeFilter" class="checkbox-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button class="btn btn-primary" id="applyFilters" style="width:100%">应用筛选</button>
        </div>
    </div>

    <div class="dash-main">
        <!-- KPI Cards -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">总活动数</div>
                <div class="kpi-val" id="kpi_events">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">总受众人数</div>
                <div class="kpi-val" id="kpi_audience">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">平均受众/活动</div>
                <div class="kpi-val" id="kpi_avg">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">热门场地 (Top 1)</div>
                <div class="kpi-val" id="kpi_top_loc" style="font-size:18px">-</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-grid">
            <div class="chart-card">
                <h3>周活动分布</h3>
                <div id="chartWeekday" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <h3>时段热力分布 (Start Time)</h3>
                <div id="chartTime" class="chart-container"></div>
            </div>
            <div class="chart-card full-width">
                <h3>场地排行 (Top 20)</h3>
                <div id="chartLocation" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <h3>活动类型占比</h3>
                <div id="chartType" class="chart-container"></div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card full-width">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h3>活动明细</h3>
                <div style="display:flex;gap:8px">
                    <button class="btn" id="prevPage">上一页</button>
                    <span id="pageInfo" style="display:flex;align-items:center">1 / 1</span>
                    <button class="btn" id="nextPage">下一页</button>
                </div>
            </div>
            <div class="table-wrap">
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>日期</th><th>星期</th><th>时间</th><th>书院</th><th>场地</th><th>活动名称</th><th>类型</th><th>人数</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Upload Wizard Modal Removed -->

<div id="appAlertModal" class="modal-backdrop" style="z-index:9999">
    <div class="modal" style="width:400px">
        <h3 id="appAlertTitle">提示</h3>
        <p id="appAlertMsg"></p>
        <div class="actions">
            <button class="btn btn-primary" id="appAlertOk">确定</button>
        </div>
    </div>
</div>

<script src="/static/layout.js"></script>
<!-- 引入 ECharts -->
<script src="/static/lib/echarts.min.js"></script>

<script>
// Popup Logic
const alertModal = document.getElementById('appAlertModal');
const alertTitle = document.getElementById('appAlertTitle');
const alertMsg = document.getElementById('appAlertMsg');
const alertOk = document.getElementById('appAlertOk');
let alertResolve = null;

window.showAlert = (msg, title='提示') => {
    return new Promise(resolve => {
        alertTitle.textContent = title;
        alertMsg.textContent = msg;
        alertModal.classList.add('show');
        alertResolve = resolve;
    });
};

alertOk.addEventListener('click', () => {
    alertModal.classList.remove('show');
    if(alertResolve) alertResolve();
});

// State
let state = {
    page: 1,
    pageSize: 50,
    total: 0,
    month: new Date().toISOString().substring(0, 7),
    filters: {
        start: '', end: '', locations: [], types: [], academies: [], start_times: [], weekdays: []
    },
    charts: {}
};

// DOM Elements
const els = {
    sidebar: document.getElementById('sidebar'),
    toggleSidebar: document.getElementById('toggleSidebar'),
    uploadBtn: document.getElementById('uploadBtn'),
    uploadModal: document.getElementById('uploadModal'),
    closeUpload: document.getElementById('closeUpload'),
    doUpload: document.getElementById('doUpload'),
    fileInput: document.getElementById('fileInput'),
    adminToken: document.getElementById('adminToken'),
    
    // Filters
    statsMonth: document.getElementById('statsMonth'),
    weekList: document.getElementById('weekList'),
    academyFilter: document.getElementById('academyFilter'),
    weekdayFilter: document.getElementById('weekdayFilter'),
    locationFilter: document.getElementById('locationFilter'),
    typeFilter: document.getElementById('typeFilter'),
    startTimeFilter: document.getElementById('startTimeFilter'),
    applyFilters: document.getElementById('applyFilters'),
    resetFilters: document.getElementById('resetFilters'),
    
    // KPIs
    kpi_events: document.getElementById('kpi_events'),
    kpi_audience: document.getElementById('kpi_audience'),
    kpi_avg: document.getElementById('kpi_avg'),
    kpi_top_loc: document.getElementById('kpi_top_loc'),
    
    // Table
    tableBody: document.getElementById('dataTableBody'),
    prevPage: document.getElementById('prevPage'),
    nextPage: document.getElementById('nextPage'),
    pageInfo: document.getElementById('pageInfo')
};

// Init Charts
function initCharts() {
    if (typeof echarts === 'undefined') {
        console.error('ECharts is not loaded');
        return;
    }
    state.charts.weekday = echarts.init(document.getElementById('chartWeekday'));
    state.charts.time = echarts.init(document.getElementById('chartTime'));
    state.charts.location = echarts.init(document.getElementById('chartLocation'));
    state.charts.type = echarts.init(document.getElementById('chartType'));
    
    // Resize Handler (with cleanup to prevent leaks)
    if (window.onActivityDashboardResize) {
        window.removeEventListener('resize', window.onActivityDashboardResize);
    }
    window.onActivityDashboardResize = () => {
        Object.values(state.charts).forEach(c => c.resize());
    };
    window.addEventListener('resize', window.onActivityDashboardResize);
}

// Fetch Options
async function loadOptions() {
    // 1. Fetch options, academies, mapping in parallel
    const [res, acaRes, locMapRes] = await Promise.all([
        fetch('/api/v1/activity/options'),
        fetch('/api/v1/academies'),
        fetch('/api/v1/locations/mapping')
    ]);
    const data = await res.json();
    const acaList = await acaRes.json();
    const locMapData = await locMapRes.json();
    state.locMapping = locMapData.mapping || {};
    
    // 2. Fetch Device Mapping for Locations
    let deviceMap = {};
    try {
        const mapRes = await fetch('/api/v1/devices/mapping');
        if(mapRes.ok) {
            const mapData = await mapRes.json();
            deviceMap = mapData.mapping || {};
        }
    } catch(e) { console.error("Load Mapping Error", e); }
    
    // Render Locations with Custom Names if available
    els.locationFilter.innerHTML = data.locations.map(l => {
        // Try to match location 'l' with device map
        // 'l' might be a UUID or a name. If it's a UUID, we show custom name.
        // If 'l' is a custom name already (from CSV), we just show it.
        const entry = deviceMap[l];
        const name = entry ? (entry.name || l) : l;
        const display = name === l ? l : `${name} (${l})`;
        const assignedAca = state.locMapping[l] || '';
        return `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${l}" data-aca="${assignedAca}">${display}</div>`;
    }).join('');

    // Render Academies (Use Registry + Existing Data)
    // Combine fetched academies and those from data options, dedup
    const academyNames = new Set(acaList.map(a => a.name));
    if(data.academies) data.academies.forEach(a => academyNames.add(a));
    
    els.academyFilter.innerHTML = Array.from(academyNames).sort().map(a => 
        `<div class="checkbox-tag" onclick="toggleAcademy(this)" data-val="${a}">${a}</div>`
    ).join('');
    
    // Render Weekdays (Fixed Mon-Sun)
    const weekMap = {1:'周一', 2:'周二', 3:'周三', 4:'周四', 5:'周五', 6:'周六', 7:'周日'};
    const weekdays = [1,2,3,4,5,6,7];
    els.weekdayFilter.innerHTML = weekdays.map(w =>
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${w}">${weekMap[w]}</div>`
    ).join('');

    // Render Types (Fixed + Existing)
    const fixedTypes = [
        "班团活动", "公益/志愿活动", "会议活动", "培训活动", "其他活动", 
        "全生异科导师活动", "散客访问", "社团活动", "书院活动", 
        "体育活动", "项目工坊活动", "艺术活动", "项目工坊"
    ];
    const typeSet = new Set(fixedTypes);
    if(data.types) data.types.forEach(t => typeSet.add(t));
    
    els.typeFilter.innerHTML = Array.from(typeSet).sort().map(t => 
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${t}">${t}</div>`
    ).join('');
    
    // Render Start Times
    const fixedTimes = [
        "05:30", "06:00", "06:30", "07:00", "07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30",
        "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00",
        "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30",
        "22:00"
    ];

    els.startTimeFilter.innerHTML = fixedTimes.map(t => 
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${t}">${t}</div>`
    ).join('');
}

// Toggle Academy and Filter Locations
function toggleAcademy(el) {
    el.classList.toggle('checked');
    
    const selectedAcademies = Array.from(document.querySelectorAll('#academyFilter .checkbox-tag.checked'))
        .map(e => e.dataset.val);
        
    const locBtns = document.querySelectorAll('#locationFilter .checkbox-tag');
    locBtns.forEach(btn => {
        const assignedAca = btn.dataset.aca;
        let visible = true;
        if (selectedAcademies.length > 0) {
            visible = selectedAcademies.includes(assignedAca);
        }
        btn.style.display = visible ? 'inline-flex' : 'none';
    });
}

// Build Query
function buildQuery(forAgg = false) {
    const p = new URLSearchParams();
    if(state.filters.start) p.append('start_date', state.filters.start);
    if(state.filters.end) p.append('end_date', state.filters.end);
    if(state.filters.locations.length) p.append('locations', state.filters.locations.join(','));
    if(state.filters.academies.length) p.append('academies', state.filters.academies.join(','));
    if(state.filters.weekdays.length) p.append('weekdays', state.filters.weekdays.join(','));
    if(state.filters.types.length) p.append('types', state.filters.types.join(','));
    if(state.filters.start_times.length) p.append('start_times', state.filters.start_times.join(','));
    
    if(!forAgg) {
        p.append('page', state.page);
        p.append('page_size', state.pageSize);
    }
    return p;
}

// Load Data
async function loadData() {
    // Load Aggregations
    const qAgg = buildQuery(true);
    const resAgg = await fetch(`/api/v1/activity/aggregations?${qAgg}`);
    const agg = await resAgg.json();
    updateDashboard(agg);
    
    // Load Table
    const qTab = buildQuery(false);
    const resTab = await fetch(`/api/v1/activity/events?${qTab}`);
    const tab = await resTab.json();
    updateTable(tab);
}

// Update UI
function updateDashboard(data) {
    // KPIs
    if(els.kpi_events) els.kpi_events.textContent = (data.kpis.total_events || 0).toLocaleString();
    if(els.kpi_audience) els.kpi_audience.textContent = (data.kpis.total_audience || 0).toLocaleString();
    if(els.kpi_avg) els.kpi_avg.textContent = data.kpis.avg_audience || 0;
    const top = data.location_top && data.location_top[0];
    if(els.kpi_top_loc) els.kpi_top_loc.textContent = top ? `${top.location} (${top.count})` : '-';
    
    // Check if charts are initialized
    if (!state.charts.weekday) {
        initCharts();
        if (!state.charts.weekday) return; // Still failed
    }

    // Weekday Chart
    const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const wdData = Array(7).fill(0);
    data.weekday.forEach(d => { if(d.weekday>=1 && d.weekday<=7) wdData[d.weekday-1] = d.count; });
    
    state.charts.weekday.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: ['周一','周二','周三','周四','周五','周六','周日'] },
        yAxis: { type: 'value' },
        series: [{ type: 'bar', data: wdData, itemStyle: { color: '#339af0' } }]
    });
    
    // Time Chart (Bar for now, Heatmap needs more prep)
    const hours = Array.from({length:24}, (_,i)=>String(i).padStart(2,'0'));
    const hData = Array(24).fill(0);
    data.time_bins.forEach(d => {
        const h = parseInt(d.hour);
        if(!isNaN(h) && h>=0 && h<24) hData[h] = d.count;
    });
    
    state.charts.time.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: hours.map(h=>h+':00') },
        yAxis: { type: 'value' },
        series: [{ type: 'line', smooth: true, areaStyle: {}, data: hData, itemStyle: { color: '#51cf66' } }]
    });
    
    // Location Chart (Top 20)
    // Sort asc for bar chart y-axis
    const locs = [...data.location_top].reverse();
    state.charts.location.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'value' },
        yAxis: { type: 'category', data: locs.map(d=>d.location) },
        series: [
            { name: '活动数', type: 'bar', data: locs.map(d=>d.count), itemStyle: { color: '#fcc419' } },
            //{ name: '受众', type: 'bar', data: locs.map(d=>d.audience) }
        ]
    });
    
    // Type Chart
    state.charts.type.setOption({
        tooltip: { trigger: 'item' },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            data: data.activity_types.map(d=>({value: d.count, name: d.type}))
        }]
    });
}

function updateTable(data) {
    state.total = data.total;
    const maxPage = Math.ceil(state.total / state.pageSize) || 1;
    els.pageInfo.textContent = `${state.page} / ${maxPage} (共 ${state.total} 条)`;
    els.prevPage.disabled = state.page <= 1;
    els.nextPage.disabled = state.page >= maxPage;
    
    const wdMap = ['','周一','周二','周三','周四','周五','周六','周日'];
    
    els.tableBody.innerHTML = data.items.map(r => `
        <tr>
            <td>${r.date}</td>
            <td>${wdMap[r.weekday]||r.weekday}</td>
            <td>${r.start_time}-${r.end_time}</td>
            <td>${r.academy}</td>
            <td>${r.location}</td>
            <td>${r.activity_name}</td>
            <td><span class="checkbox-tag">${r.activity_type}</span></td>
            <td>${r.audience_count}</td>
        </tr>
    `).join('');
}

// Week Generator
function renderWeeks() {
    const [y, m] = state.month.split('-').map(Number);
    const startMonth = new Date(y, m-1, 1);
    const endMonth = new Date(y, m, 0);
    
    let ranges = [];
    let curr = new Date(startMonth);
    
    while(curr <= endMonth) {
        let start = new Date(curr);
        let end = new Date(curr);
        end.setDate(end.getDate() + 6); // 7 days interval
        
        // Cap at end of month? User said "only allow selection of time periods within the current month"
        // But usually "7 days interval" implies fixed 7 days.
        // If the interval crosses month boundary, do we clip it?
        // "只允许选择当月内的时间段" -> Only select time periods within the month.
        // If I strictly follow "7 days", the last week might cross.
        // Let's clip it to end of month if it crosses.
        if (end > endMonth) end = new Date(endMonth);
        
        ranges.push({
            start: fmtDate(start),
            end: fmtDate(end)
        });
        
        // Next 7 days
        curr.setDate(curr.getDate() + 7);
    }
    
    els.weekList.innerHTML = ranges.map(r => {
        const active = (state.filters.start === r.start && state.filters.end === r.end) ? 'active' : '';
        return `
        <div class="week-item ${active}" onclick="selectWeek('${r.start}', '${r.end}')">
            <span>${r.start} - ${r.end}</span>
            <span style="opacity:0.3">→</span>
        </div>
        `;
    }).join('');
}

function fmtDate(d) {
    return d.toISOString().split('T')[0];
}

window.selectWeek = (s, e) => {
    state.filters.start = s;
    state.filters.end = e;
    renderWeeks(); // Re-render to update active state
};

// Event Listeners
els.statsMonth.addEventListener('change', () => {
    state.month = els.statsMonth.value;
    state.filters.start = '';
    state.filters.end = '';
    renderWeeks();
    els.applyFilters.click();
});

els.toggleSidebar.addEventListener('click', () => {
    els.sidebar.classList.toggle('collapsed');
    setTimeout(() => Object.values(state.charts).forEach(c => c.resize()), 300);
});

/* Wizard Logic Removed */

els.applyFilters.addEventListener('click', () => {
    // start/end already set by week selection
    // state.filters.start = els.startDate.value; 
    // state.filters.end = els.endDate.value;
    state.filters.academies = Array.from(document.querySelectorAll('#academyFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.weekdays = Array.from(document.querySelectorAll('#weekdayFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.locations = Array.from(document.querySelectorAll('#locationFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.types = Array.from(document.querySelectorAll('#typeFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.start_times = Array.from(document.querySelectorAll('#startTimeFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.page = 1;
    loadData();
});

els.resetFilters.addEventListener('click', () => {
    // Reset date?
    state.filters.start = '';
    state.filters.end = '';
    renderWeeks();
    
    // Reset others
    document.querySelectorAll('#academyFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#locationFilter .checkbox-tag').forEach(e => {
        e.classList.remove('checked');
        e.style.display = 'inline-flex';
    });
    document.querySelectorAll('#weekdayFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#typeFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#startTimeFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    els.applyFilters.click();
});

els.prevPage.addEventListener('click', () => { if(state.page > 1) { state.page--; loadData(); } });
els.nextPage.addEventListener('click', () => { state.page++; loadData(); });

// Init
async function init() {
    initLayout('书院空间使用数据看板');

    initCharts();
    els.statsMonth.value = state.month;
    renderWeeks();
    await loadOptions();
    await loadData();
}
init();

</script>
</body>
</html>
