<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦é™¢ç©ºé—´ä½¿ç”¨æ•°æ®çœ‹æ¿</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Dashboard layout overrides */
        :root {
            --sidebar-width: 260px;
            --header-height: 60px;
        }
        /* App Content Override for full layout */
        .app-content {
            padding: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }
        /* Ensure layout fills screen */
        .app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .dash-sidebar {
            width: var(--sidebar-width);
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 0; /* Changed from 16px */
            overflow: hidden; /* Changed from overflow-y: auto */
            transition: width 0.3s;
        }
        .dash-sidebar.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
            border: none;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--card);
            flex-shrink: 0;
        }
        .dash-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg);
            gap: 20px;
        }
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .kpi-card {
            background: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .kpi-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 8px 0;
        }
        .kpi-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .chart-card {
            background: var(--card);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .chart-container {
            flex: 1;
            width: 100%;
            height: 100%;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .filter-group {
            margin-bottom: 16px;
        }
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text);
        }
        .filter-input, .filter-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text);
        }
        .header-bar {
            height: var(--header-height);
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        /* Checkbox list */
        .checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .checkbox-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-tag.checked {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }
        .modal-backdrop {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5); z-index: 999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-backdrop.show { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--card); width: 500px; max-width: 90%;
            padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .week-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .week-item {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-item:hover {
            border-color: var(--primary);
        }
        .week-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }
/* Wizard Styles */
        .wizard-modal {
            max-width: 800px;
            width: 90%;
            display: flex;
            flex-direction: column;
            min-height: 500px;
            padding: 0;
            overflow: hidden;
        }

        .wizard-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: #f8f9fa;
        }

        .wizard-header h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
        }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }

        .step-item.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-item.active .step-icon {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: #e9ecef;
            margin: 0 16px;
            margin-bottom: 24px; /* Align with icon center approx */
        }

        .wizard-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            position: relative;
        }

        .step-pane {
            display: none;
            animation: fadeIn 0.3s ease;
            height: 100%;
        }

        .step-pane.active {
            display: block;
        }

        /* Step 1: Drag Drop */
        .drag-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fafbfc;
        }

        .drag-drop-zone:hover, .drag-drop-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .drag-drop-zone .icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-body);
            border-radius: var(--radius-sm);
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        /* Step 2: Preview */
        .data-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-item {
            background: var(--bg-body);
            padding: 16px;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-item label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .summary-item span {
            font-size: 18px;
            font-weight: 600;
        }

        .table-preview-wrap {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            overflow-x: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th, .preview-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Step 3: Progress */
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 24px;
        }

        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring svg {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 8;
        }

        .progress-ring circle:last-child {
            stroke: var(--primary);
            stroke-dasharray: 314; /* 2 * PI * r */
            stroke-dashoffset: calc(314 - (314 * var(--percent)) / 100);
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-ring span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-info {
            text-align: center;
        }

        .wizard-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .step-actions {
            display: flex;
            gap: 12px;
        }

        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>

<div class="header-bar">
    <div style="display:flex;align-items:center;gap:16px">
        <button class="btn" id="toggleSidebar">â˜°</button>
        <div style="display:flex;align-items:center;gap:8px;margin-left:16px">
            <label style="font-size:14px;color:var(--text-secondary)">ç»Ÿè®¡æœˆä»½</label>
            <input type="month" id="statsMonth" class="input" style="height:32px;padding:0 8px">
        </div>
    </div>
    <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" id="syncWalkinBtn">ğŸ”„ åŒæ­¥æ•£å®¢æ•°æ®</button>
        <button class="btn btn-primary" id="uploadBtn">ğŸ“¤ ä¸Šä¼ æ•°æ®</button>
    </div>
</div>

<div class="app-container">
    <div class="dash-sidebar" id="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border)">
            <h4 style="margin:0">ç­›é€‰</h4>
            <button class="btn btn-sm" id="resetFilters">é‡ç½®</button>
        </div>
        
        <div class="sidebar-content">
            <div class="filter-group">
                <label>å‘¨æ¬¡ / æ—¥æœŸèŒƒå›´</label>
                <div id="weekList" class="week-list"></div>
            </div>

            <div class="filter-group">
                <label>ä¹¦é™¢</label>
                <div id="academyFilter" class="checkbox-list"></div>
            </div>

            <div class="filter-group">
                <label>å‘¨å‡ </label>
                <div id="weekdayFilter" class="checkbox-list"></div>
            </div>

            <div class="filter-group">
                <label>åœºåœ°</label>
                <div id="locationFilter" class="checkbox-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <div class="filter-group">
                <label>æ´»åŠ¨ç±»å‹</label>
                <div id="typeFilter" class="checkbox-list"></div>
            </div>

            <div class="filter-group">
                <label>èµ·å§‹æ—¶é—´</label>
                <div id="startTimeFilter" class="checkbox-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button class="btn btn-primary" id="applyFilters" style="width:100%">åº”ç”¨ç­›é€‰</button>
        </div>
    </div>

    <div class="dash-main">
        <!-- KPI Cards -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">æ€»æ´»åŠ¨æ•°</div>
                <div class="kpi-val" id="kpi_events">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">æ€»å—ä¼—äººæ•°</div>
                <div class="kpi-val" id="kpi_audience">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">å¹³å‡å—ä¼—/æ´»åŠ¨</div>
                <div class="kpi-val" id="kpi_avg">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">çƒ­é—¨åœºåœ° (Top 1)</div>
                <div class="kpi-val" id="kpi_top_loc" style="font-size:18px">-</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-grid">
            <div class="chart-card">
                <h3>å‘¨æ´»åŠ¨åˆ†å¸ƒ</h3>
                <div id="chartWeekday" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <h3>æ—¶æ®µçƒ­åŠ›åˆ†å¸ƒ (Start Time)</h3>
                <div id="chartTime" class="chart-container"></div>
            </div>
            <div class="chart-card full-width">
                <h3>åœºåœ°æ’è¡Œ (Top 20)</h3>
                <div id="chartLocation" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <h3>æ´»åŠ¨ç±»å‹å æ¯”</h3>
                <div id="chartType" class="chart-container"></div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card full-width">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h3>æ´»åŠ¨æ˜ç»†</h3>
                <div style="display:flex;gap:8px">
                    <button class="btn" id="prevPage">ä¸Šä¸€é¡µ</button>
                    <span id="pageInfo" style="display:flex;align-items:center">1 / 1</span>
                    <button class="btn" id="nextPage">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
            <div class="table-wrap">
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th><th>æ˜ŸæœŸ</th><th>æ—¶é—´</th><th>ä¹¦é™¢</th><th>åœºåœ°</th><th>æ´»åŠ¨åç§°</th><th>ç±»å‹</th><th>äººæ•°</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Upload Wizard Modal -->
<div id="uploadModal" class="modal-backdrop">
    <div class="modal wizard-modal">
        <div class="wizard-header">
            <h3>å¯¼å…¥æ•°æ®</h3>
            <div class="wizard-steps">
                <div class="step-item active" data-step="1">
                    <div class="step-icon">1</div>
                    <span>å¯¼å…¥æ–‡ä»¶</span>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="2">
                    <div class="step-icon">2</div>
                    <span>ç¡®å®šæ•°æ®</span>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="3">
                    <div class="step-icon">3</div>
                    <span>å¯¼å…¥æ•°æ®</span>
                </div>
            </div>
        </div>

        <div class="wizard-content">
            <!-- Step 1: Upload -->
            <div class="step-pane active" id="step1">
                <div class="drag-drop-zone" id="dropZone">
                    <div class="icon">ğŸ“‚</div>
                    <p>æ‹–æ‹½æ–‡ä»¶è‡³æ­¤ æˆ– ç‚¹å‡»é€‰æ‹©</p>
                    <p class="sub-text" style="color:var(--text-secondary); font-size:12px; margin-top:4px">æ”¯æŒ .xlsx, .xls, .csv</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden>
                </div>
                <div id="fileInfo" class="file-info hidden">
                    <span class="file-icon" style="font-size:20px">ğŸ“„</span>
                    <div style="flex:1">
                        <div id="fileName" style="font-weight:500">example.xlsx</div>
                        <div id="fileSize" style="font-size:12px;color:var(--text-secondary)">12KB</div>
                    </div>
                    <div class="text-success">âœ“</div>
                </div>
            </div>

            <!-- Step 2: Preview -->
            <div class="step-pane" id="step2">
                <div class="data-summary">
                    <div class="summary-item">
                        <label>æ€»è®°å½•æ•°</label>
                        <span id="previewTotal">0</span>
                    </div>
                    <div class="summary-item">
                        <label>æ—¥æœŸèŒƒå›´</label>
                        <span id="previewDateRange">-</span>
                    </div>
                </div>
                <div class="table-preview-wrap">
                    <table class="preview-table">
                        <thead>
                            <tr id="previewHeader"></tr>
                        </thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
                <p style="font-size:12px;color:var(--text-secondary);margin-top:8px">ä»…æ˜¾ç¤ºå‰ 5 æ¡æ•°æ®ç”¨äºé¢„è§ˆ</p>
            </div>

            <!-- Step 3: Progress -->
            <div class="step-pane" id="step3">
                <div class="progress-container">
                    <div class="progress-ring" style="--percent:0">
                        <svg><circle r="50" cx="60" cy="60" pathLength="100" /></svg>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-info">
                        <h4 id="progressStatus" style="margin:0 0 8px 0">å‡†å¤‡å¯¼å…¥...</h4>
                        <p id="progressCount" style="margin:0;color:var(--text-secondary)">å·²å¯¼å…¥ 0 / 0</p>
                        <p id="progressTime" style="margin:4px 0 0 0;font-size:12px;color:var(--text-secondary)">é¢„è®¡å‰©ä½™æ—¶é—´: --</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-footer">
            <button class="btn" id="btnCancel">å–æ¶ˆ</button>
            <div class="step-actions">
                <button class="btn hidden" id="btnPrev">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btnNext" disabled>ä¸‹ä¸€æ­¥</button>
                <button class="btn btn-primary hidden" id="btnFinish">å®Œæˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="appAlertModal" class="modal-backdrop" style="z-index:9999">
    <div class="modal" style="width:400px">
        <h3 id="appAlertTitle">æç¤º</h3>
        <p id="appAlertMsg"></p>
        <div class="actions">
            <button class="btn btn-primary" id="appAlertOk">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- Walk-in Sync Modal -->
<div id="walkinModal" class="modal-backdrop">
    <div class="modal" style="width:600px">
        <h3>åŒæ­¥æ•£å®¢æ•°æ®</h3>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px">
            å°†ä»è®¾å¤‡åŸå§‹è®°å½•ä¸­ç”Ÿæˆâ€œæ•£å®¢è®¿é—®â€æ•°æ®ã€‚è§„åˆ™: æ¯30åˆ†é’Ÿèšåˆä¸€æ¬¡ï¼Œæ´»åŠ¨åç§°ä¸ºâ€œæ•£å®¢â€ï¼Œç±»å‹ä¸ºâ€œæ•£å®¢è®¿é—®â€ã€‚
        </p>
        
        <div class="form-group mb-4">
            <label>é€‰æ‹©è®¾å¤‡ (å¯å¤šé€‰)</label>
            <div id="walkinDeviceList" class="checkbox-list" style="max-height:150px;overflow-y:auto;border:1px solid var(--border);padding:8px;border-radius:4px"></div>
        </div>
        
        <div class="form-group mb-4">
            <label>é€‰æ‹©æ—¶é—´æ®µ</label>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button class="btn btn-sm active" id="tabDay" onclick="switchWalkinTab('day')">æŒ‰å¤©</button>
                <button class="btn btn-sm" id="tabWeek" onclick="switchWalkinTab('week')">æŒ‰å‘¨</button>
                <button class="btn btn-sm" id="tabRange" onclick="switchWalkinTab('range')">è‡ªå®šä¹‰æ®µ</button>
            </div>
            
            <div id="walkinTabDay">
                <input type="date" id="walkinDate" class="input w-full">
            </div>
            <div id="walkinTabWeek" style="display:none">
                <input type="week" id="walkinWeek" class="input w-full">
            </div>
            <div id="walkinTabRange" style="display:none">
                <div style="display:flex;gap:8px">
                    <input type="datetime-local" id="walkinStart" class="input w-full">
                    <input type="datetime-local" id="walkinEnd" class="input w-full">
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn" id="closeWalkin">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="previewWalkin">é¢„è§ˆæ•°æ®</button>
        </div>
    </div>
</div>

<!-- Walk-in Preview Modal -->
<div id="walkinPreviewModal" class="modal-backdrop" style="z-index:1100">
    <div class="modal" style="width:800px;max-width:90vw">
        <h3>ç¡®è®¤åŒæ­¥æ•°æ®</h3>
        <div style="max-height:400px;overflow-y:auto;margin:16px 0">
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th><th>æ—¶é—´</th><th>è®¾å¤‡</th><th>é¢„ä¼°äººæ•°</th>
                    </tr>
                </thead>
                <tbody id="walkinPreviewBody"></tbody>
            </table>
        </div>
        <div class="actions">
            <button class="btn" id="closeWalkinPreview">è¿”å›</button>
            <button class="btn btn-primary" id="confirmWalkin">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>
</div>

<script>
// Walk-in Sync Logic
const elsWalkin = {
    btn: document.getElementById('syncWalkinBtn'),
    modal: document.getElementById('walkinModal'),
    close: document.getElementById('closeWalkin'),
    deviceList: document.getElementById('walkinDeviceList'),
    previewBtn: document.getElementById('previewWalkin'),
    
    // Tabs
    tabDay: document.getElementById('tabDay'),
    tabWeek: document.getElementById('tabWeek'),
    tabRange: document.getElementById('tabRange'),
    areaDay: document.getElementById('walkinTabDay'),
    areaWeek: document.getElementById('walkinTabWeek'),
    areaRange: document.getElementById('walkinTabRange'),
    
    // Inputs
    date: document.getElementById('walkinDate'),
    week: document.getElementById('walkinWeek'),
    start: document.getElementById('walkinStart'),
    end: document.getElementById('walkinEnd'),
    
    // Preview
    previewModal: document.getElementById('walkinPreviewModal'),
    previewBody: document.getElementById('walkinPreviewBody'),
    previewClose: document.getElementById('closeWalkinPreview'),
    confirm: document.getElementById('confirmWalkin')
};

let walkinState = {
    mode: 'day',
    previewData: []
};

elsWalkin.btn.addEventListener('click', async () => {
    elsWalkin.modal.classList.add('show');
    if(elsWalkin.deviceList.children.length === 0) {
        // Load devices
        const res = await fetch('/api/v1/devices');
        const list = await res.json();
        const mapRes = await fetch('/api/v1/devices/mapping');
        const map = (await mapRes.json()).mapping || {};
        
        elsWalkin.deviceList.innerHTML = list.map(d => {
             const uuid = typeof d === 'string' ? d : d.uuid;
             const entry = map[uuid];
             const name = entry ? (entry.name || uuid) : uuid;
             const display = name === uuid ? uuid : `${name} (${uuid})`;
             return `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${uuid}">${display}</div>`;
        }).join('');
    }
    // Default date
    if(!elsWalkin.date.value) elsWalkin.date.value = new Date().toISOString().split('T')[0];
});

elsWalkin.close.addEventListener('click', () => elsWalkin.modal.classList.remove('show'));

window.switchWalkinTab = (mode) => {
    walkinState.mode = mode;
    ['day','week','range'].forEach(m => {
        const btn = document.getElementById('tab'+m.charAt(0).toUpperCase()+m.slice(1));
        const area = document.getElementById('walkinTab'+m.charAt(0).toUpperCase()+m.slice(1));
        if(m === mode) {
            btn.classList.add('active');
            area.style.display = 'block';
        } else {
            btn.classList.remove('active');
            area.style.display = 'none';
        }
    });
};

elsWalkin.previewBtn.addEventListener('click', async () => {
    // Collect Devices
    const devices = Array.from(elsWalkin.deviceList.querySelectorAll('.checked')).map(e => e.dataset.val);
    if(devices.length === 0) return showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¾å¤‡');
    
    // Collect Time
    let start, end;
    if(walkinState.mode === 'day') {
        if(!elsWalkin.date.value) return showAlert('è¯·é€‰æ‹©æ—¥æœŸ');
        start = elsWalkin.date.value + ' 00:00:00';
        end = elsWalkin.date.value + ' 23:59:59';
    } else if(walkinState.mode === 'week') {
        if(!elsWalkin.week.value) return showAlert('è¯·é€‰æ‹©å‘¨æ¬¡');
        // Calculate week start/end
        const [y, w] = elsWalkin.week.value.split('-W');
        const d = new Date(y, 0, 1 + (w - 1) * 7);
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
        const s = new Date(d.setDate(diff));
        const e = new Date(d.setDate(diff + 6));
        start = s.toISOString().split('T')[0] + ' 00:00:00';
        end = e.toISOString().split('T')[0] + ' 23:59:59';
    } else {
        if(!elsWalkin.start.value || !elsWalkin.end.value) return showAlert('è¯·é€‰æ‹©æ—¶é—´æ®µ');
        start = elsWalkin.start.value.replace('T', ' ');
        end = elsWalkin.end.value.replace('T', ' ');
    }
    
    elsWalkin.previewBtn.textContent = 'è®¡ç®—ä¸­...';
    try {
        const res = await fetch('/api/v1/activity/walkin/preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ devices, start, end })
        });
        if(!res.ok) throw new Error(await res.text());
        
        const data = await res.json();
        walkinState.previewData = data.items;
        
        // Show Preview
        elsWalkin.previewBody.innerHTML = data.items.map(r => `
            <tr>
                <td>${r.date}</td>
                <td>${r.start_time}-${r.end_time}</td>
                <td>${r.location}</td>
                <td>${r.audience_count}</td>
            </tr>
        `).join('');
        
        if(data.items.length === 0) {
            elsWalkin.previewBody.innerHTML = '<tr><td colspan="4" style="text-align:center">æ— æ•°æ®æˆ–è¯¥æ—¶æ®µæ— è®°å½•</td></tr>';
        }
        
        elsWalkin.previewModal.classList.add('show');
    } catch(e) {
        showAlert('Error: ' + e.message);
    } finally {
        elsWalkin.previewBtn.textContent = 'é¢„è§ˆæ•°æ®';
    }
});

elsWalkin.previewClose.addEventListener('click', () => elsWalkin.previewModal.classList.remove('show'));

elsWalkin.confirm.addEventListener('click', async () => {
    if(walkinState.previewData.length === 0) return;
    
    elsWalkin.confirm.disabled = true;
    elsWalkin.confirm.textContent = 'åŒæ­¥ä¸­...';
    
    try {
        const res = await fetch('/api/v1/activity/walkin/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ items: walkinState.previewData })
        });
        if(!res.ok) throw new Error(await res.text());
        
        const json = await res.json();
        await showAlert(`åŒæ­¥æˆåŠŸ: ${json.count} æ¡è®°å½•`);
        elsWalkin.previewModal.classList.remove('show');
        elsWalkin.modal.classList.remove('show');
        loadData(); // Refresh dashboard
    } catch(e) {
        showAlert('Error: ' + e.message);
    } finally {
        elsWalkin.confirm.disabled = false;
        elsWalkin.confirm.textContent = 'ç¡®è®¤æ·»åŠ ';
    }
});
</script>

<script src="/static/layout.js"></script>
<!-- å¼•å…¥ ECharts -->
<script src="/static/lib/echarts.min.js"></script>

<script>
// Popup Logic
const alertModal = document.getElementById('appAlertModal');
const alertTitle = document.getElementById('appAlertTitle');
const alertMsg = document.getElementById('appAlertMsg');
const alertOk = document.getElementById('appAlertOk');
let alertResolve = null;

window.showAlert = (msg, title='æç¤º') => {
    return new Promise(resolve => {
        alertTitle.textContent = title;
        alertMsg.textContent = msg;
        alertModal.classList.add('show');
        alertResolve = resolve;
    });
};

alertOk.addEventListener('click', () => {
    alertModal.classList.remove('show');
    if(alertResolve) alertResolve();
});

// State
let state = {
    page: 1,
    pageSize: 50,
    total: 0,
    month: new Date().toISOString().substring(0, 7),
    filters: {
        start: '', end: '', locations: [], types: [], academies: [], start_times: [], weekdays: []
    },
    charts: {}
};

// DOM Elements
const els = {
    sidebar: document.getElementById('sidebar'),
    toggleSidebar: document.getElementById('toggleSidebar'),
    uploadBtn: document.getElementById('uploadBtn'),
    uploadModal: document.getElementById('uploadModal'),
    closeUpload: document.getElementById('closeUpload'),
    doUpload: document.getElementById('doUpload'),
    fileInput: document.getElementById('fileInput'),
    adminToken: document.getElementById('adminToken'),
    
    // Filters
    statsMonth: document.getElementById('statsMonth'),
    weekList: document.getElementById('weekList'),
    academyFilter: document.getElementById('academyFilter'),
    weekdayFilter: document.getElementById('weekdayFilter'),
    locationFilter: document.getElementById('locationFilter'),
    typeFilter: document.getElementById('typeFilter'),
    startTimeFilter: document.getElementById('startTimeFilter'),
    applyFilters: document.getElementById('applyFilters'),
    resetFilters: document.getElementById('resetFilters'),
    
    // KPIs
    kpi_events: document.getElementById('kpi_events'),
    kpi_audience: document.getElementById('kpi_audience'),
    kpi_avg: document.getElementById('kpi_avg'),
    kpi_top_loc: document.getElementById('kpi_top_loc'),
    
    // Table
    tableBody: document.getElementById('dataTableBody'),
    prevPage: document.getElementById('prevPage'),
    nextPage: document.getElementById('nextPage'),
    pageInfo: document.getElementById('pageInfo')
};

// Init Charts
function initCharts() {
    if (typeof echarts === 'undefined') {
        console.error('ECharts is not loaded');
        return;
    }
    state.charts.weekday = echarts.init(document.getElementById('chartWeekday'));
    state.charts.time = echarts.init(document.getElementById('chartTime'));
    state.charts.location = echarts.init(document.getElementById('chartLocation'));
    state.charts.type = echarts.init(document.getElementById('chartType'));
    
    // Resize Handler (with cleanup to prevent leaks)
    if (window.onActivityDashboardResize) {
        window.removeEventListener('resize', window.onActivityDashboardResize);
    }
    window.onActivityDashboardResize = () => {
        Object.values(state.charts).forEach(c => c.resize());
    };
    window.addEventListener('resize', window.onActivityDashboardResize);
}

// Fetch Options
async function loadOptions() {
    // 1. Fetch options and academies in parallel
    const [res, acaRes] = await Promise.all([
        fetch('/api/v1/activity/options'),
        fetch('/api/v1/academies')
    ]);
    const data = await res.json();
    const acaList = await acaRes.json();
    
    // 2. Fetch Device Mapping for Locations
    let deviceMap = {};
    try {
        const mapRes = await fetch('/api/v1/devices/mapping');
        if(mapRes.ok) {
            const mapData = await mapRes.json();
            deviceMap = mapData.mapping || {};
        }
    } catch(e) { console.error("Load Mapping Error", e); }
    
    // Render Locations with Custom Names if available
    els.locationFilter.innerHTML = data.locations.map(l => {
        // Try to match location 'l' with device map
        // 'l' might be a UUID or a name. If it's a UUID, we show custom name.
        // If 'l' is a custom name already (from CSV), we just show it.
        const entry = deviceMap[l];
        const name = entry ? (entry.name || l) : l;
        const display = name === l ? l : `${name} (${l})`;
        return `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${l}">${display}</div>`;
    }).join('');

    // Render Academies (Use Registry + Existing Data)
    // Combine fetched academies and those from data options, dedup
    const academyNames = new Set(acaList.map(a => a.name));
    if(data.academies) data.academies.forEach(a => academyNames.add(a));
    
    els.academyFilter.innerHTML = Array.from(academyNames).sort().map(a => 
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${a}">${a}</div>`
    ).join('');
    
    // Render Weekdays (Fixed Mon-Sun)
    const weekMap = {1:'å‘¨ä¸€', 2:'å‘¨äºŒ', 3:'å‘¨ä¸‰', 4:'å‘¨å››', 5:'å‘¨äº”', 6:'å‘¨å…­', 7:'å‘¨æ—¥'};
    const weekdays = [1,2,3,4,5,6,7];
    els.weekdayFilter.innerHTML = weekdays.map(w =>
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${w}">${weekMap[w]}</div>`
    ).join('');

    // Render Types (Fixed + Existing)
    const fixedTypes = [
        "ç­å›¢æ´»åŠ¨", "å…¬ç›Š/å¿—æ„¿æ´»åŠ¨", "ä¼šè®®æ´»åŠ¨", "åŸ¹è®­æ´»åŠ¨", "å…¶ä»–æ´»åŠ¨", 
        "å…¨ç”Ÿå¼‚ç§‘å¯¼å¸ˆæ´»åŠ¨", "æ•£å®¢è®¿é—®", "ç¤¾å›¢æ´»åŠ¨", "ä¹¦é™¢æ´»åŠ¨", 
        "ä½“è‚²æ´»åŠ¨", "é¡¹ç›®å·¥åŠæ´»åŠ¨", "è‰ºæœ¯æ´»åŠ¨", "é¡¹ç›®å·¥åŠ"
    ];
    const typeSet = new Set(fixedTypes);
    if(data.types) data.types.forEach(t => typeSet.add(t));
    
    els.typeFilter.innerHTML = Array.from(typeSet).sort().map(t => 
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${t}">${t}</div>`
    ).join('');
    
    // Render Start Times
    const fixedTimes = [
        "05:30", "06:00", "06:30", "07:00", "07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30",
        "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00",
        "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30",
        "22:00"
    ];

    els.startTimeFilter.innerHTML = fixedTimes.map(t => 
        `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${t}">${t}</div>`
    ).join('');
}

// Build Query
function buildQuery(forAgg = false) {
    const p = new URLSearchParams();
    if(state.filters.start) p.append('start_date', state.filters.start);
    if(state.filters.end) p.append('end_date', state.filters.end);
    if(state.filters.locations.length) p.append('locations', state.filters.locations.join(','));
    if(state.filters.academies.length) p.append('academies', state.filters.academies.join(','));
    if(state.filters.weekdays.length) p.append('weekdays', state.filters.weekdays.join(','));
    if(state.filters.types.length) p.append('types', state.filters.types.join(','));
    if(state.filters.start_times.length) p.append('start_times', state.filters.start_times.join(','));
    
    if(!forAgg) {
        p.append('page', state.page);
        p.append('page_size', state.pageSize);
    }
    return p;
}

// Load Data
async function loadData() {
    // Load Aggregations
    const qAgg = buildQuery(true);
    const resAgg = await fetch(`/api/v1/activity/aggregations?${qAgg}`);
    const agg = await resAgg.json();
    updateDashboard(agg);
    
    // Load Table
    const qTab = buildQuery(false);
    const resTab = await fetch(`/api/v1/activity/events?${qTab}`);
    const tab = await resTab.json();
    updateTable(tab);
}

// Update UI
function updateDashboard(data) {
    // KPIs
    if(els.kpi_events) els.kpi_events.textContent = (data.kpis.total_events || 0).toLocaleString();
    if(els.kpi_audience) els.kpi_audience.textContent = (data.kpis.total_audience || 0).toLocaleString();
    if(els.kpi_avg) els.kpi_avg.textContent = data.kpis.avg_audience || 0;
    const top = data.location_top && data.location_top[0];
    if(els.kpi_top_loc) els.kpi_top_loc.textContent = top ? `${top.location} (${top.count})` : '-';
    
    // Check if charts are initialized
    if (!state.charts.weekday) {
        initCharts();
        if (!state.charts.weekday) return; // Still failed
    }

    // Weekday Chart
    const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const wdData = Array(7).fill(0);
    data.weekday.forEach(d => { if(d.weekday>=1 && d.weekday<=7) wdData[d.weekday-1] = d.count; });
    
    state.charts.weekday.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'] },
        yAxis: { type: 'value' },
        series: [{ type: 'bar', data: wdData, itemStyle: { color: '#339af0' } }]
    });
    
    // Time Chart (Bar for now, Heatmap needs more prep)
    const hours = Array.from({length:24}, (_,i)=>String(i).padStart(2,'0'));
    const hData = Array(24).fill(0);
    data.time_bins.forEach(d => {
        const h = parseInt(d.hour);
        if(!isNaN(h) && h>=0 && h<24) hData[h] = d.count;
    });
    
    state.charts.time.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: hours.map(h=>h+':00') },
        yAxis: { type: 'value' },
        series: [{ type: 'line', smooth: true, areaStyle: {}, data: hData, itemStyle: { color: '#51cf66' } }]
    });
    
    // Location Chart (Top 20)
    // Sort asc for bar chart y-axis
    const locs = [...data.location_top].reverse();
    state.charts.location.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'value' },
        yAxis: { type: 'category', data: locs.map(d=>d.location) },
        series: [
            { name: 'æ´»åŠ¨æ•°', type: 'bar', data: locs.map(d=>d.count), itemStyle: { color: '#fcc419' } },
            //{ name: 'å—ä¼—', type: 'bar', data: locs.map(d=>d.audience) }
        ]
    });
    
    // Type Chart
    state.charts.type.setOption({
        tooltip: { trigger: 'item' },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            data: data.activity_types.map(d=>({value: d.count, name: d.type}))
        }]
    });
}

function updateTable(data) {
    state.total = data.total;
    const maxPage = Math.ceil(state.total / state.pageSize) || 1;
    els.pageInfo.textContent = `${state.page} / ${maxPage} (å…± ${state.total} æ¡)`;
    els.prevPage.disabled = state.page <= 1;
    els.nextPage.disabled = state.page >= maxPage;
    
    const wdMap = ['','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
    
    els.tableBody.innerHTML = data.items.map(r => `
        <tr>
            <td>${r.date}</td>
            <td>${wdMap[r.weekday]||r.weekday}</td>
            <td>${r.start_time}-${r.end_time}</td>
            <td>${r.academy}</td>
            <td>${r.location}</td>
            <td>${r.activity_name}</td>
            <td><span class="checkbox-tag">${r.activity_type}</span></td>
            <td>${r.audience_count}</td>
        </tr>
    `).join('');
}

// Week Generator
function renderWeeks() {
    const [y, m] = state.month.split('-').map(Number);
    const startMonth = new Date(y, m-1, 1);
    const endMonth = new Date(y, m, 0);
    
    let ranges = [];
    let curr = new Date(startMonth);
    
    while(curr <= endMonth) {
        let start = new Date(curr);
        let end = new Date(curr);
        end.setDate(end.getDate() + 6); // 7 days interval
        
        // Cap at end of month? User said "only allow selection of time periods within the current month"
        // But usually "7 days interval" implies fixed 7 days.
        // If the interval crosses month boundary, do we clip it?
        // "åªå…è®¸é€‰æ‹©å½“æœˆå†…çš„æ—¶é—´æ®µ" -> Only select time periods within the month.
        // If I strictly follow "7 days", the last week might cross.
        // Let's clip it to end of month if it crosses.
        if (end > endMonth) end = new Date(endMonth);
        
        ranges.push({
            start: fmtDate(start),
            end: fmtDate(end)
        });
        
        // Next 7 days
        curr.setDate(curr.getDate() + 7);
    }
    
    els.weekList.innerHTML = ranges.map(r => {
        const active = (state.filters.start === r.start && state.filters.end === r.end) ? 'active' : '';
        return `
        <div class="week-item ${active}" onclick="selectWeek('${r.start}', '${r.end}')">
            <span>${r.start} - ${r.end}</span>
            <span style="opacity:0.3">â†’</span>
        </div>
        `;
    }).join('');
}

function fmtDate(d) {
    return d.toISOString().split('T')[0];
}

window.selectWeek = (s, e) => {
    state.filters.start = s;
    state.filters.end = e;
    renderWeeks(); // Re-render to update active state
};

// Event Listeners
els.statsMonth.addEventListener('change', () => {
    state.month = els.statsMonth.value;
    state.filters.start = '';
    state.filters.end = '';
    renderWeeks();
    els.applyFilters.click();
});

els.toggleSidebar.addEventListener('click', () => {
    els.sidebar.classList.toggle('collapsed');
    setTimeout(() => Object.values(state.charts).forEach(c => c.resize()), 300);
});

// --- Wizard Logic ---
const wizard = {
    step: 1,
    file: null,
    data: [],
    CHUNK_SIZE: 500,
    
    // Elements
    el: {
        modal: document.getElementById('uploadModal'),
        steps: document.querySelectorAll('.step-item'),
        panes: document.querySelectorAll('.step-pane'),
        dropZone: document.getElementById('dropZone'),
        fileInput: document.getElementById('fileInput'),
        fileInfo: document.getElementById('fileInfo'),
        btnCancel: document.getElementById('btnCancel'),
        btnPrev: document.getElementById('btnPrev'),
        btnNext: document.getElementById('btnNext'),
        btnFinish: document.getElementById('btnFinish'),
        // Preview
        previewTotal: document.getElementById('previewTotal'),
        previewDateRange: document.getElementById('previewDateRange'),
        previewHeader: document.getElementById('previewHeader'),
        previewBody: document.getElementById('previewBody'),
        // Progress
        progressRing: document.querySelector('.progress-ring'),
        progressPercent: document.getElementById('progressPercent'),
        progressStatus: document.getElementById('progressStatus'),
        progressCount: document.getElementById('progressCount'),
        progressTime: document.getElementById('progressTime')
    },

    init() {
        if(!window.XLSX) {
            console.error('SheetJS not loaded');
        }

        // Open/Close
        els.uploadBtn.addEventListener('click', () => this.open());
        this.el.btnCancel.addEventListener('click', () => this.close());
        
        // Navigation
        this.el.btnNext.addEventListener('click', () => this.next());
        this.el.btnPrev.addEventListener('click', () => this.prev());
        this.el.btnFinish.addEventListener('click', () => this.close());

        // File Input
        this.el.dropZone.addEventListener('click', () => this.el.fileInput.click());
        this.el.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
        
        // Drag & Drop
        this.el.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            this.el.dropZone.classList.add('dragover');
        });
        this.el.dropZone.addEventListener('dragleave', () => {
            this.el.dropZone.classList.remove('dragover');
        });
        this.el.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            this.el.dropZone.classList.remove('dragover');
            if(e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]);
        });
    },

    open() {
        this.reset();
        this.el.modal.classList.add('show');
    },

    close() {
        this.el.modal.classList.remove('show');
        if(this.step === 3 && this.data.length > 0) {
            loadData();
            loadOptions();
        }
    },

    reset() {
        this.step = 1;
        this.file = null;
        this.data = [];
        this.el.fileInput.value = '';
        this.el.fileInfo.classList.add('hidden');
        this.el.dropZone.classList.remove('hidden');
        this.el.btnNext.disabled = true;
        this.renderStep();
    },

    renderStep() {
        // Update Steps UI
        this.el.steps.forEach(s => {
            const sNum = parseInt(s.dataset.step);
            s.classList.toggle('active', sNum <= this.step);
        });

        // Show Pane
        this.el.panes.forEach(p => p.classList.remove('active'));
        document.getElementById(`step${this.step}`).classList.add('active');

        // Buttons
        this.el.btnPrev.classList.toggle('hidden', this.step === 1 || this.step === 3);
        this.el.btnNext.classList.toggle('hidden', this.step === 3);
        this.el.btnFinish.classList.toggle('hidden', this.step !== 3); 
        this.el.btnCancel.classList.toggle('hidden', this.step === 3);

        if (this.step === 1) {
             this.el.btnNext.disabled = !this.file;
        } else if (this.step === 2) {
             this.el.btnNext.disabled = false;
        } else if (this.step === 3) {
             this.startImport();
        }
    },

    handleFile(file) {
        if(!file) return;
        const ext = file.name.split('.').pop().toLowerCase();
        if(!['xlsx', 'xls', 'csv'].includes(ext)) {
            showAlert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
            return;
        }

        this.file = file;
        this.el.dropZone.classList.add('hidden');
        this.el.fileInfo.classList.remove('hidden');
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
        this.el.btnNext.disabled = false;
    },

    async next() {
        if(this.step === 1) {
            try {
                this.el.btnNext.disabled = true;
                this.el.btnNext.textContent = "è§£æä¸­...";
                await this.parseFile();
                this.el.btnNext.textContent = "ä¸‹ä¸€æ­¥";
            } catch(e) {
                this.el.btnNext.disabled = false;
                this.el.btnNext.textContent = "ä¸‹ä¸€æ­¥";
                return;
            }
        }
        this.step++;
        this.renderStep();
    },

    prev() {
        this.step--;
        this.renderStep();
    },

    async parseFile() {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, {type: 'binary'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""});
                    this.processData(jsonData);
                    resolve();
                } catch(err) {
                    showAlert('è§£æå¤±è´¥: ' + err.message);
                    reject(err);
                }
            };
            reader.readAsBinaryString(this.file);
        });
    },

    processData(rows) {
        this.data = rows.map(row => {
            const getVal = (keys) => {
                for(let k of keys) if(row[k] !== undefined) return row[k];
                return '';
            };

            const dateStr = String(getVal(['å¹´/æœˆ/æ—¥', 'Date', 'æ—¥æœŸ'])).split(' ')[0];
            const startTime = String(getVal(['èµ·å§‹æ—¶é—´', 'Start']) || '');
            const endTime = String(getVal(['ç»“æŸæ—¶é—´', 'End']) || '');
            
            // Duration
            let duration = 0;
            const durRaw = String(getVal(['æ—¶é•¿', 'Duration']) || '');
            if(durRaw.includes('æ—¶')) {
                 const parts = durRaw.split('æ—¶');
                 const h = parseInt(parts[0]) || 0;
                 const m = parseInt(parts[1]?.replace('åˆ†','')) || 0;
                 duration = h*60 + m;
            } else if(durRaw.includes('åˆ†')) {
                 duration = parseInt(durRaw.replace('åˆ†','')) || 0;
            } else if(durRaw.match(/^\d+$/)) {
                 duration = parseInt(durRaw);
            } else {
                // Try calc from start/end
                if(startTime && endTime && dateStr) {
                    try {
                        const t1 = new Date(`2000/01/01 ${startTime}`);
                        const t2 = new Date(`2000/01/01 ${endTime}`);
                        duration = (t2 - t1) / 1000 / 60;
                    } catch(e){}
                }
            }

            return {
                date: dateStr,
                weekday: String(getVal(['å‘¨å‡ ', 'Weekday']) || ''),
                start_time: startTime,
                end_time: endTime,
                duration_minutes: duration || 0,
                academy: String(getVal(['ä¹¦é™¢', 'Academy']) || ''),
                location: String(getVal(['å…·ä½“åœ°ç‚¹', 'Location']) || ''),
                activity_name: String(getVal(['æ´»åŠ¨åç§°', 'Activity Name']) || ''),
                activity_type: String(getVal(['æ´»åŠ¨ç±»å‹', 'Activity Type']) || ''),
                audience_count: parseInt(getVal(['å—ä¼—å­¦ç”Ÿæ•°', 'Audience']) || 0),
                notes: String(getVal(['å¤‡æ³¨', 'Remarks']) || '')
            };
        }).filter(d => d.date && d.date !== 'undefined');

        // Render Preview
        this.el.previewTotal.textContent = this.data.length;
        if(this.data.length > 0) {
            const dates = this.data.map(d => d.date).sort();
            this.el.previewDateRange.textContent = `${dates[0]} - ${dates[dates.length-1]}`;
        }
        
        // Render Table Headers
        const headers = ['æ—¥æœŸ', 'ä¹¦é™¢', 'åœ°ç‚¹', 'æ´»åŠ¨', 'äººæ•°'];
        this.el.previewHeader.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
        
        // Render Body
        this.el.previewBody.innerHTML = this.data.slice(0, 5).map(d => `
            <tr>
                <td>${d.date}</td>
                <td>${d.academy}</td>
                <td>${d.location}</td>
                <td>${d.activity_name}</td>
                <td>${d.audience_count}</td>
            </tr>
        `).join('');
    },

    async startImport() {
        const total = this.data.length;
        let imported = 0;
        const startTime = Date.now();

        this.el.progressStatus.textContent = "æ­£åœ¨å¯¼å…¥...";
        this.el.progressStatus.style.color = "var(--text-main)";

        for(let i=0; i<total; i+=this.CHUNK_SIZE) {
            const chunk = this.data.slice(i, i+this.CHUNK_SIZE);
            try {
                const res = await fetch('/api/v1/activity/walkin/sync', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({items: chunk})
                });
                
                if(!res.ok) throw new Error(await res.text());
                
                imported += chunk.length;
                
                // Update Progress
                const percent = Math.min(100, Math.round((imported / total) * 100));
                this.el.progressRing.style.setProperty('--percent', percent);
                this.el.progressPercent.textContent = percent + '%';
                this.el.progressCount.textContent = `å·²å¯¼å…¥ ${imported} / ${total}`;
                
                // Est Time
                const elapsed = Date.now() - startTime;
                if(imported > 0) {
                    const speed = imported / elapsed; 
                    const remaining = total - imported;
                    const etaMs = remaining / speed;
                    this.el.progressTime.textContent = `é¢„è®¡å‰©ä½™æ—¶é—´: ${(etaMs/1000).toFixed(1)}s`;
                }
                
                await new Promise(r => setTimeout(r, 100)); // Visual delay
            } catch(err) {
                this.el.progressStatus.textContent = "å¯¼å…¥å‡ºé”™: " + err.message;
                this.el.progressStatus.style.color = "var(--danger)";
                this.el.btnCancel.classList.remove('hidden');
                this.el.btnCancel.textContent = "å…³é—­";
                return;
            }
        }

        this.el.progressStatus.textContent = "å¯¼å…¥å®Œæˆ!";
        this.el.progressStatus.style.color = "var(--success)";
        this.el.btnFinish.classList.remove('hidden');
        this.el.btnCancel.classList.add('hidden');
        
        loadData();
        loadOptions();
    }
};

wizard.init();

els.applyFilters.addEventListener('click', () => {
    // start/end already set by week selection
    // state.filters.start = els.startDate.value; 
    // state.filters.end = els.endDate.value;
    state.filters.academies = Array.from(document.querySelectorAll('#academyFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.weekdays = Array.from(document.querySelectorAll('#weekdayFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.locations = Array.from(document.querySelectorAll('#locationFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.types = Array.from(document.querySelectorAll('#typeFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.filters.start_times = Array.from(document.querySelectorAll('#startTimeFilter .checkbox-tag.checked')).map(el => el.dataset.val);
    state.page = 1;
    loadData();
});

els.resetFilters.addEventListener('click', () => {
    // Reset date?
    state.filters.start = '';
    state.filters.end = '';
    renderWeeks();
    
    // Reset others
    document.querySelectorAll('#academyFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#locationFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#weekdayFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#typeFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    document.querySelectorAll('#startTimeFilter .checkbox-tag').forEach(e => e.classList.remove('checked'));
    els.applyFilters.click();
});

els.prevPage.addEventListener('click', () => { if(state.page > 1) { state.page--; loadData(); } });
els.nextPage.addEventListener('click', () => { state.page++; loadData(); });

// Init
async function init() {
    initLayout('ä¹¦é™¢ç©ºé—´ä½¿ç”¨æ•°æ®çœ‹æ¿');
    
    // Move Stats Month to App Header
    const headerRight = document.querySelector('.app-header .flex.items-center.gap-4');
    if (headerRight && els.statsMonth) {
        // Create container for month selector
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.marginRight = '16px';
        container.innerHTML = `<span style="font-size:12px;margin-right:8px;color:var(--text-secondary)">ç»Ÿè®¡æœˆä»½</span>`;
        
        // We clone the input to avoid event listener issues if we just move it?
        // No, moving preserves listeners usually.
        container.appendChild(els.statsMonth);
        
        // Insert before the time display (first child of headerRight)
        headerRight.insertBefore(container, headerRight.firstChild);
        
        // Hide the original label in .header-bar
        const oldLabel = document.querySelector('.header-bar label');
        if(oldLabel) oldLabel.style.display = 'none';
    } else {
        // Fallback: If header not found, maybe initLayout failed?
        console.warn('App Header not found, ensuring layout...');
        initLayout('ä¹¦é™¢ç©ºé—´ä½¿ç”¨æ•°æ®çœ‹æ¿');
        // Try again
        const retryHeader = document.querySelector('.app-header .flex.items-center.gap-4');
        if(retryHeader && els.statsMonth) {
             const container = document.createElement('div');
             container.style.display = 'flex';
             container.style.alignItems = 'center';
             container.style.marginRight = '16px';
             container.innerHTML = `<span style="font-size:12px;margin-right:8px;color:var(--text-secondary)">ç»Ÿè®¡æœˆä»½</span>`;
             container.appendChild(els.statsMonth);
             retryHeader.insertBefore(container, retryHeader.firstChild);
             const oldLabel = document.querySelector('.header-bar label');
             if(oldLabel) oldLabel.style.display = 'none';
        }
    }

    initCharts();
    els.statsMonth.value = state.month;
    renderWeeks();
    await loadOptions();
    await loadData();
}
init();

</script>
</body>
</html>
