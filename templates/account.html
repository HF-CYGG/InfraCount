<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账户管理 - InfraCount</title>
    <link rel="stylesheet" href="/static/style.css?v=ui_v1">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .user-table th, .user-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .user-table tr:hover {
            background-color: #f8f9fa;
        }
        .action-btn {
            padding: 4px 8px;
            margin-right: 5px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }
        .edit-btn { background-color: #e9ecef; color: #495057; }
        .delete-btn { background-color: #ffe3e3; color: #e03131; }
        
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        .form-select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
    </style>
</head>
<body>

<div class="page-header">
    <h2>账户管理</h2>
    <button class="btn btn-primary" id="addUserBtn">
        <i class="fas fa-plus"></i> 添加账户
    </button>
</div>

<table class="user-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>用户名</th>
            <th>角色</th>
            <th>创建时间</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody id="userList">
        <!-- Users will be loaded here -->
    </tbody>
</table>

<!-- User Modal -->
<div id="userModal" class="modal-backdrop">
    <div class="modal" style="width: 400px;">
        <h3 id="modalTitle">添加账户</h3>
        <form id="userForm">
            <input type="hidden" name="userId" id="userId">
            <div class="form-group">
                <label class="form-label">用户名</label>
                <input type="text" name="username" id="formUsername" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" name="password" id="formPassword" class="form-control" placeholder="不修改请留空">
                <small style="color:#888" id="pwdHelp">新建账户时必填</small>
            </div>
            <div class="form-group">
                <label class="form-label">角色</label>
                <select name="role" id="formRole" class="form-select">
                    <option value="user">普通用户</option>
                    <option value="admin">管理员</option>
                </select>
            </div>
            <div class="actions">
                <button type="button" class="btn" id="closeModalBtn">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="/static/layout.js?v=auth_v4"></script>
<script>
    initLayout('账户管理');

    const userList = document.getElementById('userList');
    const userModal = document.getElementById('userModal');
    const userForm = document.getElementById('userForm');
    const modalTitle = document.getElementById('modalTitle');
    
    // Load Users
    async function loadUsers() {
        try {
            const res = await fetch('/api/v1/users');
            if (res.ok) {
                const data = await res.json();
                renderUsers(data.users);
            } else {
                if(res.status === 403) {
                    userList.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red">无权访问 (403)</td></tr>';
                } else {
                    const txt = await res.text();
                    console.error('API Error:', res.status, txt);
                    userList.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red">加载失败: ${res.status}</td></tr>`;
                }
            }
        } catch (e) {
            console.error(e);
            userList.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red">网络或系统错误</td></tr>';
        }
    }

    function renderUsers(users) {
        userList.innerHTML = users.map(u => `
            <tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>
                    <span style="padding:2px 6px; border-radius:4px; font-size:12px; background:${u.role==='admin'?'#e7f5ff':'#f8f9fa'}; color:${u.role==='admin'?'#1971c2':'#495057'}">
                        ${u.role}
                    </span>
                </td>
                <td>${new Date(u.created_at).toLocaleString()}</td>
                <td>
                    <button class="action-btn edit-btn" onclick="editUser(${u.id}, '${u.username}', '${u.role}')">编辑</button>
                    <button class="action-btn delete-btn" onclick="deleteUser(${u.id}, '${u.username}')">删除</button>
                </td>
            </tr>
        `).join('');
    }

    // Add User
    document.getElementById('addUserBtn').addEventListener('click', () => {
        userForm.reset();
        document.getElementById('userId').value = '';
        modalTitle.textContent = '添加账户';
        document.getElementById('formPassword').required = true;
        document.getElementById('pwdHelp').textContent = '新建账户时必填';
        userModal.classList.add('show');
    });

    // Edit User
    window.editUser = (id, username, role) => {
        userForm.reset();
        document.getElementById('userId').value = id;
        document.getElementById('formUsername').value = username;
        document.getElementById('formRole').value = role;
        
        modalTitle.textContent = '编辑账户';
        document.getElementById('formPassword').required = false;
        document.getElementById('pwdHelp').textContent = '留空则不修改密码';
        
        userModal.classList.add('show');
    };

    // Close Modal
    document.getElementById('closeModalBtn').addEventListener('click', () => {
        userModal.classList.remove('show');
    });

    // Submit Form
    userForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const username = document.getElementById('formUsername').value;
        const password = document.getElementById('formPassword').value;
        const role = document.getElementById('formRole').value;

        const data = { username, role };
        if (password) data.password = password;

        try {
            let res;
            if (id) {
                // Update
                res = await fetch(`/api/v1/users/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                // Create
                if(!password) {
                    window.showAlert('请输入密码');
                    return;
                }
                res = await fetch('/api/v1/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }

            if (res.ok) {
                userModal.classList.remove('show');
                loadUsers();
                window.showAlert(id ? '更新成功' : '创建成功');
            } else {
                const err = await res.json();
                window.showAlert(err.detail || '操作失败');
            }
        } catch (e) {
            console.error(e);
            window.showAlert('发生错误');
        }
    });

    // Delete User
    window.deleteUser = async (id, username) => {
        const confirmed = await window.showConfirm(`确定要删除账户 "${username}" 吗？`);
        if (!confirmed) return;

        try {
            const res = await fetch(`/api/v1/users/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                loadUsers();
                window.showAlert('删除成功');
            } else {
                const err = await res.json();
                window.showAlert(err.detail || '删除失败');
            }
        } catch (e) {
            console.error(e);
            window.showAlert('发生错误');
        }
    };

    // Initial Load
    loadUsers();

</script>
</body>
</html>
