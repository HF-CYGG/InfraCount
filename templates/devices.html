<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - InfraCount</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/lib/Sortable.min.js"></script>
    <style>
        .sortable-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .sortable-item:last-child { margin-bottom: 0; }
        .sortable-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        .sortable-item.sortable-ghost {
            opacity: 0.4;
            background: #f1f3f5;
        }
        .sortable-handle {
            color: #adb5bd;
            margin-right: 12px;
            cursor: grab;
            font-size: 18px;
        }
        .academy-name {
            font-weight: 500;
            color: var(--text);
            flex: 1;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h3>è®¾å¤‡åˆ—è¡¨</h3>
        <div class="flex gap-2">
            <button class="btn" id="refreshBtn">åˆ·æ–°</button>
            <button class="btn btn-primary" id="addAcademyBtn">ç®¡ç†ä¹¦é™¢åˆ†ç±»</button>
        </div>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>ä¹¦é™¢/åˆ†ç±»</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th style="width:120px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="deviceTable"></tbody>
        </table>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <div class="flex justify-between items-center mb-4">
        <h3>æ ‡å‡†åœºåœ°é…ç½® (ç”¨äºAIè¯†åˆ«ä¸å½’å±)</h3>
        <button class="btn" id="refreshLocBtn">åˆ·æ–°</button>
    </div>
    
    <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px; display:flex; gap:12px; align-items:end;">
        <div style="flex:1">
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">æ ‡å‡†åœºåœ°åç§°</label>
            <input id="newLocName" class="input" placeholder="ä¾‹å¦‚ï¼šHelloä¼šå®¢å…(Y1-103)" style="width:100%">
        </div>
        <div style="width:200px">
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">å½’å±ä¹¦é™¢</label>
            <select id="newLocAca" class="select" style="width:100%"></select>
        </div>
        <button class="btn btn-primary" id="addLocBtn">æ·»åŠ </button>
    </div>
    
    <!-- Filter Bar -->
    <div style="margin-bottom:12px; display:flex; gap:12px; align-items:center;">
        <input id="searchLoc" class="input" placeholder="æœç´¢åœºåœ°..." style="width:200px">
        <select id="filterLocAca" class="select" style="width:150px">
            <option value="">æ‰€æœ‰ä¹¦é™¢</option>
        </select>
    </div>

    <div class="table-wrap" style="max-height: 500px; overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <th>æ ‡å‡†åœºåœ°åç§°</th>
                    <th>å½’å±ä¹¦é™¢</th>
                    <th style="width:100px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="locationTable"></tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-backdrop">
    <div class="modal">
        <h3>ç¼–è¾‘è®¾å¤‡ä¿¡æ¯</h3>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">UUID</label>
            <input id="editUuid" class="input" disabled style="background:#f1f3f5">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ˜¾ç¤ºåç§°</label>
            <input id="editName" class="input" placeholder="ä¾‹å¦‚ï¼šæ­£å¿ƒæ¥¼101">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ‰€å±ä¹¦é™¢</label>
            <select id="editCategory" class="select"></select>
        </div>
        <div class="actions">
            <button class="btn" id="closeEdit">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="saveEdit">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Academy Manager Modal -->
<div id="academyModal" class="modal-backdrop">
    <div class="modal" style="width: 480px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0">ä¹¦é™¢åˆ†ç±»ç®¡ç†</h3>
            <button class="btn btn-sm" id="closeAcademy" style="border:none;font-size:20px;color:#999;background:transparent">âœ•</button>
        </div>
        
        <div class="flex gap-2 mb-4">
            <input id="newAcademy" class="input" placeholder="æ–°ä¹¦é™¢åç§°" style="flex:1">
            <button class="btn btn-primary" id="addAcademy">æ·»åŠ </button>
        </div>
        
        <div style="background:#f8f9fa; border:1px solid var(--border); border-radius:8px; padding:12px; max-height:400px; overflow-y:auto;">
            <div id="academyList" class="sortable-list">
                <!-- Items injected here -->
            </div>
        </div>
        
        <div style="margin-top:12px; text-align:center; font-size:12px; color:#adb5bd;">
            ğŸ’¡ æ‹–åŠ¨åˆ—è¡¨é¡¹å³å¯è°ƒæ•´é¡ºåº
        </div>
    </div>
</div>

<!-- Location Edit Modal -->
<div id="locEditModal" class="modal-backdrop">
    <div class="modal">
        <h3>ç¼–è¾‘æ ‡å‡†åœºåœ°</h3>
        <input type="hidden" id="locEditOldName">
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ ‡å‡†åœºåœ°åç§°</label>
            <input id="locEditName" class="input" style="width:100%">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">å½’å±ä¹¦é™¢</label>
            <select id="locEditAca" class="select" style="width:100%"></select>
        </div>
        <div class="actions">
            <button class="btn" id="locEditCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="locEditSave">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Location Correction Modal -->
<div id="locCorrectionModal" class="modal-backdrop">
    <div class="modal" style="max-width: 600px;">
        <h3>åœºåœ°æ•°æ®æ ¡æ­£</h3>
        <p style="margin-bottom:8px">å°†å¯¹åœºåœ° <strong id="correctLocName"></strong> çš„å†å²æ•°æ®è¿›è¡Œæ ¡æ­£ã€‚</p>
        <p style="margin-bottom:16px">ç›®æ ‡å½’å±ä¹¦é™¢: <strong id="correctLocAca" style="color:var(--primary)"></strong></p>
        
        <div id="similarLocsSection" style="display:none">
            <hr style="border:0; border-top:1px solid #eee; margin:12px 0;">
            <h5 style="font-size:14px; font-weight:bold; margin-bottom:8px;">å‘ç°ç›¸ä¼¼çš„æœªå½’å±åœºåœ°</h5>
            <p style="color:#666; font-size:12px; margin-bottom:8px;">å‹¾é€‰ä¸‹åˆ—åœºåœ°ï¼Œå°†å…¶å†å²æ•°æ®åˆå¹¶åˆ°å½“å‰æ ‡å‡†åœºåœ°ï¼ˆé‡å‘½åå¹¶ç»Ÿä¸€å½’å±ï¼‰ã€‚</p>
            <div id="similarLocsList" style="max-height: 200px; overflow-y: auto; border:1px solid #eee; padding:8px; border-radius:4px;">
                <!-- Checkboxes go here -->
            </div>
        </div>
        
        <div id="correctLoading" style="text-align:center; margin:16px 0; display:none; color:#666;">
            <div>æ­£åœ¨æŸ¥æ‰¾ç›¸ä¼¼åœºåœ°...</div>
        </div>

        <div class="actions" style="margin-top:16px;">
            <button class="btn" id="locCorrectCancel">å–æ¶ˆ</button>
            <button class="btn btn-warning" id="locCorrectConfirm">ç¡®è®¤æ ¡æ­£</button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="/static/layout.js?v=auth_v2"></script>
<script>
    // Ensure Sortable is loaded if not present
    if (typeof Sortable === 'undefined') {
        const script = document.createElement('script');
        script.src = "/static/lib/Sortable.min.js";
        script.onload = () => console.log("Sortable loaded manually");
        document.body.appendChild(script);
    }

    initLayout('è®¾å¤‡ç®¡ç†');

    const els = {
        table: document.getElementById('deviceTable'),
        refresh: document.getElementById('refreshBtn'),
        editModal: document.getElementById('editModal'),
        editUuid: document.getElementById('editUuid'),
        editName: document.getElementById('editName'),
        editCategory: document.getElementById('editCategory'),
        saveEdit: document.getElementById('saveEdit'),
        closeEdit: document.getElementById('closeEdit'),
        
        academyBtn: document.getElementById('addAcademyBtn'),
        academyModal: document.getElementById('academyModal'),
        academyList: document.getElementById('academyList'),
        newAcademy: document.getElementById('newAcademy'),
        addAcademy: document.getElementById('addAcademy'),
        closeAcademy: document.getElementById('closeAcademy'),

        // Loc Edit
        locEditModal: document.getElementById('locEditModal'),
        locEditOldName: document.getElementById('locEditOldName'),
        locEditName: document.getElementById('locEditName'),
        locEditAca: document.getElementById('locEditAca'),
        locEditCancel: document.getElementById('locEditCancel'),
        locEditSave: document.getElementById('locEditSave'),

        // Loc Filter
        searchLoc: document.getElementById('searchLoc'),
        filterLocAca: document.getElementById('filterLocAca')
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    let academySortable = null;

    async function loadAcademies() {
        // Fetch academies.
        const res = await fetch('/api/v1/academies');
        let list = [];
        if(res.ok) {
            list = await res.json();
        }
        
        // Render in Select
        els.editCategory.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>' + 
            list.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            
        // Render in Manager (Sortable List)
        els.academyList.innerHTML = list.map(a => `
            <div class="sortable-item" data-id="${a.id}">
                <div style="display:flex;align-items:center">
                    <span class="sortable-handle">â˜°</span>
                    <span class="academy-name">${a.name}</span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="delAcademy('${a.id}')" style="padding:4px 8px;font-size:12px">åˆ é™¤</button>
            </div>
        `).join('');
        
        // Re-init Sortable
        if(academySortable) academySortable.destroy();
        
        academySortable = new Sortable(els.academyList, {
            animation: 150,
            handle: '.sortable-handle',
            ghostClass: 'sortable-ghost',
            onEnd: async function (evt) {
                const newOrder = [];
                els.academyList.querySelectorAll('.sortable-item').forEach(el => {
                    newOrder.push(parseInt(el.dataset.id));
                });
                
                // Save order
                try {
                    const res = await fetch('/api/v1/academies-reorder', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({order: newOrder})
                    });
                    if(!res.ok) throw new Error('Failed to save order');
                    // Optional: showToast('æ’åºå·²ä¿å­˜');
                } catch(e) {
                    showToast('æ’åºä¿å­˜å¤±è´¥');
                    console.error(e);
                }
            }
        });
    }

    async function loadDevices() {
        // We need a rich list. /api/v1/devices might be too simple.
        // Let's assume /api/v1/devices returns registry info or we merge it.
        // currently /api/v1/devices returns list_devices() which queries DB stats.
        // admin/device/registry is better.
        // Always use the list+mapping approach to ensure ALL devices (even unregistered ones) are shown
        try {
            const [devRes, mapRes] = await Promise.all([
                fetch('/api/v1/devices'),
                fetch('/api/v1/devices/mapping')
            ]);
            
            const devs = await devRes.json();
            const mapping = (await mapRes.json()).mapping || {};
            
            items = devs.map(d => {
                const uuid = typeof d === 'string' ? d : d.uuid;
                const entry = mapping[uuid];
                return {
                    uuid: uuid,
                    name: entry ? (entry.name || '') : '',
                    category: entry ? (entry.category || '') : '',
                    create_time: '-'
                };
            });
        } catch(e) {
            console.error("Load devices failed", e);
        }

        els.table.innerHTML = items.map(d => `
            <tr>
                <td>${d.uuid}</td>
                <td>${d.name || '<span class="text-muted">-</span>'}</td>
                <td><span class="badge badge-gray">${d.category || 'æœªåˆ†ç±»'}</span></td>
                <td>${d.create_time || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEdit('${d.uuid}', '${d.name||''}', '${d.category||''}')">ç¼–è¾‘</button>
                </td>
            </tr>
        `).join('');
    }

    window.openEdit = (uuid, name, cat) => {
        els.editUuid.value = uuid;
        els.editName.value = name;
        els.editCategory.value = cat;
        els.editModal.classList.add('show');
    };
    
    els.closeEdit.addEventListener('click', () => els.editModal.classList.remove('show'));
    
    els.saveEdit.addEventListener('click', async () => {
        const uuid = els.editUuid.value;
        const name = els.editName.value;
        const category = els.editCategory.value;
        
        // Assuming /api/v1/admin/device/registry handles this
        const res = await fetch('/api/v1/admin/registry', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({uuid, name, category})
        });
        
        if(res.ok) {
            showToast('ä¿å­˜æˆåŠŸ');
            els.editModal.classList.remove('show');
            loadDevices();
        } else {
            showToast('ä¿å­˜å¤±è´¥');
        }
    });

    // Academy Management
    els.academyBtn.addEventListener('click', () => {
        loadAcademies();
        els.academyModal.classList.add('show');
    });
    els.closeAcademy.addEventListener('click', () => els.academyModal.classList.remove('show'));
    
    els.addAcademy.addEventListener('click', async () => {
        const name = els.newAcademy.value.trim();
        if(!name) return;
        
        const res = await fetch('/api/v1/academies', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        
        if(res.ok) {
            els.newAcademy.value = '';
            loadAcademies();
        }
    });
    
    window.delAcademy = async (id) => {
        if(!await showConfirm('ç¡®å®šåˆ é™¤?')) return;
        await fetch(`/api/v1/academies/${id}`, {
             method: 'DELETE'
        });
        loadAcademies();
    };

    // Init
    loadAcademies();
    loadDevices();
    els.refresh.addEventListener('click', loadDevices);

    // --- Location Mapping Logic ---
    els.locationTable = document.getElementById('locationTable');
    els.refreshLoc = document.getElementById('refreshLocBtn');
    els.newLocName = document.getElementById('newLocName');
    els.newLocAca = document.getElementById('newLocAca');
    els.addLocBtn = document.getElementById('addLocBtn');

    async function loadLocationMapping() {
        try {
            const [mapRes, acaRes] = await Promise.all([
                fetch('/api/v1/locations/mapping'),
                fetch('/api/v1/academies')
            ]);
            
            const mapping = (await mapRes.json()).mapping || {};
            const academies = await acaRes.json();
            
            // Populate New Loc Academy Select
            const acaOpts = `<option value="">-- é€‰æ‹©ä¹¦é™¢ --</option>` + 
                academies.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            els.newLocAca.innerHTML = acaOpts;
            
            // Populate Filter Academy Select (preserve selection if possible)
            const currentFilterAca = els.filterLocAca.value;
            els.filterLocAca.innerHTML = `<option value="">æ‰€æœ‰ä¹¦é™¢</option>` + 
                academies.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            els.filterLocAca.value = currentFilterAca;

            // Render Table (Sorted by name)
            const locs = Object.keys(mapping).sort();
            const searchVal = els.searchLoc.value.trim().toLowerCase();
            const filterAcaVal = els.filterLocAca.value;
            
            const filteredLocs = locs.filter(l => {
                const currentAca = mapping[l] || '';
                // Search filter
                if(searchVal && !l.toLowerCase().includes(searchVal)) return false;
                // Academy filter
                if(filterAcaVal && currentAca !== filterAcaVal) return false;
                return true;
            });

            els.locationTable.innerHTML = filteredLocs.map((l, index) => {
                const currentAca = mapping[l] || '';
                // Escape string for ID and JS params
                const safeL = l.replace(/"/g, '&quot;').replace(/'/g, "\\'");
                const statusId = `status-${index}`;
                
                return `
                <tr>
                    <td>${l}</td>
                    <td>${currentAca}</td>
                    <td>
                        <div style="display:flex;gap:4px">
                            <button class="btn btn-sm btn-primary" onclick="openLocEdit('${safeL}', '${currentAca}')">ä¿®æ”¹</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLocMapping('${safeL}')">åˆ é™¤</button>
                            <button class="btn btn-sm btn-warning" onclick="openLocCorrection('${safeL}', '${currentAca}')">æ ¡æ­£</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
        } catch(e) {
            console.error(e);
            showToast('åŠ è½½åœºåœ°é…ç½®å¤±è´¥');
        }
    }

    // Filter Events
    els.searchLoc.addEventListener('input', loadLocationMapping);
    els.filterLocAca.addEventListener('change', loadLocationMapping);

    window.openLocEdit = (name, aca) => {
        els.locEditOldName.value = name;
        els.locEditName.value = name;
        
        // Copy options from newLocAca to locEditAca if empty
        if(els.locEditAca.options.length <= 1) {
            els.locEditAca.innerHTML = els.newLocAca.innerHTML;
        }
        els.locEditAca.value = aca;
        
        els.locEditModal.classList.add('show');
    };
    
    els.locEditCancel.addEventListener('click', () => els.locEditModal.classList.remove('show'));
    
    els.locEditSave.addEventListener('click', async () => {
        const oldName = els.locEditOldName.value;
        const newName = els.locEditName.value.trim();
        const aca = els.locEditAca.value;
        
        if(!newName) { showToast('åç§°ä¸èƒ½ä¸ºç©º'); return; }
        
        try {
            // If name changed, delete old first
            if(oldName !== newName) {
                // Ideally this should be a transaction or rename API, 
                // but for now we do Delete + Add
                const delRes = await fetch(`/api/v1/locations/mapping?location=${encodeURIComponent(oldName)}`, {
                    method: 'DELETE'
                });
                if(!delRes.ok) throw new Error('Delete failed');
            }
            
            // Add/Update new
            const res = await fetch('/api/v1/locations/mapping', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({location: newName, academy: aca})
            });
            
            if(res.ok) {
                showToast('ä¿å­˜æˆåŠŸ');
                els.locEditModal.classList.remove('show');
                loadLocationMapping();
            } else {
                throw new Error('Save failed');
            }
        } catch(e) {
            console.error(e);
            showToast('ä¿å­˜å¤±è´¥');
        }
    });

    els.addLocBtn.addEventListener('click', async () => {
        const name = els.newLocName.value.trim();
        const aca = els.newLocAca.value;
        if(!name) { showToast('è¯·è¾“å…¥åœºåœ°åç§°'); return; }
        if(!aca) { showToast('è¯·é€‰æ‹©å½’å±ä¹¦é™¢'); return; }
        
        try {
            const res = await fetch('/api/v1/locations/mapping', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({location: name, academy: aca})
            });
            if(res.ok) {
                showToast('æ·»åŠ æˆåŠŸ');
                els.newLocName.value = '';
                loadLocationMapping();
            } else {
                throw new Error();
            }
        } catch(e) {
            showToast('æ·»åŠ å¤±è´¥');
        }
    });

    window.deleteLocMapping = async (loc) => {
        if(!await showConfirm('ç¡®å®šåˆ é™¤æ­¤æ ‡å‡†åœºåœ°é…ç½®?')) return;
        try {
            const res = await fetch(`/api/v1/locations/mapping?location=${encodeURIComponent(loc)}`, {
                method: 'DELETE'
            });
            if(res.ok) {
                showToast('å·²åˆ é™¤');
                loadLocationMapping();
            } else {
                throw new Error();
            }
        } catch(e) {
            showToast('åˆ é™¤å¤±è´¥');
        }
    };
    
    // Correction Logic
    els.locCorrectModal = document.getElementById('locCorrectionModal');
    els.locCorrectCancel = document.getElementById('locCorrectCancel');
    els.locCorrectConfirm = document.getElementById('locCorrectConfirm');
    
    els.locCorrectCancel.addEventListener('click', () => {
        els.locCorrectModal.classList.remove('show');
    });

    let currentCorrectionTarget = null;
    let currentCorrectionAca = null;

    window.openLocCorrection = async (name, aca) => {
        currentCorrectionTarget = name;
        currentCorrectionAca = aca;
        
        document.getElementById('correctLocName').textContent = name;
        document.getElementById('correctLocAca').textContent = aca;
        document.getElementById('similarLocsSection').style.display = 'none';
        document.getElementById('similarLocsList').innerHTML = '';
        
        els.locCorrectModal.classList.add('show');
        
        // Fetch candidates
        document.getElementById('correctLoading').style.display = 'block';
        try {
            const res = await fetch(`/api/v1/locations/correction-candidates?location=${encodeURIComponent(name)}`);
            const candidates = await res.json();
            
            if (candidates && candidates.length > 0) {
                const listHtml = candidates.map(c => {
                    const safeC = c.replace(/"/g, '&quot;');
                    return `
                    <div style="margin-bottom:4px">
                        <label style="display:flex;align-items:center;cursor:pointer">
                            <input type="checkbox" value="${safeC}" style="margin-right:8px">
                            <span>${c}</span>
                        </label>
                    </div>
                `}).join('');
                document.getElementById('similarLocsList').innerHTML = listHtml;
                document.getElementById('similarLocsSection').style.display = 'block';
            } else {
                 document.getElementById('similarLocsSection').style.display = 'none';
            }
        } catch(e) {
            console.error(e);
        } finally {
            document.getElementById('correctLoading').style.display = 'none';
        }
    };
    
    els.locCorrectConfirm.addEventListener('click', async () => {
        const mergeLocs = [];
        const checkboxes = document.querySelectorAll('#similarLocsList input[type="checkbox"]:checked');
        checkboxes.forEach(chk => mergeLocs.push(chk.value));
        
        const msg = `ç¡®å®šè¦æ ¡æ­£ ${currentCorrectionTarget} çš„æ•°æ®å—ï¼Ÿ` + 
                    (mergeLocs.length ? `\nå°†åˆå¹¶ ${mergeLocs.length} ä¸ªç›¸ä¼¼åœºåœ°ã€‚` : '') + 
                    `\nè¿™å°†æ›´æ–°ç›¸å…³çš„å†å²æ´»åŠ¨è®°å½•ã€‚`;

        if(!await showConfirm(msg)) return;
        
        try {
            const res = await fetch('/api/v1/locations/correct', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    location: currentCorrectionTarget,
                    academy: currentCorrectionAca,
                    merge_locations: mergeLocs
                })
            });
            const data = await res.json();
            if(res.ok) {
                showToast(`æ ¡æ­£å®Œæˆï¼Œæ›´æ–°äº† ${data.count} æ¡è®°å½•`);
                els.locCorrectModal.classList.remove('show');
                loadLocationMapping();
            } else {
                throw new Error();
            }
        } catch(e) {
            showToast('æ ¡æ­£å¤±è´¥');
        }
    });
    
    if(els.refreshLoc) els.refreshLoc.addEventListener('click', loadLocationMapping);
    loadLocationMapping();

</script>
</body>
</html>