<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - InfraCount</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/lib/Sortable.min.js"></script>
    <style>
        .sortable-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .sortable-item:last-child { margin-bottom: 0; }
        .sortable-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        .sortable-item.sortable-ghost {
            opacity: 0.4;
            background: #f1f3f5;
        }
        .sortable-handle {
            color: #adb5bd;
            margin-right: 12px;
            cursor: grab;
            font-size: 18px;
        }
        .academy-name {
            font-weight: 500;
            color: var(--text);
            flex: 1;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h3>è®¾å¤‡åˆ—è¡¨</h3>
        <div class="flex gap-2">
            <button class="btn" id="refreshBtn">åˆ·æ–°</button>
            <button class="btn btn-primary" id="addAcademyBtn">ç®¡ç†ä¹¦é™¢åˆ†ç±»</button>
        </div>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>ä¹¦é™¢/åˆ†ç±»</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th style="width:120px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="deviceTable"></tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-backdrop">
    <div class="modal">
        <h3>ç¼–è¾‘è®¾å¤‡ä¿¡æ¯</h3>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">UUID</label>
            <input id="editUuid" class="input" disabled style="background:#f1f3f5">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ˜¾ç¤ºåç§°</label>
            <input id="editName" class="input" placeholder="ä¾‹å¦‚ï¼šæ­£å¿ƒæ¥¼101">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ‰€å±ä¹¦é™¢</label>
            <select id="editCategory" class="select"></select>
        </div>
        <div class="actions">
            <button class="btn" id="closeEdit">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="saveEdit">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Academy Manager Modal -->
<div id="academyModal" class="modal-backdrop">
    <div class="modal" style="width: 480px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0">ä¹¦é™¢åˆ†ç±»ç®¡ç†</h3>
            <button class="btn btn-sm" id="closeAcademy" style="border:none;font-size:20px;color:#999;background:transparent">âœ•</button>
        </div>
        
        <div class="flex gap-2 mb-4">
            <input id="newAcademy" class="input" placeholder="æ–°ä¹¦é™¢åç§°" style="flex:1">
            <button class="btn btn-primary" id="addAcademy">æ·»åŠ </button>
        </div>
        
        <div style="background:#f8f9fa; border:1px solid var(--border); border-radius:8px; padding:12px; max-height:400px; overflow-y:auto;">
            <div id="academyList" class="sortable-list">
                <!-- Items injected here -->
            </div>
        </div>
        
        <div style="margin-top:12px; text-align:center; font-size:12px; color:#adb5bd;">
            ğŸ’¡ æ‹–åŠ¨åˆ—è¡¨é¡¹å³å¯è°ƒæ•´é¡ºåº
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/static/layout.js"></script>
<script>
    // Ensure Sortable is loaded if not present
    if (typeof Sortable === 'undefined') {
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js";
        script.onload = () => console.log("Sortable loaded manually");
        document.body.appendChild(script);
    }

    initLayout('è®¾å¤‡ç®¡ç†');

    const els = {
        table: document.getElementById('deviceTable'),
        refresh: document.getElementById('refreshBtn'),
        editModal: document.getElementById('editModal'),
        editUuid: document.getElementById('editUuid'),
        editName: document.getElementById('editName'),
        editCategory: document.getElementById('editCategory'),
        saveEdit: document.getElementById('saveEdit'),
        closeEdit: document.getElementById('closeEdit'),
        
        academyBtn: document.getElementById('addAcademyBtn'),
        academyModal: document.getElementById('academyModal'),
        academyList: document.getElementById('academyList'),
        newAcademy: document.getElementById('newAcademy'),
        addAcademy: document.getElementById('addAcademy'),
        closeAcademy: document.getElementById('closeAcademy')
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    let academySortable = null;

    async function loadAcademies() {
        // Fetch academies.
        const res = await fetch('/api/v1/academies');
        let list = [];
        if(res.ok) {
            list = await res.json();
        }
        
        // Render in Select
        els.editCategory.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>' + 
            list.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            
        // Render in Manager (Sortable List)
        els.academyList.innerHTML = list.map(a => `
            <div class="sortable-item" data-id="${a.id}">
                <div style="display:flex;align-items:center">
                    <span class="sortable-handle">â˜°</span>
                    <span class="academy-name">${a.name}</span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="delAcademy('${a.id}')" style="padding:4px 8px;font-size:12px">åˆ é™¤</button>
            </div>
        `).join('');
        
        // Re-init Sortable
        if(academySortable) academySortable.destroy();
        
        academySortable = new Sortable(els.academyList, {
            animation: 150,
            handle: '.sortable-handle',
            ghostClass: 'sortable-ghost',
            onEnd: async function (evt) {
                const newOrder = [];
                els.academyList.querySelectorAll('.sortable-item').forEach(el => {
                    newOrder.push(parseInt(el.dataset.id));
                });
                
                // Save order
                try {
                    const res = await fetch('/api/v1/academies-reorder', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({order: newOrder})
                    });
                    if(!res.ok) throw new Error('Failed to save order');
                    // Optional: showToast('æ’åºå·²ä¿å­˜');
                } catch(e) {
                    showToast('æ’åºä¿å­˜å¤±è´¥');
                    console.error(e);
                }
            }
        });
    }

    async function loadDevices() {
        // We need a rich list. /api/v1/devices might be too simple.
        // Let's assume /api/v1/devices returns registry info or we merge it.
        // currently /api/v1/devices returns list_devices() which queries DB stats.
        // admin/device/registry is better.
        // Always use the list+mapping approach to ensure ALL devices (even unregistered ones) are shown
        try {
            const [devRes, mapRes] = await Promise.all([
                fetch('/api/v1/devices'),
                fetch('/api/v1/devices/mapping')
            ]);
            
            const devs = await devRes.json();
            const mapping = (await mapRes.json()).mapping || {};
            
            items = devs.map(d => {
                const uuid = typeof d === 'string' ? d : d.uuid;
                const entry = mapping[uuid];
                return {
                    uuid: uuid,
                    name: entry ? (entry.name || '') : '',
                    category: entry ? (entry.category || '') : '',
                    create_time: '-'
                };
            });
        } catch(e) {
            console.error("Load devices failed", e);
        }

        els.table.innerHTML = items.map(d => `
            <tr>
                <td>${d.uuid}</td>
                <td>${d.name || '<span class="text-muted">-</span>'}</td>
                <td><span class="badge badge-gray">${d.category || 'æœªåˆ†ç±»'}</span></td>
                <td>${d.create_time || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEdit('${d.uuid}', '${d.name||''}', '${d.category||''}')">ç¼–è¾‘</button>
                </td>
            </tr>
        `).join('');
    }

    window.openEdit = (uuid, name, cat) => {
        els.editUuid.value = uuid;
        els.editName.value = name;
        els.editCategory.value = cat;
        els.editModal.classList.add('show');
    };
    
    els.closeEdit.addEventListener('click', () => els.editModal.classList.remove('show'));
    
    els.saveEdit.addEventListener('click', async () => {
        const uuid = els.editUuid.value;
        const name = els.editName.value;
        const category = els.editCategory.value;
        
        // Assuming /api/v1/admin/device/registry handles this
        const res = await fetch('/api/v1/admin/registry', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({uuid, name, category})
        });
        
        if(res.ok) {
            showToast('ä¿å­˜æˆåŠŸ');
            els.editModal.classList.remove('show');
            loadDevices();
        } else {
            showToast('ä¿å­˜å¤±è´¥');
        }
    });

    // Academy Management
    els.academyBtn.addEventListener('click', () => {
        loadAcademies();
        els.academyModal.classList.add('show');
    });
    els.closeAcademy.addEventListener('click', () => els.academyModal.classList.remove('show'));
    
    els.addAcademy.addEventListener('click', async () => {
        const name = els.newAcademy.value.trim();
        if(!name) return;
        
        const res = await fetch('/api/v1/academies', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        
        if(res.ok) {
            els.newAcademy.value = '';
            loadAcademies();
        }
    });
    
    window.delAcademy = async (id) => {
        if(!await showConfirm('ç¡®å®šåˆ é™¤?')) return;
        await fetch(`/api/v1/academies/${id}`, {
             method: 'DELETE'
        });
        loadAcademies();
    };

    // Init
    loadAcademies();
    loadDevices();
    els.refresh.addEventListener('click', loadDevices);

</script>
</body>
</html>