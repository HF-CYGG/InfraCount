<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - InfraCount</title>
    <link rel="stylesheet" href="/static/style.css?v=ui_v1">
    <script src="/static/lib/Sortable.min.js"></script>
    <style>
        .sortable-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .sortable-item:last-child { margin-bottom: 0; }
        .sortable-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        .sortable-item.sortable-ghost {
            opacity: 0.4;
            background: #f1f3f5;
        }
        .sortable-handle {
            color: #adb5bd;
            margin-right: 12px;
            cursor: grab;
            font-size: 18px;
        }
        .academy-name {
            font-weight: 500;
            color: var(--text);
            flex: 1;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h3>è®¾å¤‡åˆ—è¡¨</h3>
        <div class="flex gap-2">
            <button class="btn" id="refreshBtn">åˆ·æ–°</button>
            <button class="btn btn-primary" id="addAcademyBtn">ç®¡ç†ä¹¦é™¢åˆ†ç±»</button>
        </div>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>ä¹¦é™¢/åˆ†ç±»</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th style="width:120px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="deviceTable"></tbody>
        </table>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <div class="flex justify-between items-center mb-4">
        <h3>æ ‡å‡†åœºåœ°é…ç½® (ç”¨äºAIè¯†åˆ«ä¸å½’å±)</h3>
        <div class="flex gap-2">
            <button class="btn btn-warning" id="autoCorrectBtn">ä¸€é”®æ ¡æ­£</button>
            <button class="btn" id="refreshLocBtn">åˆ·æ–°</button>
        </div>
    </div>
    
    <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px; display:flex; gap:12px; align-items:end;">
        <div style="flex:1">
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">æ ‡å‡†åœºåœ°åç§°</label>
            <input id="newLocName" class="input" placeholder="ä¾‹å¦‚ï¼šHelloä¼šå®¢å…(Y1-103)" style="width:100%">
        </div>
        <div style="width:200px">
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">å½’å±ä¹¦é™¢</label>
            <select id="newLocAca" class="select" style="width:100%"></select>
        </div>
        <button class="btn btn-primary" id="addLocBtn">æ·»åŠ </button>
    </div>
    
    <!-- Filter Bar -->
    <div style="margin-bottom:12px; display:flex; gap:12px; align-items:center;">
        <input id="searchLoc" class="input" placeholder="æœç´¢åœºåœ°..." style="width:200px">
        <select id="filterLocAca" class="select" style="width:150px">
            <option value="">æ‰€æœ‰ä¹¦é™¢</option>
        </select>
    </div>

    <div class="table-wrap" style="max-height: 500px; overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <th>æ ‡å‡†åœºåœ°åç§°</th>
                    <th>å½’å±ä¹¦é™¢</th>
                    <th style="width:100px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="locationTable"></tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-backdrop">
    <div class="modal">
        <h3>ç¼–è¾‘è®¾å¤‡ä¿¡æ¯</h3>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">UUID</label>
            <input id="editUuid" class="input" disabled style="background:#f1f3f5">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ˜¾ç¤ºåç§°</label>
            <input id="editName" class="input" placeholder="ä¾‹å¦‚ï¼šæ­£å¿ƒæ¥¼101">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ‰€å±ä¹¦é™¢</label>
            <select id="editCategory" class="select"></select>
        </div>
        <div class="actions">
            <button class="btn" id="closeEdit">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="saveEdit">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Academy Manager Modal -->
<div id="academyModal" class="modal-backdrop">
    <div class="modal" style="width: 480px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0">ä¹¦é™¢åˆ†ç±»ç®¡ç†</h3>
            <button class="btn btn-sm" id="closeAcademy" style="border:none;font-size:20px;color:#999;background:transparent">âœ•</button>
        </div>
        
        <div class="flex gap-2 mb-4">
            <input id="newAcademy" class="input" placeholder="æ–°ä¹¦é™¢åç§°" style="flex:1">
            <button class="btn btn-primary" id="addAcademy">æ·»åŠ </button>
        </div>
        
        <div style="background:#f8f9fa; border:1px solid var(--border); border-radius:8px; padding:12px; max-height:400px; overflow-y:auto;">
            <div id="academyList" class="sortable-list">
                <!-- Items injected here -->
            </div>
        </div>
        
        <div style="margin-top:12px; text-align:center; font-size:12px; color:#adb5bd;">
            ğŸ’¡ æ‹–åŠ¨åˆ—è¡¨é¡¹å³å¯è°ƒæ•´é¡ºåº
        </div>
    </div>
</div>

<!-- Location Edit Modal -->
<div id="locEditModal" class="modal-backdrop">
    <div class="modal">
        <h3>ç¼–è¾‘æ ‡å‡†åœºåœ°</h3>
        <input type="hidden" id="locEditOldName">
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">æ ‡å‡†åœºåœ°åç§°</label>
            <input id="locEditName" class="input" style="width:100%">
        </div>
        <div class="mb-4">
            <label style="display:block;margin-bottom:4px">å½’å±ä¹¦é™¢</label>
            <select id="locEditAca" class="select" style="width:100%"></select>
        </div>
        <div class="actions">
            <button class="btn" id="locEditCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="locEditSave">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Batch Correction Modal -->
<div id="batchCorrectionModal" class="modal-backdrop">
    <div class="modal" style="width: 800px; max-width: 95vw;">
        <h3>ä¸€é”®æ ¡æ­£ç»“æœ</h3>
        
        <div id="batchLoading" style="text-align:center; padding: 40px; display:none;">
            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ¤–</div>
            <p>æ­£åœ¨æ™ºèƒ½åˆ†æåœºåœ°æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div id="batchContent" style="display:none">
            <div id="batchReviewSection">
                <div class="alert alert-warning mb-4" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 12px; border-radius: 4px;">
                    <strong>å‘ç° <span id="reviewCount">0</span> æ¡æ•°æ®éœ€è¦äººå·¥ç¡®è®¤</strong><br>
                    <span style="font-size: 0.9em">ä»¥ä¸‹æ•°æ®ç½®ä¿¡åº¦è¾ƒä½ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ­£ç¡®çš„æ ‡å‡†åœºåœ°ã€‚ç¡®è®¤åç³»ç»Ÿå°†è‡ªåŠ¨å­¦ä¹ ã€‚</span>
                </div>
                
                <div class="table-wrap" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left;">åŸå§‹åœºåœ°åç§°</th>
                                <th style="padding: 12px; text-align: left;">AI å»ºè®®åŒ¹é…</th>
                                <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="batchReviewTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="actions mt-4" style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn" id="batchClose">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="batchConfirm">ç¡®è®¤å¹¶æ ¡æ­£</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="/static/layout.js?v=auth_v4"></script>
<script>
    // Ensure Sortable is loaded if not present
    if (typeof Sortable === 'undefined') {
        const script = document.createElement('script');
        script.src = "/static/lib/Sortable.min.js";
        script.onload = () => console.log("Sortable loaded manually");
        document.body.appendChild(script);
    }

    initLayout('è®¾å¤‡ç®¡ç†');

    const els = {
        table: document.getElementById('deviceTable'),
        refresh: document.getElementById('refreshBtn'),
        editModal: document.getElementById('editModal'),
        editUuid: document.getElementById('editUuid'),
        editName: document.getElementById('editName'),
        editCategory: document.getElementById('editCategory'),
        saveEdit: document.getElementById('saveEdit'),
        closeEdit: document.getElementById('closeEdit'),
        
        academyBtn: document.getElementById('addAcademyBtn'),
        academyModal: document.getElementById('academyModal'),
        academyList: document.getElementById('academyList'),
        newAcademy: document.getElementById('newAcademy'),
        addAcademy: document.getElementById('addAcademy'),
        closeAcademy: document.getElementById('closeAcademy'),

        // Loc Edit
        locEditModal: document.getElementById('locEditModal'),
        locEditOldName: document.getElementById('locEditOldName'),
        locEditName: document.getElementById('locEditName'),
        locEditAca: document.getElementById('locEditAca'),
        locEditCancel: document.getElementById('locEditCancel'),
        locEditSave: document.getElementById('locEditSave'),

        // Loc Filter
        searchLoc: document.getElementById('searchLoc'),
        filterLocAca: document.getElementById('filterLocAca')
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    let academySortable = null;

    async function loadAcademies() {
        // Fetch academies.
        const res = await fetch('/api/v1/academies');
        let list = [];
        if(res.ok) {
            list = await res.json();
        }
        
        // Render in Select
        els.editCategory.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>' + 
            list.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            
        // Render in Manager (Sortable List)
        els.academyList.innerHTML = list.map(a => `
            <div class="sortable-item" data-id="${a.id}">
                <div style="display:flex;align-items:center">
                    <span class="sortable-handle">â˜°</span>
                    <span class="academy-name">${a.name}</span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="delAcademy('${a.id}')" style="padding:4px 8px;font-size:12px">åˆ é™¤</button>
            </div>
        `).join('');
        
        // Re-init Sortable
        if(academySortable) academySortable.destroy();
        
        academySortable = new Sortable(els.academyList, {
            animation: 150,
            handle: '.sortable-handle',
            ghostClass: 'sortable-ghost',
            onEnd: async function (evt) {
                const newOrder = [];
                els.academyList.querySelectorAll('.sortable-item').forEach(el => {
                    newOrder.push(parseInt(el.dataset.id));
                });
                
                // Save order
                try {
                    const res = await fetch('/api/v1/academies-reorder', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({order: newOrder})
                    });
                    if(!res.ok) throw new Error('Failed to save order');
                    // Optional: showToast('æ’åºå·²ä¿å­˜');
                } catch(e) {
                    showToast('æ’åºä¿å­˜å¤±è´¥');
                    console.error(e);
                }
            }
        });
    }

    async function loadDevices() {
        // We need a rich list. /api/v1/devices might be too simple.
        // Let's assume /api/v1/devices returns registry info or we merge it.
        // currently /api/v1/devices returns list_devices() which queries DB stats.
        // admin/device/registry is better.
        // Always use the list+mapping approach to ensure ALL devices (even unregistered ones) are shown
        try {
            const [devRes, mapRes] = await Promise.all([
                fetch('/api/v1/devices'),
                fetch('/api/v1/devices/mapping')
            ]);
            
            const devs = await devRes.json();
            const mapping = (await mapRes.json()).mapping || {};
            
            items = devs.map(d => {
                const uuid = typeof d === 'string' ? d : d.uuid;
                const entry = mapping[uuid];
                return {
                    uuid: uuid,
                    name: entry ? (entry.name || '') : '',
                    category: entry ? (entry.category || '') : '',
                    create_time: '-'
                };
            });
        } catch(e) {
            console.error("Load devices failed", e);
        }

        els.table.innerHTML = items.map(d => `
            <tr>
                <td>${d.uuid}</td>
                <td>${d.name || '<span class="text-muted">-</span>'}</td>
                <td><span class="badge badge-gray">${d.category || 'æœªåˆ†ç±»'}</span></td>
                <td>${d.create_time || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEdit('${d.uuid}', '${d.name||''}', '${d.category||''}')">ç¼–è¾‘</button>
                </td>
            </tr>
        `).join('');
    }

    window.openEdit = (uuid, name, cat) => {
        els.editUuid.value = uuid;
        els.editName.value = name;
        els.editCategory.value = cat;
        els.editModal.classList.add('show');
    };
    
    els.closeEdit.addEventListener('click', () => els.editModal.classList.remove('show'));
    
    els.saveEdit.addEventListener('click', async () => {
        const uuid = els.editUuid.value;
        const name = els.editName.value;
        const category = els.editCategory.value;
        
        // Assuming /api/v1/admin/device/registry handles this
        const res = await fetch('/api/v1/admin/registry', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({uuid, name, category})
        });
        
        if(res.ok) {
            showToast('ä¿å­˜æˆåŠŸ');
            els.editModal.classList.remove('show');
            loadDevices();
        } else {
            showToast('ä¿å­˜å¤±è´¥');
        }
    });

    // Academy Management
    els.academyBtn.addEventListener('click', () => {
        loadAcademies();
        els.academyModal.classList.add('show');
    });
    els.closeAcademy.addEventListener('click', () => els.academyModal.classList.remove('show'));
    
    els.addAcademy.addEventListener('click', async () => {
        const name = els.newAcademy.value.trim();
        if(!name) return;
        
        const res = await fetch('/api/v1/academies', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        
        if(res.ok) {
            els.newAcademy.value = '';
            loadAcademies();
        }
    });
    
    window.delAcademy = async (id) => {
        if(!await showConfirm('ç¡®å®šåˆ é™¤?')) return;
        await fetch(`/api/v1/academies/${id}`, {
             method: 'DELETE'
        });
        loadAcademies();
    };

    // Init
    loadAcademies();
    loadDevices();
    els.refresh.addEventListener('click', loadDevices);

    // --- Location Mapping Logic ---
    els.locationTable = document.getElementById('locationTable');
    els.refreshLoc = document.getElementById('refreshLocBtn');
    els.newLocName = document.getElementById('newLocName');
    els.newLocAca = document.getElementById('newLocAca');
    els.addLocBtn = document.getElementById('addLocBtn');

    async function loadLocationMapping() {
        try {
            const [mapRes, acaRes] = await Promise.all([
                fetch('/api/v1/locations/mapping'),
                fetch('/api/v1/academies')
            ]);
            
            const mapping = (await mapRes.json()).mapping || {};
            const academies = await acaRes.json();
            
            // Populate New Loc Academy Select
            const acaOpts = `<option value="">-- é€‰æ‹©ä¹¦é™¢ --</option>` + 
                academies.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            els.newLocAca.innerHTML = acaOpts;
            
            // Populate Filter Academy Select (preserve selection if possible)
            const currentFilterAca = els.filterLocAca.value;
            els.filterLocAca.innerHTML = `<option value="">æ‰€æœ‰ä¹¦é™¢</option>` + 
                academies.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            els.filterLocAca.value = currentFilterAca;

            // Render Table (Sorted by name)
            const locs = Object.keys(mapping).sort();
            const searchVal = els.searchLoc.value.trim().toLowerCase();
            const filterAcaVal = els.filterLocAca.value;
            
            const filteredLocs = locs.filter(l => {
                const currentAca = mapping[l] || '';
                // Search filter
                if(searchVal && !l.toLowerCase().includes(searchVal)) return false;
                // Academy filter
                if(filterAcaVal && currentAca !== filterAcaVal) return false;
                return true;
            });

            els.locationTable.innerHTML = filteredLocs.map((l, index) => {
                const currentAca = mapping[l] || '';
                // Escape string for ID and JS params
                const safeL = l.replace(/"/g, '&quot;').replace(/'/g, "\\'");
                const statusId = `status-${index}`;
                
                return `
                <tr>
                    <td>${l}</td>
                    <td>${currentAca}</td>
                    <td>
                        <div style="display:flex;gap:4px">
                            <button class="btn btn-sm btn-primary" onclick="openLocEdit('${safeL}', '${currentAca}')">ä¿®æ”¹</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLocMapping('${safeL}')">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
        } catch(e) {
            console.error(e);
            showToast('åŠ è½½åœºåœ°é…ç½®å¤±è´¥');
        }
    }

    // Filter Events
    els.searchLoc.addEventListener('input', loadLocationMapping);
    els.filterLocAca.addEventListener('change', loadLocationMapping);

    window.openLocEdit = (name, aca) => {
        els.locEditOldName.value = name;
        els.locEditName.value = name;
        
        // Copy options from newLocAca to locEditAca if empty
        if(els.locEditAca.options.length <= 1) {
            els.locEditAca.innerHTML = els.newLocAca.innerHTML;
        }
        els.locEditAca.value = aca;
        
        els.locEditModal.classList.add('show');
    };
    
    els.locEditCancel.addEventListener('click', () => els.locEditModal.classList.remove('show'));
    
    els.locEditSave.addEventListener('click', async () => {
        const oldName = els.locEditOldName.value;
        const newName = els.locEditName.value.trim();
        const aca = els.locEditAca.value;
        
        if(!newName) { showToast('åç§°ä¸èƒ½ä¸ºç©º'); return; }
        
        try {
            // If name changed, delete old first
            if(oldName !== newName) {
                // Ideally this should be a transaction or rename API, 
                // but for now we do Delete + Add
                const delRes = await fetch(`/api/v1/locations/mapping?location=${encodeURIComponent(oldName)}`, {
                    method: 'DELETE'
                });
                if(!delRes.ok) throw new Error('Delete failed');
            }
            
            // Add/Update new
            const res = await fetch('/api/v1/locations/mapping', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({location: newName, academy: aca})
            });
            
            if(res.ok) {
                showToast('ä¿å­˜æˆåŠŸ');
                els.locEditModal.classList.remove('show');
                loadLocationMapping();
            } else {
                throw new Error('Save failed');
            }
        } catch(e) {
            console.error(e);
            showToast('ä¿å­˜å¤±è´¥');
        }
    });

    els.addLocBtn.addEventListener('click', async () => {
        const name = els.newLocName.value.trim();
        const aca = els.newLocAca.value;
        if(!name) { showToast('è¯·è¾“å…¥åœºåœ°åç§°'); return; }
        if(!aca) { showToast('è¯·é€‰æ‹©å½’å±ä¹¦é™¢'); return; }
        
        try {
            const res = await fetch('/api/v1/locations/mapping', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({location: name, academy: aca})
            });
            if(res.ok) {
                showToast('æ·»åŠ æˆåŠŸ');
                els.newLocName.value = '';
                loadLocationMapping();
            } else {
                throw new Error();
            }
        } catch(e) {
            showToast('æ·»åŠ å¤±è´¥');
        }
    });

    window.deleteLocMapping = async (loc) => {
        if(!await showConfirm('ç¡®å®šåˆ é™¤æ­¤æ ‡å‡†åœºåœ°é…ç½®?')) return;
        try {
            const res = await fetch(`/api/v1/locations/mapping?location=${encodeURIComponent(loc)}`, {
                method: 'DELETE'
            });
            if(res.ok) {
                showToast('å·²åˆ é™¤');
                loadLocationMapping();
            } else {
                throw new Error();
            }
        } catch(e) {
            showToast('åˆ é™¤å¤±è´¥');
        }
    };
    
    // --- One-Click Correction Logic ---
    const batchEls = {
        modal: document.getElementById('batchCorrectionModal'),
        loading: document.getElementById('batchLoading'),
        content: document.getElementById('batchContent'),
        reviewCount: document.getElementById('reviewCount'),
        tableBody: document.getElementById('batchReviewTable'),
        close: document.getElementById('batchClose'),
        confirm: document.getElementById('batchConfirm'),
        btn: document.getElementById('autoCorrectBtn')
    };

    let batchScanResult = null;

    if(batchEls.btn) {
        batchEls.btn.addEventListener('click', async () => {
            batchEls.modal.classList.add('show');
            batchEls.loading.style.display = 'block';
            batchEls.content.style.display = 'none';
            
            try {
                const res = await fetch('/api/v1/locations/auto-correct-scan', { method: 'POST' });
                if(!res.ok) throw new Error('Scan failed');
                
                batchScanResult = await res.json();
                const { high_confidence, manual_review } = batchScanResult;
                
                // If nothing to correct
                if (manual_review.length === 0 && high_confidence.length === 0) {
                    await showAlert('ğŸ‰ å½“å‰æ²¡æœ‰å‘ç°éœ€è¦æ ¡æ­£çš„åœºåœ°æ•°æ®ã€‚æ‰€æœ‰åœºåœ°å‡å·²åŒ¹é…æˆ–æ— æ•°æ®ã€‚');
                    batchEls.modal.classList.remove('show');
                    return;
                }
                
                // If only high confidence matches, ask to auto apply
                if (manual_review.length === 0 && high_confidence.length > 0) {
                    batchEls.loading.style.display = 'none';
                    // Delay slightly to let loading hide
                    setTimeout(async () => {
                        if(await showConfirm(`å‘ç° ${high_confidence.length} æ¡é«˜ç½®ä¿¡åº¦åŒ¹é…æ•°æ®ï¼Œæ˜¯å¦ç«‹å³è‡ªåŠ¨æ ¡æ­£ï¼Ÿ`)) {
                            await applyBatchCorrection([], high_confidence);
                        } else {
                            batchEls.modal.classList.remove('show');
                        }
                    }, 100);
                    return;
                }
                
                // Show Manual Review UI
                batchEls.loading.style.display = 'none';
                batchEls.content.style.display = 'block';
                batchEls.reviewCount.textContent = manual_review.length;
                
                renderBatchTable(manual_review);
                
            } catch(e) {
                console.error(e);
                showToast('æ‰«æå¤±è´¥');
                batchEls.modal.classList.remove('show');
            }
        });
    }

    function renderBatchTable(items) {
        batchEls.tableBody.innerHTML = items.map((item, idx) => {
            const safeSource = item.source.replace(/"/g, '&quot;');
            return `
            <tr data-idx="${idx}">
                <td style="padding: 12px; border-bottom: 1px solid #eee;">${item.source}</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">
                    <div style="font-weight:bold; color:var(--primary)">${item.target}</div>
                    <div style="font-size:12px;color:#666">ç½®ä¿¡åº¦: ${Math.round(item.score)}% | å½’å±: ${item.academy}</div>
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">
                    <input type="checkbox" class="batch-check" checked style="transform: scale(1.5);">
                </td>
            </tr>
            `;
        }).join('');
    }

    async function applyBatchCorrection(manualCorrections, highConfCorrections) {
        const map = {}; // target -> { academy, sources: [] }
        
        const add = (item) => {
            if(!map[item.target]) {
                map[item.target] = { target: item.target, academy: item.academy, sources: [] };
            }
            map[item.target].sources.push(item.source);
        };
        
        if(highConfCorrections) highConfCorrections.forEach(add);
        if(manualCorrections) manualCorrections.forEach(add);
        
        const payload = {
            corrections: Object.values(map)
        };
        
        // Show loading state again
        batchEls.content.style.display = 'none';
        batchEls.loading.style.display = 'block';
        batchEls.loading.querySelector('p').textContent = 'æ­£åœ¨åº”ç”¨æ ¡æ­£å¹¶æ›´æ–°å†å²æ•°æ®...';

        try {
            const res = await fetch('/api/v1/locations/batch-correct', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if(res.ok) {
                await showAlert(`âœ… æˆåŠŸæ ¡æ­£äº† ${result.count} æ¡æ•°æ®ï¼`);
                batchEls.modal.classList.remove('show');
                loadLocationMapping(); // Refresh table
            } else {
                throw new Error('Update failed');
            }
        } catch(e) {
            console.error(e);
            await showAlert('æ ¡æ­£åº”ç”¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            batchEls.modal.classList.remove('show');
        }
    }

    batchEls.close.addEventListener('click', () => batchEls.modal.classList.remove('show'));
    
    batchEls.confirm.addEventListener('click', async () => {
        // Gather checked items from manual review
        const checkboxes = batchEls.tableBody.querySelectorAll('.batch-check:checked');
        const manualItems = [];
        checkboxes.forEach(cb => {
            const tr = cb.closest('tr');
            const idx = parseInt(tr.dataset.idx);
            if (batchScanResult && batchScanResult.manual_review[idx]) {
                manualItems.push(batchScanResult.manual_review[idx]);
            }
        });
        
        await applyBatchCorrection(manualItems, batchScanResult.high_confidence);
    });
    
    if(els.refreshLoc) els.refreshLoc.addEventListener('click', loadLocationMapping);
    loadLocationMapping();

</script>
</body>
</html>