<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦é™¢æ•°æ® - InfraCount</title>
    <link rel="stylesheet" href="/static/style.css?v=ui_v1">
    <style>
        .page-header {
            background: var(--card);
            padding: 20px 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .page-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .table-wrap {
            overflow-x: auto;
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            white-space: nowrap;
        }
        th {
            background: var(--bg-subtle);
            font-weight: 600;
            color: var(--text-secondary);
        }
        tr:hover td {
            background: var(--bg-subtle);
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .badge-academy { background: var(--primary-light); color: var(--primary); }
        .badge-type { background: rgba(250, 176, 5, 0.1); color: var(--warning); }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-backdrop.show { display: flex; }
        .modal {
            background: var(--card);
            padding: 24px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        /* Wizard Styles */
        .wizard-modal {
            max-width: 800px;
            width: 90%;
            display: flex;
            flex-direction: column;
            min-height: 500px;
            padding: 0;
            overflow: hidden;
        }

        .wizard-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-subtle);
        }

        .wizard-header h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
        }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }

        .step-item.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-item.active .step-icon {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 16px;
            margin-bottom: 24px; /* Align with icon center approx */
        }

        .wizard-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            position: relative;
        }

        .step-pane {
            display: none;
            animation: fadeIn 0.3s ease;
            height: 100%;
        }

        .step-pane.active {
            display: block;
        }

        /* Step 1: Drag Drop */
        .drag-drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-subtle);
        }

        .drag-drop-zone:hover, .drag-drop-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .drag-drop-zone .icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-body);
            border-radius: var(--radius-sm);
            margin-top: 16px;
            border: 1px solid var(--border);
        }

        /* Step 2: Preview */
        .data-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-item {
            background: var(--bg-body);
            padding: 16px;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-item label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .summary-item span {
            font-size: 18px;
            font-weight: 600;
        }

        .table-preview-wrap {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow-x: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th, .preview-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .preview-table th {
            background: var(--bg-subtle);
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Step 3: Progress */
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 24px;
        }

        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring svg {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke: var(--border);
            stroke-width: 8;
        }

        .progress-ring circle:last-child {
            stroke: var(--primary);
            stroke-dasharray: 314; /* 2 * PI * r */
            stroke-dashoffset: calc(314 - (314 * var(--percent)) / 100);
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-ring span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-info {
            text-align: center;
        }

        .wizard-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
        }

        .step-actions {
            display: flex;
            gap: 12px;
        }

        .hidden { display: none !important; }
        
        .relative { position: relative; }
        .popup-card {
            position: absolute;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            padding: 16px;
            z-index: 100;
            display: none;
            min-width: 250px;
        }
        .popup-card.show { display: block; }
        .date-range-btn {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            min-width: 240px;
            cursor: pointer;
        }
        .mb-2 { margin-bottom: 8px; }
        .cal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }
        .cal-wd {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            padding: 4px 0;
        }
        .cal-day {
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            font-size: 13px;
            padding: 0;
            transition: all 0.15s ease;
        }
        .cal-day:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .cal-day:active { transform: scale(0.98); }
        .cal-day.in-range {
            background: var(--primary-light);
            border-color: var(--primary-light);
        }
        .cal-day.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>

<div class="card">
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:12px">
        <button class="btn btn-primary" id="btnImport">ğŸ“¥ å¯¼å…¥è¡¨æ ¼</button>
        <button class="btn" id="btnSync" style="background:#4cc9f0; color:#fff; border:none">ğŸ”„ åŒæ­¥æ•£å®¢æ•°æ®</button>
    </div>
    <div class="filter-bar" style="margin-bottom:0;border:none;box-shadow:none;padding:0">
        <div class="flex items-center gap-2">
            <label>æ—¥æœŸèŒƒå›´</label>
            <div class="relative">
                <button id="dateRangeBtn" class="input date-range-btn" type="button">
                    <span id="dateRangeLabel" class="text-muted">é€‰æ‹©æ—¥æœŸèŒƒå›´</span>
                    <span style="opacity:.7">ğŸ“…</span>
                </button>
                <div id="dateRangePopup" class="popup-card" style="left:0;top:120%;min-width:360px">
                    <div class="flex gap-2 mb-2" style="flex-wrap:wrap">
                        <button class="btn btn-sm" id="quickToday" type="button">ä»Šå¤©</button>
                        <button class="btn btn-sm" id="quickLast7" type="button">è¿‘7å¤©</button>
                        <button class="btn btn-sm" id="quickWeek" type="button">æœ¬å‘¨</button>
                        <button class="btn btn-sm" id="quickMonth" type="button">æœ¬æœˆ</button>
                    </div>

                    <div class="cal-header">
                        <button class="btn btn-sm" id="calPrev" type="button">â€¹</button>
                        <div class="flex items-center gap-2" style="flex:1;justify-content:center">
                            <select id="calYear" class="select" style="height:28px;padding:0 8px;font-size:12px"></select>
                            <select id="calMonth" class="select" style="height:28px;padding:0 8px;font-size:12px"></select>
                        </div>
                        <button class="btn btn-sm" id="calNext" type="button">â€º</button>
                    </div>

                    <div class="cal-grid" id="calGrid"></div>

                    <div class="flex gap-2" style="justify-content:flex-end;margin-top:12px">
                        <button class="btn btn-sm" id="dateRangeClear" type="button">æ¸…ç©º</button>
                        <button class="btn btn-primary btn-sm" id="dateRangeApply" type="button">åº”ç”¨</button>
                    </div>
                </div>

                <input type="date" id="start" style="display:none">
                <input type="date" id="end" style="display:none">
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button class="btn btn-primary" id="query">æŸ¥è¯¢</button>
        </div>
        <div style="margin-left:auto; color:#888; font-size:13px">
            å…± <span id="totalCount">0</span> æ¡è®°å½•
        </div>
    </div>

    <div class="table-wrap" style="margin-top:16px">
        <table>
            <thead>
                <tr>
                    <th>åºå·</th>
                    <th>å¹´/æœˆ/æ—¥</th>
                    <th>å‘¨å‡ </th>
                    <th>èµ·å§‹æ—¶é—´</th>
                    <th>ç»“æŸæ—¶é—´</th>
                    <th>æ—¶é•¿</th>
                    <th>ä¹¦é™¢</th>
                    <th>å…·ä½“åœ°ç‚¹</th>
                    <th>æ´»åŠ¨åç§°</th>
                    <th>æ´»åŠ¨ç±»å‹</th>
                    <th>å—ä¼—å­¦ç”Ÿæ•°</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tbl"></tbody>
        </table>
    </div>
    
    <div style="text-align:center; padding:20px">
        <button class="btn" id="prevPage">ä¸Šä¸€é¡µ</button>
        <span id="pageInfo" style="margin:0 10px; font-size:14px">1</span>
        <button class="btn" id="nextPage">ä¸‹ä¸€é¡µ</button>
    </div>
</div>

<!-- Import Wizard Modal -->
<div id="importModal" class="modal-backdrop">
    <div class="modal wizard-modal">
        <div class="wizard-header">
            <h3>å¯¼å…¥æ•°æ®</h3>
            <div class="wizard-steps">
                <div class="step-item active" data-step="1">
                    <div class="step-icon">1</div>
                    <span>å¯¼å…¥æ–‡ä»¶</span>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="2">
                    <div class="step-icon">2</div>
                    <span>ç¡®å®šæ•°æ®</span>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="3">
                    <div class="step-icon">3</div>
                    <span>å¯¼å…¥æ•°æ®</span>
                </div>
            </div>
        </div>

        <div class="wizard-content">
            <!-- Step 1: Upload -->
            <div class="step-pane active" id="step1">
                <div class="drag-drop-zone" id="dropZone">
                    <div class="icon">ğŸ“‚</div>
                    <p>æ‹–æ‹½æ–‡ä»¶è‡³æ­¤ æˆ– ç‚¹å‡»é€‰æ‹©</p>
                    <p class="sub-text" style="color:var(--text-secondary); font-size:12px; margin-top:4px">æ”¯æŒ .xlsx, .xls, .csv</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden>
                </div>
                <div id="fileInfo" class="file-info hidden">
                    <span class="file-icon" style="font-size:20px">ğŸ“„</span>
                    <div style="flex:1">
                        <div id="fileName" style="font-weight:500">example.xlsx</div>
                        <div id="fileSize" style="font-size:12px;color:var(--text-secondary)">12KB</div>
                    </div>
                    <div class="text-success">âœ“</div>
                </div>
            </div>

            <!-- Step 2: Preview -->
            <div class="step-pane" id="step2">
                <div class="data-summary">
                    <div class="summary-item">
                        <label>æ€»è®°å½•æ•°</label>
                        <span id="previewTotal">0</span>
                    </div>
                    <div class="summary-item">
                        <label>æ—¥æœŸèŒƒå›´</label>
                        <span id="previewDateRange">-</span>
                    </div>
                </div>
                <div class="table-preview-wrap">
                    <table class="preview-table">
                        <thead>
                            <tr id="previewHeader"></tr>
                        </thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
                <p style="font-size:12px;color:var(--text-secondary);margin-top:8px">ä»…æ˜¾ç¤ºå‰ 5 æ¡æ•°æ®ç”¨äºé¢„è§ˆ</p>
            </div>

            <!-- Step 3: Progress -->
            <div class="step-pane" id="step3">
                <div class="progress-container">
                    <div class="progress-ring" style="--percent:0">
                        <svg><circle r="50" cx="60" cy="60" pathLength="100" /></svg>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-info">
                        <h4 id="progressStatus" style="margin:0 0 8px 0">å‡†å¤‡å¯¼å…¥...</h4>
                        <p id="progressCount" style="margin:0;color:var(--text-secondary)">å·²å¯¼å…¥ 0 / 0</p>
                        <p id="progressTime" style="margin:4px 0 0 0;font-size:12px;color:var(--text-secondary)">é¢„è®¡å‰©ä½™æ—¶é—´: --</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-footer">
            <button class="btn" id="importCancel">å–æ¶ˆ</button>
            <div class="step-actions">
                <button class="btn hidden" id="btnPrev">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btnNext" disabled>ä¸‹ä¸€æ­¥</button>
                <button class="btn btn-primary hidden" id="btnFinish">å®Œæˆ</button>
                <button class="btn hidden" id="btnSkip">è·³è¿‡é‡å¤</button>
                <button class="btn btn-primary hidden" id="btnOverwrite" style="background:#f57c00;border-color:#f57c00">è¦†ç›–é‡å¤</button>
            </div>
        </div>
    </div>
</div>

<!-- Sync Modal -->
<div id="syncModal" class="modal-backdrop">
    <div class="modal">
        <h3>åŒæ­¥æ•£å®¢æ•°æ®</h3>
        <p style="color:#666; font-size:14px; margin-bottom:16px">
            å°†ä»è®¾å¤‡åŸå§‹è®°å½•ä¸­ç”Ÿæˆâ€œæ•£å®¢è®¿é—®â€æ•°æ®ã€‚<br>
            è§„åˆ™ï¼šæ¯30åˆ†é’Ÿèšåˆä¸€æ¬¡ï¼Œæ´»åŠ¨åç§°ä¸ºâ€œæ•£å®¢â€ï¼Œç±»å‹ä¸ºâ€œæ•£å®¢è®¿é—®â€ã€‚
        </p>
        <div style="margin-bottom:16px">
            <label>é€‰æ‹©æ—¥æœŸ</label>
            <input type="date" id="syncDate" class="input" style="width:100%">
        </div>
        <div class="actions" style="display:flex; justify-content:flex-end; gap:10px">
            <button class="btn" id="syncCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="syncConfirm">å¼€å§‹åŒæ­¥</button>
        </div>
    </div>
</div>

<script src="/static/layout.js?v=auth_v4"></script>
<script>
    initLayout('ä¹¦é™¢æ•°æ®');

    let _xlsxLoading = null;
    function ensureXLSXLoaded() {
        if (window.XLSX) return Promise.resolve();
        if (_xlsxLoading) return _xlsxLoading;
        _xlsxLoading = new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            s.onload = () => resolve();
            s.onerror = () => reject(new Error('SheetJS åŠ è½½å¤±è´¥'));
            document.head.appendChild(s);
        });
        return _xlsxLoading;
    }
    
    const state = {
        page: 1,
        pageSize: 50
    };
    
    const els = {
        start: document.getElementById('start'),
        end: document.getElementById('end'),
        tbl: document.getElementById('tbl'),
        total: document.getElementById('totalCount'),
        pageInfo: document.getElementById('pageInfo'),
        fileInput: document.getElementById('fileInput'),
        syncDate: document.getElementById('syncDate')
    };
    
    // Init Date
    const now = new Date();
    const ymd = now.toISOString().split('T')[0];
    if (els.start.value && !els.end.value) {
        els.end.value = els.start.value;
    } else if (!els.start.value && els.end.value) {
        els.start.value = els.end.value;
    } else if (els.start.value && els.end.value && els.end.value < els.start.value) {
        const tmp = els.start.value;
        els.start.value = els.end.value;
        els.end.value = tmp;
    }
    if (els.syncDate && !els.syncDate.value) {
        els.syncDate.value = ymd;
    }
    
    const datePicker = {
        btn: document.getElementById('dateRangeBtn'),
        label: document.getElementById('dateRangeLabel'),
        popup: document.getElementById('dateRangePopup'),
        grid: document.getElementById('calGrid'),
        yearSel: document.getElementById('calYear'),
        monthSel: document.getElementById('calMonth'),
        prev: document.getElementById('calPrev'),
        next: document.getElementById('calNext'),
        apply: document.getElementById('dateRangeApply'),
        clear: document.getElementById('dateRangeClear'),
        quickToday: document.getElementById('quickToday'),
        quickLast7: document.getElementById('quickLast7'),
        quickWeek: document.getElementById('quickWeek'),
        quickMonth: document.getElementById('quickMonth')
    };

    let calViewYear = new Date().getFullYear();
    let calViewMonth = new Date().getMonth();
    let calPickStart = '';
    let calPickEnd = '';

    function pad2(n) { return String(n).padStart(2, '0'); }
    function localYmd(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
    function parseYmd(s) {
        const parts = String(s || '').split('-').map(x => parseInt(x, 10));
        if (parts.length !== 3 || parts.some(n => Number.isNaN(n))) return null;
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    function daysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
    function mondayIndex(jsDay) { return (jsDay + 6) % 7; }
    function clampRange(a, b) {
        const s = a || '';
        const e = b || '';
        if (s && e && e < s) return [e, s];
        return [s, e];
    }
    function setRange(start, end) {
        const [s, e] = clampRange(start, end);
        els.start.value = s;
        els.end.value = e;
        updateDateLabel();
        renderCalendar();
    }
    function getRange() {
        const [s, e] = clampRange(els.start.value, els.end.value);
        return { start: s, end: e };
    }
    function updateDateLabel() {
        const { start, end } = getRange();
        if (start && end) {
            datePicker.label.textContent = `${start} è‡³ ${end}`;
            datePicker.label.classList.remove('text-muted');
        } else if (start) {
            datePicker.label.textContent = start;
            datePicker.label.classList.remove('text-muted');
        } else {
            datePicker.label.textContent = 'é€‰æ‹©æ—¥æœŸèŒƒå›´';
            datePicker.label.classList.add('text-muted');
        }
    }
    function syncCalViewFromSelection() {
        const { end, start } = getRange();
        const base = parseYmd(end || start) || new Date();
        calViewYear = base.getFullYear();
        calViewMonth = base.getMonth();
    }
    function ensureCalSelectors() {
        const nowY = new Date().getFullYear();
        const minY = nowY - 5;
        const maxY = nowY + 2;
        const years = [];
        for (let y = minY; y <= maxY; y++) years.push(y);
        if (datePicker.yearSel) {
            datePicker.yearSel.innerHTML = years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
        }
        if (datePicker.monthSel) {
            datePicker.monthSel.innerHTML = Array.from({ length: 12 }, (_, i) => `<option value="${i}">${i + 1}æœˆ</option>`).join('');
        }
    }
    function renderCalendar() {
        const wds = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
        const { start, end } = getRange();
        if (datePicker.yearSel && datePicker.monthSel) {
            if (!datePicker.yearSel.options.length || !datePicker.monthSel.options.length) ensureCalSelectors();
            datePicker.yearSel.value = String(calViewYear);
            datePicker.monthSel.value = String(calViewMonth);
        }
        datePicker.grid.innerHTML = '';

        for (const wd of wds) {
            const el = document.createElement('div');
            el.className = 'cal-wd';
            el.textContent = wd;
            datePicker.grid.appendChild(el);
        }

        const first = new Date(calViewYear, calViewMonth, 1);
        const lead = mondayIndex(first.getDay());
        for (let i = 0; i < lead; i++) {
            const el = document.createElement('div');
            datePicker.grid.appendChild(el);
        }

        const dim = daysInMonth(calViewYear, calViewMonth);
        for (let day = 1; day <= dim; day++) {
            const d = new Date(calViewYear, calViewMonth, day);
            const ds = localYmd(d);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'cal-day';
            btn.textContent = String(day);

            const inRange = start && end && ds >= start && ds <= end;
            const isSelected = (start && ds === start) || (end && ds === end);
            if (inRange) btn.classList.add('in-range');
            if (isSelected) btn.classList.add('selected');

            btn.addEventListener('click', () => {
                if (!calPickStart || (calPickStart && calPickEnd)) {
                    calPickStart = ds;
                    calPickEnd = '';
                    setRange(calPickStart, '');
                    return;
                }
                calPickEnd = ds;
                const [s, e] = clampRange(calPickStart, calPickEnd);
                setRange(s, e);
            });

            datePicker.grid.appendChild(btn);
        }
    }
    
    function setupDatePopup() {
        datePicker.btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const { start, end } = getRange();
            calPickStart = start;
            calPickEnd = end;
            syncCalViewFromSelection();
            ensureCalSelectors();
            renderCalendar();
            datePicker.popup.classList.toggle('show');
        });
        datePicker.popup.addEventListener('click', (e) => e.stopPropagation());
        document.addEventListener('click', () => datePicker.popup.classList.remove('show'));
    }

    datePicker.prev.addEventListener('click', () => {
        if (calViewMonth === 0) {
            calViewMonth = 11;
            calViewYear -= 1;
        } else {
            calViewMonth -= 1;
        }
        renderCalendar();
    });
    datePicker.next.addEventListener('click', () => {
        if (calViewMonth === 11) {
            calViewMonth = 0;
            calViewYear += 1;
        } else {
            calViewMonth += 1;
        }
        renderCalendar();
    });
    datePicker.clear.addEventListener('click', () => {
        calPickStart = '';
        calPickEnd = '';
        setRange('', '');
    });
    if (datePicker.yearSel) {
        datePicker.yearSel.addEventListener('change', () => {
            calViewYear = parseInt(datePicker.yearSel.value, 10);
            renderCalendar();
        });
    }
    if (datePicker.monthSel) {
        datePicker.monthSel.addEventListener('change', () => {
            calViewMonth = parseInt(datePicker.monthSel.value, 10);
            renderCalendar();
        });
    }
    datePicker.apply.addEventListener('click', () => {
        const { start, end } = getRange();
        if (start && !end) setRange(start, start);
        datePicker.popup.classList.remove('show');
    });
    datePicker.quickToday.addEventListener('click', () => {
        const d = localYmd(new Date());
        calPickStart = d;
        calPickEnd = d;
        setRange(d, d);
        datePicker.popup.classList.remove('show');
    });
    datePicker.quickLast7.addEventListener('click', () => {
        const now = new Date();
        const end = localYmd(now);
        const start = localYmd(new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6));
        calPickStart = start;
        calPickEnd = end;
        setRange(start, end);
        datePicker.popup.classList.remove('show');
    });
    datePicker.quickWeek.addEventListener('click', () => {
        const now = new Date();
        const day = mondayIndex(now.getDay());
        const startD = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
        const endD = new Date(startD.getFullYear(), startD.getMonth(), startD.getDate() + 6);
        const start = localYmd(startD);
        const end = localYmd(endD);
        calPickStart = start;
        calPickEnd = end;
        setRange(start, end);
        datePicker.popup.classList.remove('show');
    });
    datePicker.quickMonth.addEventListener('click', () => {
        const now = new Date();
        const startD = new Date(now.getFullYear(), now.getMonth(), 1);
        const endD = new Date(now.getFullYear(), now.getMonth(), daysInMonth(now.getFullYear(), now.getMonth()));
        const start = localYmd(startD);
        const end = localYmd(endD);
        calPickStart = start;
        calPickEnd = end;
        setRange(start, end);
        datePicker.popup.classList.remove('show');
    });

    updateDateLabel();
    syncCalViewFromSelection();
    ensureCalSelectors();
    renderCalendar();
    setupDatePopup();

    async function loadData() {
        if (els.start.value && !els.end.value) {
            els.end.value = els.start.value;
        } else if (!els.start.value && els.end.value) {
            els.start.value = els.end.value;
        } else if (els.start.value && els.end.value && els.end.value < els.start.value) {
            const tmp = els.start.value;
            els.start.value = els.end.value;
            els.end.value = tmp;
        }
        updateDateLabel();

        const q = new URLSearchParams({
            page: String(state.page),
            page_size: String(state.pageSize)
        });
        if (els.start.value) q.append('start_date', els.start.value);
        if (els.end.value) q.append('end_date', els.end.value);
        
        try {
            const res = await fetch('/api/v1/activity/list?' + q);
            if (!res.ok) {
                const msg = await res.text();
                throw new Error(msg || `HTTP ${res.status}`);
            }
            const data = await res.json();
            
            renderTable(data.items);
            els.total.textContent = data.total;
            els.pageInfo.textContent = `${state.page} / ${Math.ceil(data.total / state.pageSize) || 1}`;
        } catch(e) {
            console.error(e);
            showAlert('åŠ è½½å¤±è´¥');
        }
    }
    
    function renderTable(items) {
        if(!items || items.length === 0) {
            els.tbl.innerHTML = '<tr><td colspan="13" style="text-align:center;color:#999">æš‚æ— æ•°æ®</td></tr>';
            return;
        }
        
        els.tbl.innerHTML = items.map((item, idx) => {
            // Duration Calc
            let durStr = '-';
            if (item.duration_minutes) {
                const h = Math.floor(item.duration_minutes / 60);
                const m = item.duration_minutes % 60;
                durStr = (h > 0 ? h + 'æ—¶' : '') + m + 'åˆ†';
            }
            
            return `
            <tr>
                <td>${(state.page-1)*state.pageSize + idx + 1}</td>
                <td>${item.date}</td>
                <td>${item.weekday}</td>
                <td>${item.start_time}</td>
                <td>${item.end_time || '-'}</td>
                <td>${durStr}</td>
                <td><span class="badge badge-academy">${item.academy || '-'}</span></td>
                <td>${item.location || '-'}</td>
                <td>${item.activity_name || '-'}</td>
                <td><span class="badge badge-type">${item.activity_type || '-'}</span></td>
                <td>${item.audience_count}</td>
                <td>${item.notes || ''}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">åˆ é™¤</button>
                </td>
            </tr>
            `;
        }).join('');
    }
    
    // Pagination
    document.getElementById('prevPage').addEventListener('click', () => {
        if(state.page > 1) { state.page--; loadData(); }
    });
    document.getElementById('nextPage').addEventListener('click', () => {
        state.page++; loadData();
    });
    document.getElementById('query').addEventListener('click', () => {
        state.page = 1;
        if (els.start.value && !els.end.value) {
            els.end.value = els.start.value;
        } else if (!els.start.value && els.end.value) {
            els.start.value = els.end.value;
        } else if (els.start.value && els.end.value && els.end.value < els.start.value) {
            const tmp = els.start.value;
            els.start.value = els.end.value;
            els.end.value = tmp;
        }
        loadData();
    });
    
    // Import Logic (Wizard)
    const wizard = {
        step: 1,
        file: null,
        data: [],
        duplicates: [],
        CHUNK_SIZE: 500,
        
        el: {
            modal: document.getElementById('importModal'),
            steps: document.querySelectorAll('.step-item'),
            panes: document.querySelectorAll('.step-pane'),
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            btnCancel: document.getElementById('importCancel'),
            btnPrev: document.getElementById('btnPrev'),
            btnNext: document.getElementById('btnNext'),
            btnFinish: document.getElementById('btnFinish'),
            btnSkip: document.getElementById('btnSkip'),
            btnOverwrite: document.getElementById('btnOverwrite'),
            // Preview
            previewTotal: document.getElementById('previewTotal'),
            previewDateRange: document.getElementById('previewDateRange'),
            previewHeader: document.getElementById('previewHeader'),
            previewBody: document.getElementById('previewBody'),
            // Progress
            progressRing: document.querySelector('.progress-ring'),
            progressPercent: document.getElementById('progressPercent'),
            progressStatus: document.getElementById('progressStatus'),
            progressCount: document.getElementById('progressCount'),
            progressTime: document.getElementById('progressTime')
        },

        init() {
            // Open/Close
            document.getElementById('btnImport').addEventListener('click', () => this.open());
            this.el.btnCancel.addEventListener('click', () => this.close());
            
            // Navigation
            this.el.btnNext.addEventListener('click', () => this.next());
            this.el.btnPrev.addEventListener('click', () => this.prev());
            this.el.btnFinish.addEventListener('click', () => this.close());
            
            // Duplicate handling
            this.el.btnSkip.addEventListener('click', () => this.finishImport());
            this.el.btnOverwrite.addEventListener('click', () => this.overwriteDuplicates());

            // File Input
            this.el.dropZone.addEventListener('click', () => this.el.fileInput.click());
            this.el.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
            
            // Drag & Drop
            this.el.dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                this.el.dropZone.classList.add('dragover');
            });
            this.el.dropZone.addEventListener('dragleave', () => {
                this.el.dropZone.classList.remove('dragover');
            });
            this.el.dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                this.el.dropZone.classList.remove('dragover');
                if(e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]);
            });
        },

        open() {
            this.reset();
            this.el.modal.classList.add('show');
        },

        close() {
            this.el.modal.classList.remove('show');
            if(this.step === 3 && (this.data.length > 0 || this.duplicates.length > 0)) {
                loadData();
            }
        },

        reset() {
            this.step = 1;
            this.file = null;
            this.data = [];
            this.duplicates = [];
            this.el.fileInput.value = '';
            this.el.fileInfo.classList.add('hidden');
            this.el.dropZone.classList.remove('hidden');
            this.el.btnNext.disabled = true;
            this.el.btnSkip.classList.add('hidden');
            this.el.btnOverwrite.classList.add('hidden');
            this.renderStep();
        },

        renderStep() {
            this.el.steps.forEach(s => {
                const sNum = parseInt(s.dataset.step);
                s.classList.toggle('active', sNum <= this.step);
            });

            this.el.panes.forEach(p => p.classList.remove('active'));
            document.getElementById(`step${this.step}`).classList.add('active');

            this.el.btnPrev.classList.toggle('hidden', this.step === 1 || this.step === 3);
            this.el.btnNext.classList.toggle('hidden', this.step === 3);
            this.el.btnFinish.classList.toggle('hidden', true); // Hide finish until done
            this.el.btnCancel.classList.toggle('hidden', this.step === 3); // Hide cancel initially in step 3

            if (this.step === 1) {
                this.el.btnNext.disabled = !this.file;
            } else if (this.step === 2) {
                this.el.btnNext.disabled = false;
            } else if (this.step === 3) {
                this.startImport();
            }
        },

        handleFile(file) {
            if(!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            if(!['xlsx', 'xls', 'csv'].includes(ext)) {
                showAlert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                return;
            }

            this.file = file;
            this.el.dropZone.classList.add('hidden');
            this.el.fileInfo.classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            this.el.btnNext.disabled = false;
        },

        async next() {
            if(this.step === 1) {
                try {
                    this.el.btnNext.disabled = true;
                    this.el.btnNext.textContent = "è§£æä¸­...";
                    await this.parseFile();
                    this.el.btnNext.textContent = "ä¸‹ä¸€æ­¥";
                } catch(e) {
                    this.el.btnNext.disabled = false;
                    this.el.btnNext.textContent = "ä¸‹ä¸€æ­¥";
                    return;
                }
            }
            this.step++;
            this.renderStep();
        },

        prev() {
            this.step--;
            this.renderStep();
        },

        async parseFile() {
            try {
                await ensureXLSXLoaded();
            } catch (e) {
                showAlert('è§£æç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                throw e;
            }
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, {type: 'binary', cellDates: true});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: "", cellDates: true});
                        this.processData(jsonData);
                        resolve();
                    } catch(err) {
                        showAlert('è§£æå¤±è´¥: ' + err.message);
                        reject(err);
                    }
                };
                reader.readAsBinaryString(this.file);
            });
        },

        processData(rows) {
            this.data = rows.map(row => {
                const getVal = (keys) => {
                    for(let k of keys) if(row[k] !== undefined) return row[k];
                    return '';
                };

                // Date Parsing
                let rawDate = getVal(['å¹´/æœˆ/æ—¥', 'Date', 'æ—¥æœŸ']);
                let dateStr = '';
                
                if (rawDate instanceof Date) {
                    const y = rawDate.getFullYear();
                    const m = String(rawDate.getMonth() + 1).padStart(2, '0');
                    const d = String(rawDate.getDate()).padStart(2, '0');
                    dateStr = `${y}-${m}-${d}`;
                } else if (typeof rawDate === 'number') {
                    // Excel Serial Date (approximate)
                    // Excel base date: Dec 30, 1899
                    const d = new Date(1899, 11, 30);
                    d.setDate(d.getDate() + Math.floor(rawDate));
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dateStr = `${y}-${m}-${day}`;
                } else if (rawDate) {
                    const str = String(rawDate).trim();
                    if (/^\d{5}(\.\d+)?$/.test(str)) {
                        // Handle stringified serial number
                        const num = parseFloat(str);
                        const d = new Date(1899, 11, 30);
                        d.setDate(d.getDate() + Math.floor(num));
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        dateStr = `${y}-${m}-${day}`;
                    } else {
                        // Standard string
                        dateStr = str.split(' ')[0].replace(/\//g, '-');
                     }
                 }

                 const formatTime = (val) => {
                    if(!val) return '';
                    if(val instanceof Date) {
                        const h = String(val.getHours()).padStart(2, '0');
                        const m = String(val.getMinutes()).padStart(2, '0');
                        return `${h}:${m}`;
                    }
                    if(typeof val === 'number') {
                        // Excel fractional day
                        const totalSeconds = Math.round(val * 86400);
                        const h = Math.floor(totalSeconds / 3600) % 24;
                        const m = Math.floor((totalSeconds % 3600) / 60);
                        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    }
                    return String(val).trim();
                 };

                 const startTime = formatTime(getVal(['èµ·å§‹æ—¶é—´', 'Start']));
                 const endTime = formatTime(getVal(['ç»“æŸæ—¶é—´', 'End']));
                 
                 let duration = 0;
                const durRaw = String(getVal(['æ—¶é•¿', 'Duration']) || '');
                if(durRaw.includes('æ—¶')) {
                    const parts = durRaw.split('æ—¶');
                    const h = parseInt(parts[0]) || 0;
                    const m = parseInt(parts[1]?.replace('åˆ†','')) || 0;
                    duration = h*60 + m;
                } else if(durRaw.includes('åˆ†')) {
                    duration = parseInt(durRaw.replace('åˆ†','')) || 0;
                } else if(durRaw.match(/^\d+$/)) {
                    duration = parseInt(durRaw);
                } else {
                    if(startTime && endTime && dateStr) {
                        try {
                            const t1 = new Date(`2000/01/01 ${startTime}`);
                            const t2 = new Date(`2000/01/01 ${endTime}`);
                            duration = (t2 - t1) / 1000 / 60;
                        } catch(e){}
                    }
                }

                return {
                    date: dateStr,
                    weekday: String(getVal(['å‘¨å‡ ', 'Weekday']) || ''),
                    start_time: startTime,
                    end_time: endTime,
                    duration_minutes: duration || 0,
                    academy: String(getVal(['ä¹¦é™¢', 'Academy']) || ''),
                    location: String(getVal(['å…·ä½“åœ°ç‚¹', 'Location']) || ''),
                    activity_name: String(getVal(['æ´»åŠ¨åç§°', 'Activity Name']) || ''),
                    activity_type: String(getVal(['æ´»åŠ¨ç±»å‹', 'Activity Type']) || ''),
                    audience_count: parseInt(getVal(['å—ä¼—å­¦ç”Ÿæ•°', 'Audience']) || 0),
                    notes: String(getVal(['å¤‡æ³¨', 'Remarks']) || '')
                };
            }).filter(d => d.date && d.date !== 'undefined');

            this.el.previewTotal.textContent = this.data.length;
            if(this.data.length > 0) {
                const dates = this.data.map(d => d.date).sort();
                this.el.previewDateRange.textContent = `${dates[0]} - ${dates[dates.length-1]}`;
            }
            
            const headers = ['æ—¥æœŸ', 'ä¹¦é™¢', 'åœ°ç‚¹', 'æ´»åŠ¨', 'äººæ•°'];
            this.el.previewHeader.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            
            this.el.previewBody.innerHTML = this.data.slice(0, 5).map(d => `
                <tr>
                    <td>${d.date}</td>
                    <td>${d.academy}</td>
                    <td>${d.location}</td>
                    <td>${d.activity_name}</td>
                    <td>${d.audience_count}</td>
                </tr>
            `).join('');
        },

        async startImport() {
            const total = this.data.length;
            let imported = 0;
            this.duplicates = [];
            const startTime = Date.now();

            this.el.progressStatus.textContent = "æ­£åœ¨å¯¼å…¥...";
            this.el.progressStatus.style.color = "#2b2d42";
            this.el.btnSkip.classList.add('hidden');
            this.el.btnOverwrite.classList.add('hidden');
            this.el.btnFinish.classList.add('hidden');

            for(let i=0; i<total; i+=this.CHUNK_SIZE) {
                const chunk = this.data.slice(i, i+this.CHUNK_SIZE);
                try {
                    const res = await fetch('/api/v1/activity/walkin/sync', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({items: chunk, mode: 'skip'})
                    });
                    
                    if(!res.ok) throw new Error(await res.text());
                    const json = await res.json();
                    
                    if(json.duplicates && json.duplicates.length > 0) {
                        json.duplicates.forEach(idx => {
                            this.duplicates.push(chunk[idx]);
                        });
                    }
                    
                    imported += chunk.length;
                    
                    const percent = Math.min(100, Math.round((imported / total) * 100));
                    this.el.progressRing.style.setProperty('--percent', percent);
                    this.el.progressPercent.textContent = percent + '%';
                    this.el.progressCount.textContent = `å·²å¤„ç† ${imported} / ${total}`;
                    
                    const elapsed = Date.now() - startTime;
                    if(imported > 0) {
                        const speed = imported / elapsed; 
                        const remaining = total - imported;
                        const etaMs = remaining / speed;
                        this.el.progressTime.textContent = `é¢„è®¡å‰©ä½™æ—¶é—´: ${(etaMs/1000).toFixed(1)}s`;
                    }
                    
                    await new Promise(r => setTimeout(r, 50));
                } catch(err) {
                    this.el.progressStatus.textContent = "å¯¼å…¥å‡ºé”™: " + err.message;
                    this.el.progressStatus.style.color = "#f72585";
                    this.el.btnCancel.classList.remove('hidden');
                    this.el.btnCancel.textContent = "å…³é—­";
                    return;
                }
            }

            if(this.duplicates.length > 0) {
                this.el.progressStatus.textContent = `å‘ç° ${this.duplicates.length} æ¡é‡å¤æ•°æ®`;
                this.el.progressStatus.style.color = "#f57c00";
                this.el.progressTime.textContent = "è¯·é€‰æ‹©å¤„ç†æ–¹å¼";
                this.el.btnSkip.classList.remove('hidden');
                this.el.btnOverwrite.classList.remove('hidden');
            } else {
                this.finishImport();
            }
        },

        async overwriteDuplicates() {
            const total = this.duplicates.length;
            if(total === 0) return this.finishImport();
            
            this.el.progressStatus.textContent = "æ­£åœ¨è¦†ç›–é‡å¤æ•°æ®...";
            this.el.progressStatus.style.color = "#2b2d42";
            this.el.btnSkip.classList.add('hidden');
            this.el.btnOverwrite.classList.add('hidden');
            
            let processed = 0;
            
            for(let i=0; i<total; i+=this.CHUNK_SIZE) {
                const chunk = this.duplicates.slice(i, i+this.CHUNK_SIZE);
                try {
                     const res = await fetch('/api/v1/activity/walkin/sync', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({items: chunk, mode: 'overwrite'})
                    });
                    
                    if(!res.ok) throw new Error(await res.text());
                    
                    processed += chunk.length;
                    const percent = Math.min(100, Math.round((processed / total) * 100));
                    this.el.progressRing.style.setProperty('--percent', percent);
                    this.el.progressPercent.textContent = percent + '%';
                    this.el.progressCount.textContent = `è¦†ç›–è¿›åº¦ ${processed} / ${total}`;
                    
                } catch(err) {
                    this.el.progressStatus.textContent = "è¦†ç›–å‡ºé”™: " + err.message;
                    this.el.progressStatus.style.color = "#f72585";
                    this.el.btnCancel.classList.remove('hidden');
                    return;
                }
            }
            
            this.finishImport();
        },

        finishImport() {
            this.el.progressStatus.textContent = "å¯¼å…¥å®Œæˆ!";
            this.el.progressStatus.style.color = "#4cc9f0";
            this.el.progressTime.textContent = "";
            this.el.btnFinish.classList.remove('hidden');
            this.el.btnCancel.classList.add('hidden');
            this.el.btnSkip.classList.add('hidden');
            this.el.btnOverwrite.classList.add('hidden');
            loadData();
        }
    };
    wizard.init();
    
    // Sync Logic
    const syncModal = document.getElementById('syncModal');
    document.getElementById('btnSync').addEventListener('click', () => syncModal.classList.add('show'));
    document.getElementById('syncCancel').addEventListener('click', () => syncModal.classList.remove('show'));
    
    document.getElementById('syncConfirm').addEventListener('click', async () => {
        const date = els.syncDate.value;
        if(!date) return showAlert('è¯·é€‰æ‹©æ—¥æœŸ');
        
        try {
            const res = await fetch('/api/v1/activity/sync-visitors', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({date: date})
            });
            const json = await res.json();
            if(res.ok) {
                showAlert(`åŒæ­¥æˆåŠŸï¼Œç”Ÿæˆ ${json.count} æ¡è®°å½•`);
                syncModal.classList.remove('show');
                loadData();
            } else {
                showAlert('åŒæ­¥å¤±è´¥: ' + json.detail);
            }
        } catch(e) {
            showAlert('è¯·æ±‚é”™è¯¯');
        }
    });
    
    window.deleteItem = async (id) => {
        if(await showConfirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•å—ï¼Ÿ')) {
            await fetch(`/api/v1/activity/${id}`, { method: 'DELETE' });
            loadData();
        }
    };
    
    loadData();
</script>
</body>
</html>
