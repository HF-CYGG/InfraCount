<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê≥∞Â±±ÁßëÊäÄÂ≠¶Èô¢‰π¶Èô¢ËøêË°å‰ΩøÁî®Áä∂ÊÄÅÊï∞ÊçÆÁúãÊùø</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --bg-color: #f4f6f8;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.04);
            --primary-soft: rgba(34, 139, 230, 0.1);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text);
        }

        .page-header {
            background: var(--card-bg);
            padding: 20px 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .filter-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .filter-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .filter-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }
        
        .filter-header::before {
            content: '';
            display: block;
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
            margin-right: 10px;
        }

        /* Academy Pills */
        .academy-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .academy-pill {
            padding: 6px 16px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
            font-weight: 500;
        }
        .academy-pill:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-soft);
        }
        .academy-pill.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(34, 139, 230, 0.3);
        }
        
        /* Tags (Activity Types) */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .tag {
            padding: 6px 14px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
        }
        .tag:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .tag.active {
            background: var(--primary-soft);
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }
        
        /* Time Grid */
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
        }
        .time-item {
            text-align: center;
            padding: 8px 4px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            background: #fff;
            color: #495057;
            transition: all 0.2s;
        }
        .time-item:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .time-item.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Week List */
        .week-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .week-item {
            padding: 10px 14px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-item:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-soft);
        }
        .week-item.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(34, 139, 230, 0.3);
        }

        /* Location Grid */
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .location-item {
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            color: #495057;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.2s;
        }
        .location-item:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .location-item.active {
            background: var(--primary-soft);
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }
        
        /* Results Section */
        .results-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        .activity-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .activity-table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 14px 16px;
            text-align: left;
            border-bottom: 2px solid #e9ecef;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .activity-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f3f5;
            color: #343a40;
            font-size: 14px;
        }
        .activity-table tr:last-child td {
            border-bottom: none;
        }
        .activity-table tr:hover td {
            background: #f8f9fa;
        }
        
        /* Badges */
        .badge-custom {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-academy {
            background: #e7f5ff;
            color: #1c7ed6;
        }
        .badge-type {
            background: #fff9db;
            color: #f08c00;
        }
    </style>
</head>
<body>

<div class="page-header">
    <h1 class="page-title">
        <span>üèõÔ∏è</span> ‰π¶Èô¢ËøêË°åÁä∂ÊÄÅÁúãÊùø
    </h1>
    <div style="display:flex;align-items:center;gap:12px">
        <label style="font-weight:600; font-size:14px; color:var(--text-secondary)">ÁªüËÆ°Êúà‰ªΩ</label>
        <input type="month" id="monthPicker" class="input" style="width:180px; font-size:14px; border-radius:6px; border-color:#e9ecef">
    </div>
</div>

<div class="filter-container">
    <div class="filter-main">
        <!-- Academies -->
        <div class="filter-card">
            <div class="filter-header">‰π¶Èô¢ÂàÜÁ±ª</div>
            <div class="academy-grid" id="academyList">
                <!-- JS Populated -->
            </div>
        </div>
        
        <div class="grid" style="display:grid;grid-template-columns: 200px 1fr; gap:20px">
            <!-- Weekdays -->
            <div class="filter-card">
                <div class="filter-header">Âë®Âá†</div>
                <div class="week-list" id="weekdayList" style="flex-direction: column; gap: 6px;">
                    <div class="week-item" data-val="1"><span>Âë®‰∏Ä</span> <span>‚Üí</span></div>
                    <div class="week-item" data-val="2"><span>Âë®‰∫å</span> <span>‚Üí</span></div>
                    <div class="week-item" data-val="3"><span>Âë®‰∏â</span> <span>‚Üí</span></div>
                    <div class="week-item" data-val="4"><span>Âë®Âõõ</span> <span>‚Üí</span></div>
                    <div class="week-item" data-val="5"><span>Âë®‰∫î</span> <span>‚Üí</span></div>
                    <div class="week-item" data-val="6"><span>Âë®ÂÖ≠</span> <span>‚Üí</span></div>
                    <div class="week-item" data-val="7"><span>Âë®Êó•</span> <span>‚Üí</span></div>
                </div>
            </div>
            
            <!-- Start Time -->
            <div class="filter-card">
                <div class="filter-header">Ëµ∑ÂßãÊó∂Èó¥</div>
                <div class="time-grid" id="timeList">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>

        <!-- Activity Types -->
        <div class="filter-card">
            <div class="filter-header">Ê¥ªÂä®Á±ªÂûã</div>
            <div class="tag-list" id="typeList">
                <!-- JS Populated -->
            </div>
        </div>
        
        <!-- Locations -->
        <div class="filter-card">
            <div class="filter-header">ÂÖ∑‰ΩìÂú∞ÁÇπ</div>
            <div class="location-grid" id="locationList">
                <!-- JS Populated -->
            </div>
        </div>
    </div>
    
    <!-- Right Column: Date Ranges -->
    <div class="filter-main">
        <div class="filter-card" style="position:sticky; top:20px">
            <div class="filter-header">Âë®Ê¨° / Êó•ÊúüËåÉÂõ¥</div>
            <div class="week-list" id="dateRangeList">
                <!-- JS Populated -->
            </div>
        </div>
    </div>
</div>

<div class="results-section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <h3 style="margin:0; font-size:18px; font-weight:700; display:flex; align-items:center; gap:10px">
            Ê¥ªÂä®ÂàóË°® 
            <span class="badge-custom" style="background:#e9ecef; color:#495057" id="resultCount">0</span>
        </h3>
    </div>
    <div class="table-wrap">
        <table class="activity-table">
            <thead>
                <tr>
                    <th>Êó•Êúü</th>
                    <th>Êó∂Èó¥</th>
                    <th>‰π¶Èô¢</th>
                    <th>Ê¥ªÂä®ÂêçÁß∞</th>
                    <th>Á±ªÂûã</th>
                    <th>Âú∞ÁÇπ</th>
                    <th>‰∫∫Êï∞</th>
                </tr>
            </thead>
            <tbody id="resultTable"></tbody>
        </table>
    </div>
    <div style="text-align:center;margin-top:16px">
        <button class="btn" id="loadMore" style="display:none">Âä†ËΩΩÊõ¥Â§ö</button>
    </div>
</div>

<script src="/static/layout.js"></script>
<script>
    initLayout('‰π¶Èô¢ÁúãÊùø');

    // State
    const state = {
        month: new Date().toISOString().slice(0, 7), // YYYY-MM
        filters: {
            academies: new Set(),
            weekdays: new Set(),
            minTime: null,
            dateRange: null, // {start, end}
            types: new Set(),
            locations: new Set()
        },
        page: 1,
        hasMore: true
    };

    const els = {
        monthPicker: document.getElementById('monthPicker'),
        academyList: document.getElementById('academyList'),
        weekdayList: document.getElementById('weekdayList'),
        timeList: document.getElementById('timeList'),
        typeList: document.getElementById('typeList'),
        dateRangeList: document.getElementById('dateRangeList'),
        locationList: document.getElementById('locationList'),
        resultTable: document.getElementById('resultTable'),
        resultCount: document.getElementById('resultCount'),
        loadMore: document.getElementById('loadMore')
    };

    // Init
    async function init() {
        // Init Date
        els.monthPicker.value = state.month;
        
        // Load Options
        const [optRes, acaRes] = await Promise.all([
            fetch('/api/v1/activity/options'),
            fetch('/api/v1/academies')
        ]);
        const opts = await optRes.json();
        const acaList = await acaRes.json();
        
        // Use academies from registry
        const academyNames = acaList.map(a => a.name);
        
        // Fixed Activity Types
        const fixedTypes = [
            "Áè≠Âõ¢Ê¥ªÂä®", "ÂÖ¨Áõä/ÂøóÊÑøÊ¥ªÂä®", "‰ºöËÆÆÊ¥ªÂä®", "ÂüπËÆ≠Ê¥ªÂä®", "ÂÖ∂‰ªñÊ¥ªÂä®", 
            "ÂÖ®ÁîüÂºÇÁßëÂØºÂ∏àÊ¥ªÂä®", "Êï£ÂÆ¢ËÆøÈóÆ", "Á§æÂõ¢Ê¥ªÂä®", "‰π¶Èô¢Ê¥ªÂä®", 
            "‰ΩìËÇ≤Ê¥ªÂä®", "È°πÁõÆÂ∑•ÂùäÊ¥ªÂä®", "Ëâ∫ÊúØÊ¥ªÂä®", "È°πÁõÆÂ∑•Âùä"
        ];
        
        renderOptions(els.academyList, academyNames, 'academies', 'academy-pill');
        renderOptions(els.typeList, fixedTypes, 'types', 'tag');
        renderOptions(els.locationList, opts.locations, 'locations', 'location-item');
        
        renderTimes();
        renderDateRanges();
        
        // Event Listeners
        els.monthPicker.addEventListener('change', (e) => {
            if(e.target.value) {
                state.month = e.target.value;
                state.filters.dateRange = null; // Reset date range when month changes
                renderDateRanges();
                reload();
            }
        });

        // Weekday Listeners
        document.querySelectorAll('#weekdayList .week-item').forEach(el => {
            el.addEventListener('click', () => {
                const val = el.dataset.val;
                toggleFilter('weekdays', val);
                el.classList.toggle('active');
                reload();
            });
        });
        
        els.loadMore.addEventListener('click', () => {
            state.page++;
            loadData(true);
        });

        // Initial Load
        reload();
    }

    function renderOptions(container, items, filterKey, className) {
        container.innerHTML = items.map(item => `
            <div class="${className}" data-val="${item}">${item}</div>
        `).join('');
        
        container.querySelectorAll('.' + className.split(' ')[0]).forEach(el => {
            el.addEventListener('click', () => {
                const val = el.dataset.val;
                toggleFilter(filterKey, val);
                el.classList.toggle('active');
                reload();
            });
        });
    }

    function renderTimes() {
        const times = [];
        let h = 5, m = 30;
        while(h < 22 || (h===22 && m===0)) {
            const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            times.push(timeStr);
            m += 30;
            if(m === 60) { h++; m = 0; }
        }
        
        els.timeList.innerHTML = times.map(t => `
            <div class="time-item" data-val="${t}">${t}</div>
        `).join('');
        
        els.timeList.querySelectorAll('.time-item').forEach(el => {
            el.addEventListener('click', () => {
                // Single select logic for time? "Activities after selected time"
                // If clicked again, deselect?
                const val = el.dataset.val;
                
                // Clear others
                els.timeList.querySelectorAll('.time-item').forEach(i => i.classList.remove('active'));
                
                if(state.filters.minTime === val) {
                    state.filters.minTime = null; // Toggle off
                } else {
                    state.filters.minTime = val;
                    el.classList.add('active');
                }
                reload();
            });
        });
    }

    function renderDateRanges() {
        // Split selected month into weeks
        const [y, m] = state.month.split('-').map(Number);
        const ranges = [];
        
        // Get first day of month
        let curr = new Date(y, m-1, 1);
        const endMonth = new Date(y, m, 0); // Last day of month
        
        while(curr <= endMonth) {
            // Start of "week" (or segment)
            let start = new Date(curr);
            
            // Find end of week (Sunday) or End of Month
            // Day 0 is Sunday, 1 is Mon... 
            // We want chunks. Let's say we split by 7 days or standard weeks?
            // User: "ÊØè‰∏ÄÂë®‰∏∫‰∏Ä‰∏™ÈÄâÊã©Êó∂Èó¥ÊÆµÔºå‰∏çË∂≥‰∏ÄÂë®ÁöÑ‰πüË¶ÅÂàóÂá∫ÔºàÊ≥®ÊÑè‰∏çË¶ÅË∂ÖÂá∫Êú¨ÊúàÊó•ÊúüÔºâ"
            // Usually standard weeks start on Monday.
            
            let day = curr.getDay(); // 0(Sun) - 6(Sat)
            // Adjust to Monday start: Mon(0) ... Sun(6)
            let diff = 7 - (day === 0 ? 7 : day); // Days remaining in this week (Mon-Sun)
            
            let end = new Date(curr);
            end.setDate(curr.getDate() + diff);
            
            // Cap at end of month
            if(end > endMonth) end = new Date(endMonth);
            
            ranges.push({
                start: fmtDate(start),
                end: fmtDate(end)
            });
            
            // Next loop starts after end
            curr = new Date(end);
            curr.setDate(curr.getDate() + 1);
        }
        
        els.dateRangeList.innerHTML = ranges.map(r => `
            <div class="week-item" data-start="${r.start}" data-end="${r.end}">
                <span>${r.start} - ${r.end}</span>
                <span>‚Üí</span>
            </div>
        `).join('');
        
        els.dateRangeList.querySelectorAll('.week-item').forEach(el => {
            el.addEventListener('click', () => {
                const s = el.dataset.start;
                const e = el.dataset.end;
                
                // Toggle
                els.dateRangeList.querySelectorAll('.week-item').forEach(i => i.classList.remove('active'));
                
                if(state.filters.dateRange && state.filters.dateRange.start === s) {
                    state.filters.dateRange = null;
                } else {
                    state.filters.dateRange = {start: s, end: e};
                    el.classList.add('active');
                }
                reload();
            });
        });
    }

    function fmtDate(d) {
        return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
    }

    function toggleFilter(key, val) {
        if(state.filters[key].has(val)) {
            state.filters[key].delete(val);
        } else {
            state.filters[key].add(val);
        }
    }

    function reload() {
        state.page = 1;
        state.hasMore = true;
        loadData(false);
    }

    async function loadData(append) {
        if(!append) {
            els.resultTable.innerHTML = '';
        }
        
        const q = new URLSearchParams();
        q.append('page', state.page);
        q.append('page_size', 50);
        
        // Date Logic
        // Base range is the whole month unless dateRange is selected
        if(state.filters.dateRange) {
            q.append('start', state.filters.dateRange.start.replace(/\//g, '-'));
            q.append('end', state.filters.dateRange.end.replace(/\//g, '-'));
        } else {
            // Whole month
            const [y, m] = state.month.split('-');
            const lastDay = new Date(y, m, 0).getDate();
            q.append('start', `${state.month}-01`);
            q.append('end', `${state.month}-${lastDay}`);
        }
        
        if(state.filters.academies.size > 0) q.append('academies', Array.from(state.filters.academies).join(','));
        if(state.filters.types.size > 0) q.append('types', Array.from(state.filters.types).join(','));
        if(state.filters.locations.size > 0) q.append('locations', Array.from(state.filters.locations).join(','));
        if(state.filters.weekdays.size > 0) q.append('weekdays', Array.from(state.filters.weekdays).join(','));
        if(state.filters.minTime) q.append('min_time', state.filters.minTime);

        const res = await fetch('/api/v1/activity/list?' + q.toString());
        const data = await res.json();
        
        els.resultCount.textContent = data.total;
        
        if(data.items.length === 0) {
            state.hasMore = false;
            els.loadMore.style.display = 'none';
            if(!append) els.resultTable.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
            return;
        }
        
        const html = data.items.map(i => `
            <tr>
                <td>${i.date} (Âë®${mapWeekday(i.weekday)})</td>
                <td>${i.start_time}-${i.end_time}</td>
                <td><span class="badge-custom badge-academy">${i.academy || '-'}</span></td>
                <td><strong>${i.activity_name}</strong></td>
                <td><span class="badge-custom badge-type">${i.activity_type}</span></td>
                <td>${i.location}</td>
                <td style="font-weight:bold;color:var(--primary)">${i.audience_count}</td>
            </tr>
        `).join('');
        
        if(append) {
            els.resultTable.insertAdjacentHTML('beforeend', html);
        } else {
            els.resultTable.innerHTML = html;
        }
        
        els.loadMore.style.display = data.items.length < 50 ? 'none' : 'inline-block';
    }

    function mapWeekday(wd) {
        // DB might return 'Mon', 'Tue' or '1', '2'. 
        // Or Chinese 'ÊòüÊúü‰∏Ä'.
        // Let's assume standard names or numbers.
        const map = {
            'Mon': '‰∏Ä', 'Tue': '‰∫å', 'Wed': '‰∏â', 'Thu': 'Âõõ', 'Fri': '‰∫î', 'Sat': 'ÂÖ≠', 'Sun': 'Êó•',
            '1': '‰∏Ä', '2': '‰∫å', '3': '‰∏â', '4': 'Âõõ', '5': '‰∫î', '6': 'ÂÖ≠', '7': 'Êó•'
        };
        return map[wd] || wd;
    }

    init();
</script>

</body>
</html>