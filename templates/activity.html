<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦é™¢è¿è¡ŒçŠ¶æ€çœ‹æ¿</title>
    <link rel="stylesheet" href="/static/style.css?v=ui_v1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --primary-light: #eef2ff;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --text-main: #2b2d42;
            --text-secondary: #8d99ae;
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --border-color: #edf2f4;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.05);
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 20px;
        }

        /* Header */
        .page-header {
            background: var(--bg-card);
            padding: 24px 32px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .page-title span {
            font-size: 28px;
        }

        /* Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
            align-items: start;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .card-header::before {
            content: '';
            display: block;
            width: 4px;
            height: 18px;
            background: var(--primary);
            border-radius: 4px;
            margin-right: 12px;
        }

        /* Academy Pills */
        .academy-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .academy-pill {
            padding: 8px 20px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .academy-pill:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #fff;
            transform: translateY(-1px);
        }

        .academy-pill.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        /* Sub Grid for Week/Time */
        .sub-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 24px;
        }

        /* Week Items */
        .week-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .week-item {
            padding: 12px 16px;
            background: var(--bg-body);
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            color: var(--text-main);
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-item:hover {
            background: #fff;
            border-color: var(--primary);
            color: var(--primary);
        }

        .week-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Time Grid */
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
        }

        .time-item {
            text-align: center;
            padding: 10px 4px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            background: var(--bg-body);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .time-item:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #fff;
        }

        .time-item.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* Tags/Types */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tag {
            padding: 8px 16px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            color: var(--text-main);
            transition: all 0.2s;
        }

        .tag:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #fff;
        }

        .tag.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Locations */
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .location-item {
            padding: 10px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-main);
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.2s;
        }

        .location-item:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #fff;
        }

        .location-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Results Table */
        .results-section {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 0;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-top: 24px;
            overflow: hidden;
        }

        .results-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .results-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge-count {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .table-wrap {
            overflow-x: auto;
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th {
            background: #f8f9fa;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 16px 24px;
            text-align: left;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 14px;
        }

        .activity-table tr:last-child td {
            border-bottom: none;
        }

        .activity-table tr:hover td {
            background: #f8f9fa;
        }

        /* Status Badges in Table */
        .badge-table {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-academy {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-type {
            background: #fff3e0;
            color: #f57c00;
        }

        /* Inputs */
        .input-control {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-control:focus {
            border-color: var(--primary);
        }

        .btn-load {
            display: inline-block;
            padding: 10px 30px;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin: 24px 0;
        }

        .btn-load:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
/* Wizard Styles */
        .wizard-modal {
            max-width: 800px;
            width: 90%;
            display: flex;
            flex-direction: column;
            min-height: 500px;
            padding: 0;
            overflow: hidden;
        }

        .wizard-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: #f8f9fa;
        }

        .wizard-header h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
        }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }

        .step-item.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-item.active .step-icon {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: #e9ecef;
            margin: 0 16px;
            margin-bottom: 24px; /* Align with icon center approx */
        }

        .wizard-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            position: relative;
        }

        .step-pane {
            display: none;
            animation: fadeIn 0.3s ease;
            height: 100%;
        }

        .step-pane.active {
            display: block;
        }

        /* Step 1: Drag Drop */
        .drag-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fafbfc;
        }

        .drag-drop-zone:hover, .drag-drop-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .drag-drop-zone .icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-body);
            border-radius: var(--radius-sm);
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        /* Step 2: Preview */
        .data-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-item {
            background: var(--bg-body);
            padding: 16px;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-item label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .summary-item span {
            font-size: 18px;
            font-weight: 600;
        }

        .table-preview-wrap {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            overflow-x: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th, .preview-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Step 3: Progress */
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 24px;
        }

        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring svg {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 8;
        }

        .progress-ring circle:last-child {
            stroke: var(--primary);
            stroke-dasharray: 314; /* 2 * PI * r */
            stroke-dashoffset: calc(314 - (314 * var(--percent)) / 100);
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-ring span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-info {
            text-align: center;
        }

        .wizard-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .step-actions {
            display: flex;
            gap: 12px;
        }

        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>

<div class="page-header">
    <h1 class="page-title">
        ä¹¦é™¢è¿è¡ŒçŠ¶æ€çœ‹æ¿
    </h1>
    <div style="display:flex;align-items:center;gap:16px">
        <label style="font-weight:600; font-size:14px; color:var(--text-secondary)">ç»Ÿè®¡æœˆä»½</label>
        <input type="month" id="monthPicker" class="input-control" style="width:160px;">
        <button class="btn btn-secondary" id="syncWalkinBtn">ğŸ”„ åŒæ­¥æ•£å®¢æ•°æ®</button>
        <button class="btn btn-primary" id="uploadBtn">ğŸ“¤ å¯¼å…¥è¡¨æ ¼</button>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Left Column: Filters -->
    <div class="filter-section">
        <!-- Academies -->
        <div class="card">
            <div class="card-header">ä¹¦é™¢åˆ†ç±»</div>
            <div class="academy-grid" id="academyList">
                <!-- JS Populated -->
            </div>
        </div>
        
        <!-- Weekdays & Time (Sub Grid) -->
        <div class="sub-grid">
            <!-- Weekdays -->
            <div class="card">
                <div class="card-header">æ˜ŸæœŸ</div>
                <div class="week-list" id="weekdayList">
                    <div class="week-item" data-val="1"><span>å‘¨ä¸€</span> <span style="opacity:0.3">â†’</span></div>
                    <div class="week-item" data-val="2"><span>å‘¨äºŒ</span> <span style="opacity:0.3">â†’</span></div>
                    <div class="week-item" data-val="3"><span>å‘¨ä¸‰</span> <span style="opacity:0.3">â†’</span></div>
                    <div class="week-item" data-val="4"><span>å‘¨å››</span> <span style="opacity:0.3">â†’</span></div>
                    <div class="week-item" data-val="5"><span>å‘¨äº”</span> <span style="opacity:0.3">â†’</span></div>
                    <div class="week-item" data-val="6"><span>å‘¨å…­</span> <span style="opacity:0.3">â†’</span></div>
                    <div class="week-item" data-val="7"><span>å‘¨æ—¥</span> <span style="opacity:0.3">â†’</span></div>
                </div>
            </div>
            
            <!-- Start Time -->
            <div class="card">
                <div class="card-header">èµ·å§‹æ—¶é—´</div>
                <div class="time-grid" id="timeList">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>

        <!-- Activity Types -->
        <div class="card">
            <div class="card-header">æ´»åŠ¨ç±»å‹</div>
            <div class="tag-list" id="typeList">
                <!-- JS Populated -->
            </div>
        </div>
        
        <!-- Locations -->
        <div class="card">
            <div class="card-header">å…·ä½“åœ°ç‚¹</div>
            <div class="location-grid" id="locationList">
                <!-- JS Populated -->
            </div>
        </div>
    </div>
    
    <!-- Right Column: Date Ranges -->
    <div class="filter-section">
        <div class="card" style="position:sticky; top:20px">
            <div class="card-header">å‘¨æ¬¡ / æ—¥æœŸèŒƒå›´</div>
            <div class="week-list" id="dateRangeList">
                <!-- JS Populated -->
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div class="results-section">
    <div class="results-header">
        <h3 class="results-title">
            æ´»åŠ¨åˆ—è¡¨ 
            <span class="badge-count" id="resultCount">0</span>
        </h3>
    </div>
    <div class="table-wrap">
        <table class="activity-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æ—¶é—´</th>
                    <th>ä¹¦é™¢</th>
                    <th>æ´»åŠ¨åç§°</th>
                    <th>ç±»å‹</th>
                    <th>åœ°ç‚¹</th>
                    <th>äººæ•°</th>
                </tr>
            </thead>
            <tbody id="resultTable"></tbody>
        </table>
    </div>
    <div style="text-align:center;">
        <button class="btn-load" id="loadMore" style="display:none">åŠ è½½æ›´å¤šæ•°æ®</button>
    </div>
</div>

<!-- Upload Wizard Modal -->
<div id="uploadModal" class="modal-backdrop">
    <div class="modal wizard-modal">
        <div class="wizard-header">
            <h3>å¯¼å…¥æ•°æ®</h3>
            <div class="wizard-steps">
                <div class="step-item active" data-step="1">
                    <div class="step-icon">1</div>
                    <span>å¯¼å…¥æ–‡ä»¶</span>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="2">
                    <div class="step-icon">2</div>
                    <span>ç¡®å®šæ•°æ®</span>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="3">
                    <div class="step-icon">3</div>
                    <span>å¯¼å…¥æ•°æ®</span>
                </div>
            </div>
        </div>

        <div class="wizard-content">
            <!-- Step 1: Upload -->
            <div class="step-pane active" id="step1">
                <div class="drag-drop-zone" id="dropZone">
                    <div class="icon">ğŸ“‚</div>
                    <p>æ‹–æ‹½æ–‡ä»¶è‡³æ­¤ æˆ– ç‚¹å‡»é€‰æ‹©</p>
                    <p class="sub-text" style="color:var(--text-secondary); font-size:12px; margin-top:4px">æ”¯æŒ .xlsx, .xls, .csv</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden>
                </div>
                <div id="fileInfo" class="file-info hidden">
                    <span class="file-icon" style="font-size:20px">ğŸ“„</span>
                    <div style="flex:1">
                        <div id="fileName" style="font-weight:500">example.xlsx</div>
                        <div id="fileSize" style="font-size:12px;color:var(--text-secondary)">12KB</div>
                    </div>
                    <div class="text-success">âœ“</div>
                </div>
            </div>

            <!-- Step 2: Preview -->
            <div class="step-pane" id="step2">
                <div class="data-summary">
                    <div class="summary-item">
                        <label>æ€»è®°å½•æ•°</label>
                        <span id="previewTotal">0</span>
                    </div>
                    <div class="summary-item">
                        <label>æ—¥æœŸèŒƒå›´</label>
                        <span id="previewDateRange">-</span>
                    </div>
                </div>
                <div class="table-preview-wrap">
                    <table class="preview-table">
                        <thead>
                            <tr id="previewHeader"></tr>
                        </thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
                <p style="font-size:12px;color:var(--text-secondary);margin-top:8px">ä»…æ˜¾ç¤ºå‰ 5 æ¡æ•°æ®ç”¨äºé¢„è§ˆ</p>
            </div>

            <!-- Step 3: Progress -->
            <div class="step-pane" id="step3">
                <div class="progress-container">
                    <div class="progress-ring" style="--percent:0">
                        <svg><circle r="50" cx="60" cy="60" pathLength="100" /></svg>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-info">
                        <h4 id="progressStatus" style="margin:0 0 8px 0">å‡†å¤‡å¯¼å…¥...</h4>
                        <p id="progressCount" style="margin:0;color:var(--text-secondary)">å·²å¯¼å…¥ 0 / 0</p>
                        <p id="progressTime" style="margin:4px 0 0 0;font-size:12px;color:var(--text-secondary)">é¢„è®¡å‰©ä½™æ—¶é—´: --</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-footer">
            <button class="btn" id="btnCancel">å–æ¶ˆ</button>
            <div class="step-actions">
                <button class="btn hidden" id="btnPrev">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btnNext" disabled>ä¸‹ä¸€æ­¥</button>
                <button class="btn btn-primary hidden" id="btnFinish">å®Œæˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="appAlertModal" class="modal-backdrop" style="z-index:9999">
    <div class="modal" style="width:400px">
        <h3 id="appAlertTitle">æç¤º</h3>
        <p id="appAlertMsg"></p>
        <div class="actions">
            <button class="btn btn-primary" id="appAlertOk">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- Walk-in Sync Modal -->
<div id="walkinModal" class="modal-backdrop">
    <div class="modal" style="width:600px">
        <h3>åŒæ­¥æ•£å®¢æ•°æ®</h3>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px">
            å°†ä»è®¾å¤‡åŸå§‹è®°å½•ä¸­ç”Ÿæˆâ€œæ•£å®¢è®¿é—®â€æ•°æ®ã€‚è§„åˆ™: æ¯30åˆ†é’Ÿèšåˆä¸€æ¬¡ï¼Œæ´»åŠ¨åç§°ä¸ºâ€œæ•£å®¢â€ï¼Œç±»å‹ä¸ºâ€œæ•£å®¢è®¿é—®â€ã€‚
        </p>
        
        <div class="form-group mb-4">
            <label>é€‰æ‹©è®¾å¤‡ (å¯å¤šé€‰)</label>
            <div id="walkinDeviceList" class="checkbox-list" style="max-height:150px;overflow-y:auto;border:1px solid var(--border);padding:8px;border-radius:4px"></div>
        </div>
        
        <div class="form-group mb-4">
            <label>é€‰æ‹©æ—¶é—´æ®µ</label>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button class="btn btn-sm active" id="tabDay" onclick="switchWalkinTab('day')">æŒ‰å¤©</button>
                <button class="btn btn-sm" id="tabWeek" onclick="switchWalkinTab('week')">æŒ‰å‘¨</button>
                <button class="btn btn-sm" id="tabRange" onclick="switchWalkinTab('range')">è‡ªå®šä¹‰æ®µ</button>
            </div>
            
            <div id="walkinTabDay">
                <input type="date" id="walkinDate" class="input w-full">
            </div>
            <div id="walkinTabWeek" style="display:none">
                <input type="week" id="walkinWeek" class="input w-full">
            </div>
            <div id="walkinTabRange" style="display:none">
                <div style="display:flex;gap:8px">
                    <input type="datetime-local" id="walkinStart" class="input w-full">
                    <input type="datetime-local" id="walkinEnd" class="input w-full">
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn" id="closeWalkin">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="previewWalkin">é¢„è§ˆæ•°æ®</button>
        </div>
    </div>
</div>

<!-- Walk-in Preview Modal -->
<div id="walkinPreviewModal" class="modal-backdrop" style="z-index:1100">
    <div class="modal" style="width:800px;max-width:90vw">
        <h3>ç¡®è®¤åŒæ­¥æ•°æ®</h3>
        <div style="max-height:400px;overflow-y:auto;margin:16px 0">
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th><th>æ—¶é—´</th><th>è®¾å¤‡</th><th>é¢„ä¼°äººæ•°</th>
                    </tr>
                </thead>
                <tbody id="walkinPreviewBody"></tbody>
            </table>
        </div>
        <div class="actions">
            <button class="btn" id="closeWalkinPreview">è¿”å›</button>
            <button class="btn btn-primary" id="confirmWalkin">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="/static/layout.js?v=auth_v4"></script>
<script>
    initLayout('ä¹¦é™¢çœ‹æ¿');

    // Popup Logic
    const alertModal = document.getElementById('appAlertModal');
    const alertTitle = document.getElementById('appAlertTitle');
    const alertMsg = document.getElementById('appAlertMsg');
    const alertOk = document.getElementById('appAlertOk');
    let alertResolve = null;

    window.showAlert = (msg, title='æç¤º') => {
        return new Promise(resolve => {
            alertTitle.textContent = title;
            alertMsg.textContent = msg;
            alertModal.classList.add('show');
            alertResolve = resolve;
        });
    };

    alertOk.addEventListener('click', () => {
        alertModal.classList.remove('show');
        if(alertResolve) alertResolve();
    });

    // State
    const state = {
        month: new Date().toISOString().slice(0, 7), // YYYY-MM
        filters: {
            academies: new Set(),
            weekdays: new Set(),
            start_times: new Set(), // Changed from minTime
            dateRange: null, // {start, end}
            types: new Set(),
            locations: new Set()
        },
        page: 1,
        hasMore: true
    };

    const els = {
        monthPicker: document.getElementById('monthPicker'),
        academyList: document.getElementById('academyList'),
        weekdayList: document.getElementById('weekdayList'),
        timeList: document.getElementById('timeList'),
        typeList: document.getElementById('typeList'),
        dateRangeList: document.getElementById('dateRangeList'),
        locationList: document.getElementById('locationList'),
        resultTable: document.getElementById('resultTable'),
        resultCount: document.getElementById('resultCount'),
        loadMore: document.getElementById('loadMore'),
        // Upload
        uploadBtn: document.getElementById('uploadBtn'),
        // Walkin
        syncWalkinBtn: document.getElementById('syncWalkinBtn')
    };

    // --- Wizard Logic ---
    const wizard = {
        step: 1,
        file: null,
        data: [],
        CHUNK_SIZE: 500,
        
        // Elements
        el: {
            modal: document.getElementById('uploadModal'),
            steps: document.querySelectorAll('.step-item'),
            panes: document.querySelectorAll('.step-pane'),
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            btnCancel: document.getElementById('btnCancel'),
            btnPrev: document.getElementById('btnPrev'),
            btnNext: document.getElementById('btnNext'),
            btnFinish: document.getElementById('btnFinish'),
            // Preview
            previewTotal: document.getElementById('previewTotal'),
            previewDateRange: document.getElementById('previewDateRange'),
            previewHeader: document.getElementById('previewHeader'),
            previewBody: document.getElementById('previewBody'),
            // Progress
            progressRing: document.querySelector('.progress-ring'),
            progressPercent: document.getElementById('progressPercent'),
            progressStatus: document.getElementById('progressStatus'),
            progressCount: document.getElementById('progressCount'),
            progressTime: document.getElementById('progressTime')
        },

        init() {
            if(!window.XLSX) {
                console.error('SheetJS not loaded');
            }

            // Open/Close
            els.uploadBtn.addEventListener('click', () => this.open());
            this.el.btnCancel.addEventListener('click', () => this.close());
            
            // Navigation
            this.el.btnNext.addEventListener('click', () => this.next());
            this.el.btnPrev.addEventListener('click', () => this.prev());
            this.el.btnFinish.addEventListener('click', () => this.close());

            // File Input
            this.el.dropZone.addEventListener('click', () => this.el.fileInput.click());
            this.el.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
            
            // Drag & Drop
            this.el.dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                this.el.dropZone.classList.add('dragover');
            });
            this.el.dropZone.addEventListener('dragleave', () => {
                this.el.dropZone.classList.remove('dragover');
            });
            this.el.dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                this.el.dropZone.classList.remove('dragover');
                if(e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]);
            });
        },

        open() {
            this.reset();
            this.el.modal.classList.add('show');
        },

        close() {
            this.el.modal.classList.remove('show');
            if(this.step === 3 && this.data.length > 0) {
                reload();
            }
        },

        reset() {
            this.step = 1;
            this.file = null;
            this.data = [];
            this.el.fileInput.value = '';
            this.el.fileInfo.classList.add('hidden');
            this.el.dropZone.classList.remove('hidden');
            this.el.btnNext.disabled = true;
            this.renderStep();
        },

        renderStep() {
            // Update Steps UI
            this.el.steps.forEach(s => {
                const sNum = parseInt(s.dataset.step);
                s.classList.toggle('active', sNum <= this.step);
            });

            // Show Pane
            this.el.panes.forEach(p => p.classList.remove('active'));
            document.getElementById(`step${this.step}`).classList.add('active');

            // Buttons
            this.el.btnPrev.classList.toggle('hidden', this.step === 1 || this.step === 3);
            this.el.btnNext.classList.toggle('hidden', this.step === 3);
            this.el.btnFinish.classList.toggle('hidden', this.step !== 3); 
            this.el.btnCancel.classList.toggle('hidden', this.step === 3);

            if (this.step === 1) {
                this.el.btnNext.disabled = !this.file;
            } else if (this.step === 2) {
                this.el.btnNext.disabled = false;
            } else if (this.step === 3) {
                this.startImport();
            }
        },

        handleFile(file) {
            if(!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            if(!['xlsx', 'xls', 'csv'].includes(ext)) {
                showAlert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                return;
            }

            this.file = file;
            this.el.dropZone.classList.add('hidden');
            this.el.fileInfo.classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            this.el.btnNext.disabled = false;
        },

        async next() {
            if(this.step === 1) {
                try {
                    this.el.btnNext.disabled = true;
                    this.el.btnNext.textContent = "è§£æä¸­...";
                    await this.parseFile();
                    this.el.btnNext.textContent = "ä¸‹ä¸€æ­¥";
                } catch(e) {
                    this.el.btnNext.disabled = false;
                    this.el.btnNext.textContent = "ä¸‹ä¸€æ­¥";
                    return;
                }
            }
            this.step++;
            this.renderStep();
        },

        prev() {
            this.step--;
            this.renderStep();
        },

        async parseFile() {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, {type: 'binary'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""});
                        this.processData(jsonData);
                        resolve();
                    } catch(err) {
                        showAlert('è§£æå¤±è´¥: ' + err.message);
                        reject(err);
                    }
                };
                reader.readAsBinaryString(this.file);
            });
        },

        processData(rows) {
            this.data = rows.map(row => {
                const getVal = (keys) => {
                    for(let k of keys) if(row[k] !== undefined) return row[k];
                    return '';
                };

                const dateStr = String(getVal(['å¹´/æœˆ/æ—¥', 'Date', 'æ—¥æœŸ'])).split(' ')[0];
                const startTime = String(getVal(['èµ·å§‹æ—¶é—´', 'Start']) || '');
                const endTime = String(getVal(['ç»“æŸæ—¶é—´', 'End']) || '');
                
                // Duration
                let duration = 0;
                const durRaw = String(getVal(['æ—¶é•¿', 'Duration']) || '');
                if(durRaw.includes('æ—¶')) {
                    const parts = durRaw.split('æ—¶');
                    const h = parseInt(parts[0]) || 0;
                    const m = parseInt(parts[1]?.replace('åˆ†','')) || 0;
                    duration = h*60 + m;
                } else if(durRaw.includes('åˆ†')) {
                    duration = parseInt(durRaw.replace('åˆ†','')) || 0;
                } else if(durRaw.match(/^\d+$/)) {
                    duration = parseInt(durRaw);
                } else {
                    // Try calc from start/end
                    if(startTime && endTime && dateStr) {
                        try {
                            const t1 = new Date(`2000/01/01 ${startTime}`);
                            const t2 = new Date(`2000/01/01 ${endTime}`);
                            duration = (t2 - t1) / 1000 / 60;
                        } catch(e){}
                    }
                }

                return {
                    date: dateStr,
                    weekday: String(getVal(['å‘¨å‡ ', 'Weekday']) || ''),
                    start_time: startTime,
                    end_time: endTime,
                    duration_minutes: duration || 0,
                    academy: String(getVal(['ä¹¦é™¢', 'Academy']) || ''),
                    location: String(getVal(['å…·ä½“åœ°ç‚¹', 'Location']) || ''),
                    activity_name: String(getVal(['æ´»åŠ¨åç§°', 'Activity Name']) || ''),
                    activity_type: String(getVal(['æ´»åŠ¨ç±»å‹', 'Activity Type']) || ''),
                    audience_count: parseInt(getVal(['å—ä¼—å­¦ç”Ÿæ•°', 'Audience']) || 0),
                    notes: String(getVal(['å¤‡æ³¨', 'Remarks']) || '')
                };
            }).filter(d => d.date && d.date !== 'undefined');

            // Render Preview
            this.el.previewTotal.textContent = this.data.length;
            if(this.data.length > 0) {
                const dates = this.data.map(d => d.date).sort();
                this.el.previewDateRange.textContent = `${dates[0]} - ${dates[dates.length-1]}`;
            }
            
            // Render Table Headers
            const headers = ['æ—¥æœŸ', 'ä¹¦é™¢', 'åœ°ç‚¹', 'æ´»åŠ¨', 'äººæ•°'];
            this.el.previewHeader.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            
            // Render Body
            this.el.previewBody.innerHTML = this.data.slice(0, 5).map(d => `
                <tr>
                    <td>${d.date}</td>
                    <td>${d.academy}</td>
                    <td>${d.location}</td>
                    <td>${d.activity_name}</td>
                    <td>${d.audience_count}</td>
                </tr>
            `).join('');
        },

        async startImport() {
            const total = this.data.length;
            let imported = 0;
            const startTime = Date.now();

            this.el.progressStatus.textContent = "æ­£åœ¨å¯¼å…¥...";
            this.el.progressStatus.style.color = "var(--text-main)";

            for(let i=0; i<total; i+=this.CHUNK_SIZE) {
                const chunk = this.data.slice(i, i+this.CHUNK_SIZE);
                try {
                    const res = await fetch('/api/v1/activity/walkin/sync', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({items: chunk})
                    });
                    
                    if(!res.ok) throw new Error(await res.text());
                    
                    imported += chunk.length;
                    
                    // Update Progress
                    const percent = Math.min(100, Math.round((imported / total) * 100));
                    this.el.progressRing.style.setProperty('--percent', percent);
                    this.el.progressPercent.textContent = percent + '%';
                    this.el.progressCount.textContent = `å·²å¯¼å…¥ ${imported} / ${total}`;
                    
                    // Est Time
                    const elapsed = Date.now() - startTime;
                    if(imported > 0) {
                        const speed = imported / elapsed; 
                        const remaining = total - imported;
                        const etaMs = remaining / speed;
                        this.el.progressTime.textContent = `é¢„è®¡å‰©ä½™æ—¶é—´: ${(etaMs/1000).toFixed(1)}s`;
                    }
                    
                    await new Promise(r => setTimeout(r, 100)); // Visual delay
                } catch(err) {
                    this.el.progressStatus.textContent = "å¯¼å…¥å‡ºé”™: " + err.message;
                    this.el.progressStatus.style.color = "var(--danger)";
                    this.el.btnCancel.classList.remove('hidden');
                    this.el.btnCancel.textContent = "å…³é—­";
                    return;
                }
            }

            this.el.progressStatus.textContent = "å¯¼å…¥å®Œæˆ!";
            this.el.progressStatus.style.color = "var(--success)";
            this.el.btnFinish.classList.remove('hidden');
            this.el.btnCancel.classList.add('hidden');
            
            reload();
        }
    };
    wizard.init();

    // --- Walk-in Logic ---
    const elsWalkin = {
        btn: document.getElementById('syncWalkinBtn'),
        modal: document.getElementById('walkinModal'),
        close: document.getElementById('closeWalkin'),
        deviceList: document.getElementById('walkinDeviceList'),
        previewBtn: document.getElementById('previewWalkin'),
        
        // Tabs
        tabDay: document.getElementById('tabDay'),
        tabWeek: document.getElementById('tabWeek'),
        tabRange: document.getElementById('tabRange'),
        areaDay: document.getElementById('walkinTabDay'),
        areaWeek: document.getElementById('walkinTabWeek'),
        areaRange: document.getElementById('walkinTabRange'),
        
        // Inputs
        date: document.getElementById('walkinDate'),
        week: document.getElementById('walkinWeek'),
        start: document.getElementById('walkinStart'),
        end: document.getElementById('walkinEnd'),
        
        // Preview
        previewModal: document.getElementById('walkinPreviewModal'),
        previewBody: document.getElementById('walkinPreviewBody'),
        previewClose: document.getElementById('closeWalkinPreview'),
        confirm: document.getElementById('confirmWalkin')
    };

    let walkinState = {
        mode: 'day',
        previewData: []
    };

    elsWalkin.btn.addEventListener('click', async () => {
        elsWalkin.modal.classList.add('show');
        if(elsWalkin.deviceList.children.length === 0) {
            // Load devices
            const res = await fetch('/api/v1/devices');
            const list = await res.json();
            const mapRes = await fetch('/api/v1/devices/mapping');
            const map = (await mapRes.json()).mapping || {};
            
            elsWalkin.deviceList.innerHTML = list.map(d => {
                const uuid = typeof d === 'string' ? d : d.uuid;
                const entry = map[uuid];
                const name = entry ? (entry.name || uuid) : uuid;
                const display = name === uuid ? uuid : `${name} (${uuid})`;
                return `<div class="checkbox-tag" onclick="this.classList.toggle('checked')" data-val="${uuid}">${display}</div>`;
            }).join('');
        }
        // Default date
        if(!elsWalkin.date.value) elsWalkin.date.value = new Date().toISOString().split('T')[0];
    });

    elsWalkin.close.addEventListener('click', () => elsWalkin.modal.classList.remove('show'));

    window.switchWalkinTab = (mode) => {
        walkinState.mode = mode;
        ['day','week','range'].forEach(m => {
            const btn = document.getElementById('tab'+m.charAt(0).toUpperCase()+m.slice(1));
            const area = document.getElementById('walkinTab'+m.charAt(0).toUpperCase()+m.slice(1));
            if(m === mode) {
                btn.classList.add('active');
                area.style.display = 'block';
            } else {
                btn.classList.remove('active');
                area.style.display = 'none';
            }
        });
    };

    elsWalkin.previewBtn.addEventListener('click', async () => {
        // Collect Devices
        const devices = Array.from(elsWalkin.deviceList.querySelectorAll('.checked')).map(e => e.dataset.val);
        if(devices.length === 0) return showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¾å¤‡');
        
        // Collect Time
        let start, end;
        if(walkinState.mode === 'day') {
            if(!elsWalkin.date.value) return showAlert('è¯·é€‰æ‹©æ—¥æœŸ');
            start = elsWalkin.date.value + ' 00:00:00';
            end = elsWalkin.date.value + ' 23:59:59';
        } else if(walkinState.mode === 'week') {
            if(!elsWalkin.week.value) return showAlert('è¯·é€‰æ‹©å‘¨æ¬¡');
            // Calculate week start/end
            const [y, w] = elsWalkin.week.value.split('-W');
            const d = new Date(y, 0, 1 + (w - 1) * 7);
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
            const s = new Date(d.setDate(diff));
            const e = new Date(d.setDate(diff + 6));
            start = s.toISOString().split('T')[0] + ' 00:00:00';
            end = e.toISOString().split('T')[0] + ' 23:59:59';
        } else {
            if(!elsWalkin.start.value || !elsWalkin.end.value) return showAlert('è¯·é€‰æ‹©æ—¶é—´æ®µ');
            start = elsWalkin.start.value.replace('T', ' ');
            end = elsWalkin.end.value.replace('T', ' ');
        }
        
        elsWalkin.previewBtn.textContent = 'è®¡ç®—ä¸­...';
        try {
            const res = await fetch('/api/v1/activity/walkin/preview', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ devices, start, end })
            });
            if(!res.ok) throw new Error(await res.text());
            
            const data = await res.json();
            walkinState.previewData = data.items;
            
            // Show Preview
            elsWalkin.previewBody.innerHTML = data.items.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.start_time}-${r.end_time}</td>
                    <td>${r.location}</td>
                    <td>${r.audience_count}</td>
                </tr>
            `).join('');
            
            if(data.items.length === 0) {
                elsWalkin.previewBody.innerHTML = '<tr><td colspan="4" style="text-align:center">æ— æ•°æ®æˆ–è¯¥æ—¶æ®µæ— è®°å½•</td></tr>';
            }
            
            elsWalkin.previewModal.classList.add('show');
        } catch(e) {
            showAlert('Error: ' + e.message);
        } finally {
            elsWalkin.previewBtn.textContent = 'é¢„è§ˆæ•°æ®';
        }
    });

    elsWalkin.previewClose.addEventListener('click', () => elsWalkin.previewModal.classList.remove('show'));

    elsWalkin.confirm.addEventListener('click', async () => {
        if(walkinState.previewData.length === 0) return;
        
        elsWalkin.confirm.disabled = true;
        elsWalkin.confirm.textContent = 'åŒæ­¥ä¸­...';
        
        try {
            const res = await fetch('/api/v1/activity/walkin/sync', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: walkinState.previewData })
            });
            if(!res.ok) throw new Error(await res.text());
            
            const json = await res.json();
            await showAlert(`åŒæ­¥æˆåŠŸ: ${json.count} æ¡è®°å½•`);
            elsWalkin.previewModal.classList.remove('show');
            elsWalkin.modal.classList.remove('show');
            reload();
        } catch(e) {
            showAlert('Error: ' + e.message);
        } finally {
            elsWalkin.confirm.disabled = false;
            elsWalkin.confirm.textContent = 'ç¡®è®¤æ·»åŠ ';
        }
    });

    // Init
    async function init() {
        // Init Date
        els.monthPicker.value = state.month;
        
        // Load Options & Mapping
        let opts = { locations:[], types:[], academies:[], weekdays:[], times:[] };
        let acaList = [];
        let deviceMap = {};

        try {
            const [optRes, acaRes, mapRes] = await Promise.all([
                fetch('/api/v1/activity/options'),
                fetch('/api/v1/academies'),
                fetch('/api/v1/devices/mapping')
            ]);
            
            if(optRes.ok) opts = await optRes.json();
            if(acaRes.ok) acaList = await acaRes.json();
            if(mapRes.ok) {
                const mapData = await mapRes.json();
                deviceMap = mapData.mapping || {};
            }
        } catch(e) {
            console.error("Load options failed", e);
        }
        
        // Academies: Merge Registry + Existing
        const academyNames = new Set(acaList.map(a => a.name));
        if(opts.academies) opts.academies.forEach(a => academyNames.add(a));
        
        // Activity Types: Merge Fixed + Existing
        const fixedTypes = [
            "ç­å›¢æ´»åŠ¨", "å…¬ç›Š/å¿—æ„¿æ´»åŠ¨", "ä¼šè®®æ´»åŠ¨", "åŸ¹è®­æ´»åŠ¨", "å…¶ä»–æ´»åŠ¨", 
            "å…¨ç”Ÿå¼‚ç§‘å¯¼å¸ˆæ´»åŠ¨", "æ•£å®¢è®¿é—®", "ç¤¾å›¢æ´»åŠ¨", "ä¹¦é™¢æ´»åŠ¨", 
            "ä½“è‚²æ´»åŠ¨", "é¡¹ç›®å·¥åŠæ´»åŠ¨", "è‰ºæœ¯æ´»åŠ¨", "é¡¹ç›®å·¥åŠ"
        ];
        const typeSet = new Set(fixedTypes);
        if(opts.types) opts.types.forEach(t => typeSet.add(t));
        
        renderOptions(els.academyList, Array.from(academyNames).sort(), 'academies', 'academy-pill');
        renderOptions(els.typeList, Array.from(typeSet).sort(), 'types', 'tag');
        
        // Locations with Mapping
        const locations = (opts.locations || []).map(l => {
            const entry = deviceMap[l];
            const name = entry ? (entry.name || l) : l;
            return { val: l, display: name === l ? l : name }; 
        });
        renderLocations(els.locationList, locations, 'locations', 'location-item');
        
        renderTimes(opts.times || []);
        
        // Weekdays (Fixed set to ensure order, but using values that match DB likely "å‘¨ä¸€")
        const weekVars = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"];
        renderWeekdays(els.weekdayList, weekVars);

        renderDateRanges();
        
        // Event Listeners
        els.monthPicker.addEventListener('change', (e) => {
            if(e.target.value) {
                state.month = e.target.value;
                state.filters.dateRange = null; 
                renderDateRanges();
                reload();
            }
        });
        
        els.loadMore.addEventListener('click', () => {
            state.page++;
            loadData(true);
        });

        // Initial Load
        reload();
    }

    function renderOptions(container, items, filterKey, className) {
        if(!items || items.length === 0) {
            container.innerHTML = '<div style="color:#ccc;font-size:12px;padding:10px">æš‚æ— æ•°æ®</div>';
            return;
        }
        container.innerHTML = items.map(item => `
            <div class="${className}" data-val="${item}">${item}</div>
        `).join('');
        
        container.querySelectorAll('.' + className.split(' ')[0]).forEach(el => {
            el.addEventListener('click', () => {
                const val = el.dataset.val;
                toggleFilter(filterKey, val);
                el.classList.toggle('active');
                reload();
            });
        });
    }
    
    function renderWeekdays(container, items) {
        container.innerHTML = items.map(w => `
            <div class="week-item" data-val="${w}"><span>${w}</span> <span style="opacity:0.3">â†’</span></div>
        `).join('');
        
        container.querySelectorAll('.week-item').forEach(el => {
            el.addEventListener('click', () => {
                const val = el.dataset.val;
                toggleFilter('weekdays', val);
                el.classList.toggle('active');
                reload();
            });
        });
    }

    function renderLocations(container, items, filterKey, className) {
        if(!items || items.length === 0) {
            container.innerHTML = '<div style="color:#ccc;font-size:12px;padding:10px">æš‚æ— æ•°æ®</div>';
            return;
        }
        container.innerHTML = items.map(item => `
            <div class="${className}" data-val="${item.val}">${item.display}</div>
        `).join('');
        
        container.querySelectorAll('.' + className.split(' ')[0]).forEach(el => {
            el.addEventListener('click', () => {
                const val = el.dataset.val;
                toggleFilter(filterKey, val);
                el.classList.toggle('active');
                reload();
            });
        });
    }

    function renderTimes(times) {
        const fixedTimes = [
            "05:30", "06:00", "06:30", "07:00", "07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30",
            "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00",
            "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30",
            "22:00"
        ];
        
        els.timeList.innerHTML = fixedTimes.map(t => `
            <div class="time-item" data-val="${t}">${t}</div>
        `).join('');
        
        els.timeList.querySelectorAll('.time-item').forEach(el => {
            el.addEventListener('click', () => {
                const val = el.dataset.val;
                toggleFilter('start_times', val); 
                el.classList.toggle('active');
                reload();
            });
        });
    }

    function renderDateRanges() {
        // Split selected month into weeks
        const [y, m] = state.month.split('-').map(Number);
        const ranges = [];
        
        // Get first day of month
        let curr = new Date(y, m-1, 1);
        const endMonth = new Date(y, m, 0); // Last day of month
        
        while(curr <= endMonth) {
            // Start of "week" (or segment)
            let start = new Date(curr);
            
            let day = curr.getDay(); // 0(Sun) - 6(Sat)
            // Adjust to Monday start: Mon(0) ... Sun(6)
            let diff = 7 - (day === 0 ? 7 : day); // Days remaining in this week (Mon-Sun)
            
            let end = new Date(curr);
            end.setDate(curr.getDate() + diff);
            
            // Cap at end of month
            if(end > endMonth) end = new Date(endMonth);
            
            ranges.push({
                start: fmtDate(start),
                end: fmtDate(end)
            });
            
            // Next loop starts after end
            curr = new Date(end);
            curr.setDate(curr.getDate() + 1);
        }
        
        els.dateRangeList.innerHTML = ranges.map(r => `
            <div class="week-item" data-start="${r.start}" data-end="${r.end}">
                <span>${r.start} - ${r.end}</span>
                <span style="opacity:0.3">â†’</span>
            </div>
        `).join('');
        
        els.dateRangeList.querySelectorAll('.week-item').forEach(el => {
            el.addEventListener('click', () => {
                const s = el.dataset.start;
                const e = el.dataset.end;
                
                // Toggle
                els.dateRangeList.querySelectorAll('.week-item').forEach(i => i.classList.remove('active'));
                
                if(state.filters.dateRange && state.filters.dateRange.start === s) {
                    state.filters.dateRange = null;
                } else {
                    state.filters.dateRange = {start: s, end: e};
                    el.classList.add('active');
                }
                reload();
            });
        });
    }

    function fmtDate(d) {
        return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
    }

    function toggleFilter(key, val) {
        if(state.filters[key].has(val)) {
            state.filters[key].delete(val);
        } else {
            state.filters[key].add(val);
        }
    }

    function reload() {
        state.page = 1;
        state.hasMore = true;
        loadData(false);
    }

    async function loadData(append) {
        if(!append) {
            els.resultTable.innerHTML = '';
        }
        
        const q = new URLSearchParams();
        q.append('page', state.page);
        q.append('page_size', 50);
        
        // Date Logic
        // Base range is the whole month unless dateRange is selected
        if(state.filters.dateRange) {
            q.append('start_date', state.filters.dateRange.start.replace(/\//g, '-'));
            q.append('end_date', state.filters.dateRange.end.replace(/\//g, '-'));
        } else {
            // Whole month
            const [y, m] = state.month.split('-');
            const lastDay = new Date(y, m, 0).getDate();
            q.append('start_date', `${state.month}-01`);
            q.append('end_date', `${state.month}-${lastDay}`);
        }
        
        if(state.filters.academies.size > 0) q.append('academies', Array.from(state.filters.academies).join(','));
        if(state.filters.types.size > 0) q.append('types', Array.from(state.filters.types).join(','));
        if(state.filters.locations.size > 0) q.append('locations', Array.from(state.filters.locations).join(','));
        if(state.filters.weekdays.size > 0) q.append('weekdays', Array.from(state.filters.weekdays).join(','));
        if(state.filters.start_times.size > 0) q.append('start_times', Array.from(state.filters.start_times).join(','));

        const res = await fetch('/api/v1/activity/list?' + q.toString());
        const data = await res.json();
        
        els.resultCount.textContent = data.total;
        
        if(data.items.length === 0) {
            state.hasMore = false;
            els.loadMore.style.display = 'none';
            if(!append) els.resultTable.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;padding:40px 0;">æš‚æ— æ•°æ®</td></tr>';
            return;
        }
        
        const html = data.items.map(i => `
            <tr>
                <td>${i.date} (å‘¨${mapWeekday(i.weekday)})</td>
                <td>${i.start_time}-${i.end_time}</td>
                <td><span class="badge-table badge-academy">${i.academy || '-'}</span></td>
                <td><strong style="font-weight:600">${i.activity_name}</strong></td>
                <td><span class="badge-table badge-type">${i.activity_type}</span></td>
                <td>${i.location}</td>
                <td style="font-weight:700;color:var(--primary)">${i.audience_count}</td>
            </tr>
        `).join('');
        
        if(append) {
            els.resultTable.insertAdjacentHTML('beforeend', html);
        } else {
            els.resultTable.innerHTML = html;
        }
        
        els.loadMore.style.display = data.items.length < 50 ? 'none' : 'inline-block';
    }

    function mapWeekday(wd) {
        if(!wd) return '';
        const s = String(wd);
        if(s.startsWith('å‘¨')) return s.replace('å‘¨', '');
        if(s.startsWith('æ˜ŸæœŸ')) return s.replace('æ˜ŸæœŸ', '');

        const map = {
            'Mon': 'ä¸€', 'Tue': 'äºŒ', 'Wed': 'ä¸‰', 'Thu': 'å››', 'Fri': 'äº”', 'Sat': 'å…­', 'Sun': 'æ—¥',
            '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'æ—¥'
        };
        return map[s] || s;
    }

    init();
</script>

</body>
</html>
