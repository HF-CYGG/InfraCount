<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²æ•°æ® - InfraCount</title>
    <link rel="stylesheet" href="/static/style.css?v=ui_v1">
    <style>
        .relative { position: relative; }
        .popup-card {
            position: absolute;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            padding: 16px;
            z-index: 100;
            display: none;
            min-width: 250px;
        }
        .popup-card.show { display: block; }
        .date-range-btn {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            min-width: 240px;
            cursor: pointer;
        }
        .mb-2 { margin-bottom: 8px; }
        .cal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }
        .cal-wd {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            padding: 4px 0;
        }
        .cal-day {
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            font-size: 13px;
            padding: 0;
            transition: all 0.15s ease;
        }
        .cal-day:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .cal-day:active { transform: scale(0.98); }
        .cal-day.in-range {
            background: var(--primary-light);
            border-color: var(--primary-light);
        }
        .cal-day.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="filter-bar" style="margin-bottom:0;border:none;box-shadow:none;padding:0">
        <div class="flex items-center gap-2">
            <label>è®¾å¤‡</label>
            <select id="device" class="select" style="width:200px"></select>
        </div>
        <div class="flex items-center gap-2">
            <label>æ—¥æœŸèŒƒå›´</label>
            <div class="relative">
                <button id="dateRangeBtn" class="input date-range-btn" type="button">
                    <span id="dateRangeLabel" class="text-muted">é€‰æ‹©æ—¥æœŸèŒƒå›´</span>
                    <span style="opacity:.7">ğŸ“…</span>
                </button>
                <div id="dateRangePopup" class="popup-card" style="left:0;top:120%;min-width:360px">
                    <div class="flex gap-2 mb-2" style="flex-wrap:wrap">
                        <button class="btn btn-sm" id="quickToday" type="button">ä»Šå¤©</button>
                        <button class="btn btn-sm" id="quickLast7" type="button">è¿‘7å¤©</button>
                        <button class="btn btn-sm" id="quickWeek" type="button">æœ¬å‘¨</button>
                        <button class="btn btn-sm" id="quickMonth" type="button">æœ¬æœˆ</button>
                    </div>

                    <div class="cal-header">
                        <button class="btn btn-sm" id="calPrev" type="button">â€¹</button>
                        <div class="flex items-center gap-2" style="flex:1;justify-content:center">
                            <select id="calYear" class="select" style="height:28px;padding:0 8px;font-size:12px"></select>
                            <select id="calMonth" class="select" style="height:28px;padding:0 8px;font-size:12px"></select>
                        </div>
                        <button class="btn btn-sm" id="calNext" type="button">â€º</button>
                    </div>

                    <div class="cal-grid" id="calGrid"></div>

                    <div class="flex gap-2" style="justify-content:flex-end;margin-top:12px">
                        <button class="btn btn-sm" id="dateRangeClear" type="button">æ¸…ç©º</button>
                        <button class="btn btn-primary btn-sm" id="dateRangeApply" type="button">åº”ç”¨</button>
                    </div>
                </div>

                <input type="date" id="start" style="display:none">
                <input type="date" id="end" style="display:none">
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button class="btn btn-primary" id="query">æŸ¥è¯¢</button>
            <button class="btn" id="reset">é‡ç½®</button>
            <button class="btn" id="toggleAdvanced">é«˜çº§ç­›é€‰</button>
        </div>
        <div class="flex items-center gap-2" style="margin-left:auto">
            <button class="btn btn-success" id="addRecordBtn" style="background:#0ca678;color:#fff;border-color:#0ca678">æ·»åŠ è®°å½•</button>
            <button class="btn btn-primary" id="batchEditBtn">æ‰¹é‡ä¿®æ”¹</button>
            <button class="btn btn-secondary" id="dataCompletion">æ•°æ®è¡¥å…¨</button>
            <button class="btn btn-success" id="mergeDataBtn">æ•°æ®åˆå¹¶</button>
            <button class="btn btn-danger" id="batchDelete">æ‰¹é‡åˆ é™¤</button>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div id="advancedPopup" class="card" style="display:none;margin-top:16px;margin-bottom:16px;background:#f8f9fa">
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
            <div>
                <label class="text-sm">å‘Šè­¦çŠ¶æ€ (0/1)</label>
                <input id="filterWarn" type="number" class="input">
            </div>
            <div>
                <label class="text-sm">è®°å½•ç±»å‹</label>
                <input id="filterRecType" type="number" class="input" placeholder="1:å®æ—¶ 2:å†å²">
            </div>
            <div>
                <label class="text-sm">Txç”µé‡ (Min)</label>
                <input id="filterBtxMin" type="number" class="input">
            </div>
            <div>
                <label class="text-sm">Txç”µé‡ (Max)</label>
                <input id="filterBtxMax" type="number" class="input">
            </div>
        </div>
    </div>

    <div class="table-wrap" style="margin-top:16px">
        <table>
            <thead>
                <tr>
                    <th style="width:40px"><input type="checkbox" id="selectAll"></th>
                    <th>æ—¶é—´</th>
                    <th>IN</th>
                    <th>OUT</th>
                    <th>ç”µé‡</th>
                    <th>çŠ¶æ€</th>
                    <th>Txç”µé‡</th>
                    <th>è®°å½•ç±»å‹</th>
                    <th>æ´»åŠ¨ç±»å‹</th>
                    <th style="width:140px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tbl"></tbody>
        </table>
    </div>
</div>

<!-- Edit/Add Modal -->
<div id="editModal" class="modal-backdrop">
    <div class="modal">
        <h3 id="modalTitle">ç¼–è¾‘è®°å½•</h3>
        <div class="mb-4"><label>æ—¶é—´</label><input id="m_time" type="datetime-local" class="input"></div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="mb-4"><label>IN</label><input id="m_in" type="number" class="input"></div>
            <div class="mb-4"><label>OUT</label><input id="m_out" type="number" class="input"></div>
        </div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="mb-4"><label>ç”µé‡</label><input id="m_bat" type="number" class="input"></div>
            <div class="mb-4"><label>Txç”µé‡</label><input id="m_btx" type="number" class="input"></div>
        </div>
        <div class="mb-4"><label>æ´»åŠ¨ç±»å‹</label>
            <select id="m_type" class="select">
                <option value="">-- é€‰æ‹©æ´»åŠ¨ç±»å‹ --</option>
                <option value="ç­å›¢æ´»åŠ¨">ç­å›¢æ´»åŠ¨</option>
                <option value="å…¬ç›Š/å¿—æ„¿æ´»åŠ¨">å…¬ç›Š/å¿—æ„¿æ´»åŠ¨</option>
                <option value="ä¼šè®®æ´»åŠ¨">ä¼šè®®æ´»åŠ¨</option>
                <option value="åŸ¹è®­æ´»åŠ¨">åŸ¹è®­æ´»åŠ¨</option>
                <option value="å…¶ä»–æ´»åŠ¨">å…¶ä»–æ´»åŠ¨</option>
                <option value="å…¨ç”Ÿå¼‚ç§‘å¯¼å¸ˆæ´»åŠ¨">å…¨ç”Ÿå¼‚ç§‘å¯¼å¸ˆæ´»åŠ¨</option>
                <option value="æ•£å®¢è®¿é—®">æ•£å®¢è®¿é—®</option>
                <option value="ç¤¾å›¢æ´»åŠ¨">ç¤¾å›¢æ´»åŠ¨</option>
                <option value="ä¹¦é™¢æ´»åŠ¨">ä¹¦é™¢æ´»åŠ¨</option>
                <option value="ä½“è‚²æ´»åŠ¨">ä½“è‚²æ´»åŠ¨</option>
                <option value="é¡¹ç›®å·¥åŠæ´»åŠ¨">é¡¹ç›®å·¥åŠæ´»åŠ¨</option>
                <option value="è‰ºæœ¯æ´»åŠ¨">è‰ºæœ¯æ´»åŠ¨</option>
                <option value="é¡¹ç›®å·¥åŠ">é¡¹ç›®å·¥åŠ</option>
            </select>
        </div>
        <div class="actions">
            <button class="btn" id="m_cancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="m_save">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Batch Edit Modal -->
<div id="batchEditModal" class="modal-backdrop">
    <div class="modal" style="width:600px">
        <h3>æ‰¹é‡ä¿®æ”¹</h3>
        
        <div style="background:#f8f9fa;padding:16px;border-radius:4px;margin-bottom:16px">
            <h4 style="margin-top:0;font-size:14px">1. é€‰æ‹©ä¿®æ”¹èŒƒå›´</h4>
            <div class="mb-2">
                <label style="display:inline-flex;align-items:center;margin-right:16px">
                    <input type="radio" name="batchScope" value="selection" checked> 
                    å½“å‰å‹¾é€‰ (<span id="batchCount">0</span> æ¡)
                </label>
                <label style="display:inline-flex;align-items:center">
                    <input type="radio" name="batchScope" value="filter"> 
                    æŒ‰æ¡ä»¶ç­›é€‰
                </label>
            </div>
            
            <div id="batchFilterOptions" style="display:none;padding-left:20px;border-left:2px solid #dee2e6">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px">
                    <div>
                        <label style="font-size:12px">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" id="batchStart" class="input w-full">
                    </div>
                    <div>
                        <label style="font-size:12px">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" id="batchEnd" class="input w-full">
                    </div>
                </div>
                <div class="mb-2">
                    <label style="font-size:12px">è®¾å¤‡ (å¯é€‰)</label>
                    <select id="batchDevice" class="select w-full"></select>
                </div>
                <button class="btn btn-sm" id="batchCheckCount">æŸ¥è¯¢åŒ¹é…æ•°é‡</button>
                <span id="batchFilterCount" style="margin-left:8px;font-size:12px;color:var(--primary)"></span>
            </div>
        </div>

        <h4 style="font-size:14px">2. è®¾ç½®æ–°å€¼ (ç•™ç©ºåˆ™ä¸ä¿®æ”¹)</h4>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <div class="mb-2"><label>IN</label><input id="batch_in" type="number" class="input w-full" placeholder="ä¿æŒåŸå€¼"></div>
            <div class="mb-2"><label>OUT</label><input id="batch_out" type="number" class="input w-full" placeholder="ä¿æŒåŸå€¼"></div>
            <div class="mb-2"><label>ç”µé‡</label><input id="batch_bat" type="number" class="input w-full" placeholder="ä¿æŒåŸå€¼"></div>
            <div class="mb-2"><label>Txç”µé‡</label><input id="batch_btx" type="number" class="input w-full" placeholder="ä¿æŒåŸå€¼"></div>
            <div class="mb-2"><label>è®°å½•ç±»å‹</label><input id="batch_rec_type" type="number" class="input w-full" placeholder="ä¿æŒåŸå€¼"></div>
            <div class="mb-2"><label>å‘Šè­¦çŠ¶æ€</label>
                <select id="batch_status" class="select w-full">
                    <option value="">ä¿æŒåŸå€¼</option>
                    <option value="0">æ­£å¸¸ (0)</option>
                    <option value="1">å‘Šè­¦ (1)</option>
                </select>
            </div>
        </div>
        <div class="mb-4">
            <label>æ´»åŠ¨ç±»å‹</label>
            <select id="batch_act_type" class="select w-full">
                <option value="">ä¿æŒåŸå€¼</option>
                <option value="ç­å›¢æ´»åŠ¨">ç­å›¢æ´»åŠ¨</option>
                <option value="å…¬ç›Š/å¿—æ„¿æ´»åŠ¨">å…¬ç›Š/å¿—æ„¿æ´»åŠ¨</option>
                <option value="ä¼šè®®æ´»åŠ¨">ä¼šè®®æ´»åŠ¨</option>
                <option value="åŸ¹è®­æ´»åŠ¨">åŸ¹è®­æ´»åŠ¨</option>
                <option value="å…¶ä»–æ´»åŠ¨">å…¶ä»–æ´»åŠ¨</option>
                <option value="æ•£å®¢è®¿é—®">æ•£å®¢è®¿é—®</option>
            </select>
        </div>
        <div class="mb-4">
            <label>æ“ä½œ (æ‰¹é‡åˆ é™¤)</label>
            <div style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="batchDeleteFlag">
                <span style="color:var(--danger)">ç¡®è®¤åˆ é™¤åŒ¹é…çš„è®°å½• (æ…ç”¨)</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn" id="batchEditCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="batchEditConfirm">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>
</div>

<!-- Delete Range Modal -->
<div id="deleteRangeModal" class="modal-backdrop">
    <div class="modal">
        <h3>æ‰¹é‡åˆ é™¤</h3>
        <p style="color:var(--danger)">è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æŒ‡å®šæ—¶é—´æ®µå†…çš„æ•°æ®ï¼</p>
        <div class="mb-4"><label>èµ·å§‹æ—¶é—´</label><input id="delStart" type="datetime-local" class="input"></div>
        <div class="mb-4"><label>ç»“æŸæ—¶é—´</label><input id="delEnd" type="datetime-local" class="input"></div>
        <div class="actions">
            <button class="btn" id="delCancel">å–æ¶ˆ</button>
            <button class="btn btn-danger" id="delConfirm">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>

<!-- Merge Config Modal -->
<div id="mergeConfigModal" class="modal-backdrop">
    <div class="modal">
        <h3>æ•°æ®åˆå¹¶ (åŒæ­¥)</h3>
        <p class="text-sm text-muted">ä»è®¾å¤‡ç«¯æˆ–å…¶ä»–èŠ‚ç‚¹åŒæ­¥æ•°æ®</p>
        <div class="mb-4">
            <label>è®¾å¤‡</label>
            <select id="mergeTargetDevice" class="select"></select>
        </div>
        <div class="mb-4">
            <label>èµ·å§‹æ—¶é—´</label>
            <input id="mergeStart" type="datetime-local" class="input">
        </div>
        <div class="mb-4">
            <label>ç»“æŸæ—¶é—´</label>
            <input id="mergeEnd" type="datetime-local" class="input">
        </div>
        <div class="actions">
            <button class="btn" id="mergeConfigCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="mergeFetchBtn">è·å–æ•°æ®</button>
        </div>
    </div>
</div>

<!-- Merge Conflict Modal -->
<div id="mergeConflictModal" class="modal-backdrop" style="z-index:1100">
    <div class="modal" style="width:800px;max-width:90vw">
        <h3>åˆå¹¶é¢„è§ˆ</h3>
        <div class="mb-4">
            <span class="badge badge-success">æ–°å¢: <span id="mergeNewCount">0</span></span>
            <span class="badge badge-warning">å†²çª: <span id="mergeConflictCount">0</span></span>
        </div>
        
        <div class="table-wrap scroll-y" style="max-height:400px;margin-bottom:16px">
            <table style="width:100%">
                <thead>
                    <tr>
                        <th style="width:40px">é€‰</th>
                        <th>æ—¶é—´</th>
                        <th>å­—æ®µ</th>
                        <th>æœ¬åœ°å€¼</th>
                        <th>è¿œç¨‹å€¼</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="mergeTableBody"></tbody>
            </table>
        </div>
        
        <div class="actions">
            <button class="btn" id="mergeConflictCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="mergeConfirmBtn">ç¡®è®¤åˆå¹¶</button>
        </div>
    </div>
</div>

<div id="logImportModal" class="modal-backdrop" style="z-index:1200">
    <div class="modal" style="width:900px;max-width:95vw">
        <h3>å¯¼å…¥è®¾å¤‡è¿”å›æ•°æ®æ—¥å¿—</h3>

        <div id="logImportStepSelect">
            <div class="card" style="background:var(--bg-subtle); padding:12px; border-radius:8px; margin-bottom:12px; box-shadow:none; border:1px solid var(--border);">
                <div class="flex items-center gap-2" style="flex-wrap:wrap">
                    <input id="logImportFile" type="file" class="input" style="max-width:420px" accept=".log,.txt,.csv,.json">
                    <span id="logImportHint" class="text-sm text-muted">æ”¯æŒ TXT/LOG/CSV/JSON</span>
                </div>
            </div>

            <div id="logImportLoading" class="text-sm text-muted" style="display:none; margin-bottom:12px">æ­£åœ¨è§£ææ—¥å¿—æ–‡ä»¶...</div>

            <div id="logImportPreview" style="display:none">
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px;">
                    <div class="card" style="box-shadow:none;border:1px solid var(--border);margin:0">
                        <div class="text-sm text-muted">æ–‡ä»¶</div>
                        <div id="logImportMetaFile" style="font-weight:600"></div>
                    </div>
                    <div class="card" style="box-shadow:none;border:1px solid var(--border);margin:0">
                        <div class="text-sm text-muted">è¯†åˆ«æ ¼å¼</div>
                        <div id="logImportMetaFmt" style="font-weight:600"></div>
                    </div>
                    <div class="card" style="box-shadow:none;border:1px solid var(--border);margin:0">
                        <div class="text-sm text-muted">å¯å¯¼å…¥è®°å½•æ•°</div>
                        <div id="logImportMetaTotal" style="font-weight:600"></div>
                    </div>
                </div>

                <h4 style="margin:8px 0 8px 0">åŒ…å«è®¾å¤‡ä¸æ—¶é—´æ®µ</h4>
                <div class="table-wrap scroll-y" style="max-height:220px;margin-bottom:12px">
                    <table style="width:100%">
                        <thead>
                            <tr>
                                <th>è®¾å¤‡</th>
                                <th>æ¡æ•°</th>
                                <th>èµ·å§‹æ—¶é—´</th>
                                <th>ç»“æŸæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="logImportDeviceTable"></tbody>
                    </table>
                </div>

                <h4 style="margin:8px 0 8px 0">æ ·ä¾‹æ•°æ®</h4>
                <div class="table-wrap scroll-y" style="max-height:260px">
                    <table style="width:100%">
                        <thead>
                            <tr>
                                <th>UUID</th>
                                <th>æ—¶é—´</th>
                                <th>IN</th>
                                <th>OUT</th>
                                <th>ç”µé‡</th>
                                <th>Txç”µé‡</th>
                                <th>ä¿¡å·</th>
                                <th>å‘Šè­¦</th>
                            </tr>
                        </thead>
                        <tbody id="logImportSampleTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="logImportStepProgress" style="display:none">
            <div class="text-sm text-muted" style="margin-bottom:12px">æ­£åœ¨å¯¼å…¥ï¼Œè¯·å‹¿å…³é—­é¡µé¢</div>
            <div style="height:10px;border-radius:999px;background:var(--bg-subtle);border:1px solid var(--border);overflow:hidden">
                <div id="logImportProgressBar" style="height:100%;width:0%;background:var(--primary)"></div>
            </div>
            <div id="logImportProgressText" class="text-sm" style="margin-top:8px"></div>
        </div>

        <div class="actions">
            <button class="btn" id="logImportCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="logImportStart" disabled>ç¡®å®šå¯¼å…¥</button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="/static/layout.js?v=auth_v4"></script>
<script>
    initLayout('å†å²æ•°æ®');

    const els = {
        device: document.getElementById('device'),
        start: document.getElementById('start'),
        end: document.getElementById('end'),
        tbl: document.getElementById('tbl'),
        adv: document.getElementById('advancedPopup'),
        toggleAdv: document.getElementById('toggleAdvanced'),
        selectAll: document.getElementById('selectAll'),
        // Filters
        fWarn: document.getElementById('filterWarn'),
        fRec: document.getElementById('filterRecType'),
        fMin: document.getElementById('filterBtxMin'),
        fMax: document.getElementById('filterBtxMax'),
        // Edit/Add
        editModal: document.getElementById('editModal'),
        modalTitle: document.getElementById('modalTitle'),
        m_time: document.getElementById('m_time'),
        m_in: document.getElementById('m_in'),
        m_out: document.getElementById('m_out'),
        m_bat: document.getElementById('m_bat'),
        m_btx: document.getElementById('m_btx'),
        m_type: document.getElementById('m_type'),
        m_cancel: document.getElementById('m_cancel'),
        m_save: document.getElementById('m_save'),
        addBtn: document.getElementById('addRecordBtn'),
        // Batch Delete
        batchDelete: document.getElementById('batchDelete'),
        delRangeModal: document.getElementById('deleteRangeModal'),
        delStart: document.getElementById('delStart'),
        delEnd: document.getElementById('delEnd'),
        delCancel: document.getElementById('delCancel'),
        delConfirm: document.getElementById('delConfirm'),
        // Batch Edit
        batchEditBtn: document.getElementById('batchEditBtn'),
        batchEditModal: document.getElementById('batchEditModal'),
        batchCount: document.getElementById('batchCount'),
        batchTypeVal: document.getElementById('batchTypeVal'),
        batchEditCancel: document.getElementById('batchEditCancel'),
        batchEditConfirm: document.getElementById('batchEditConfirm'),
        // Merge
        mergeDataBtn: document.getElementById('mergeDataBtn'),
        mergeConfigModal: document.getElementById('mergeConfigModal'),
        mergeTargetDevice: document.getElementById('mergeTargetDevice'),
        mergeStart: document.getElementById('mergeStart'),
        mergeEnd: document.getElementById('mergeEnd'),
        mergeConfigCancel: document.getElementById('mergeConfigCancel'),
        mergeFetchBtn: document.getElementById('mergeFetchBtn'),
        
        mergeConflictModal: document.getElementById('mergeConflictModal'),
        mergeNewCount: document.getElementById('mergeNewCount'),
        mergeConflictCount: document.getElementById('mergeConflictCount'),
        mergeTableBody: document.getElementById('mergeTableBody'),
        mergeConflictCancel: document.getElementById('mergeConflictCancel'),
        mergeConfirmBtn: document.getElementById('mergeConfirmBtn')
    };

    const logImportEls = {
        openBtn: document.getElementById('dataCompletion'),
        modal: document.getElementById('logImportModal'),
        file: document.getElementById('logImportFile'),
        hint: document.getElementById('logImportHint'),
        loading: document.getElementById('logImportLoading'),
        preview: document.getElementById('logImportPreview'),
        metaFile: document.getElementById('logImportMetaFile'),
        metaFmt: document.getElementById('logImportMetaFmt'),
        metaTotal: document.getElementById('logImportMetaTotal'),
        deviceTable: document.getElementById('logImportDeviceTable'),
        sampleTable: document.getElementById('logImportSampleTable'),
        stepSelect: document.getElementById('logImportStepSelect'),
        stepProgress: document.getElementById('logImportStepProgress'),
        bar: document.getElementById('logImportProgressBar'),
        progressText: document.getElementById('logImportProgressText'),
        cancel: document.getElementById('logImportCancel'),
        start: document.getElementById('logImportStart')
    };

    let deviceMap = {};
    let currentEditId = null;
    let mergePlan = { creates: [], updates: [] }; // Stores pending actions

    let logImportState = { importing: false, importId: '', total: 0, filename: '' };

    function resetLogImportUi() {
        logImportState = { importing: false, importId: '', total: 0, filename: '' };
        if (logImportEls.file) logImportEls.file.value = '';
        if (logImportEls.loading) logImportEls.loading.style.display = 'none';
        if (logImportEls.preview) logImportEls.preview.style.display = 'none';
        if (logImportEls.stepSelect) logImportEls.stepSelect.style.display = 'block';
        if (logImportEls.stepProgress) logImportEls.stepProgress.style.display = 'none';
        if (logImportEls.bar) logImportEls.bar.style.width = '0%';
        if (logImportEls.progressText) logImportEls.progressText.textContent = '';
        if (logImportEls.deviceTable) logImportEls.deviceTable.innerHTML = '';
        if (logImportEls.sampleTable) logImportEls.sampleTable.innerHTML = '';
        if (logImportEls.start) logImportEls.start.disabled = true;
        if (logImportEls.cancel) logImportEls.cancel.disabled = false;
        if (logImportEls.file) logImportEls.file.disabled = false;
    }

    function openLogImportModal() {
        resetLogImportUi();
        if (logImportEls.modal) logImportEls.modal.classList.add('show');
    }

    function closeLogImportModal() {
        if (logImportState.importing) return;
        if (logImportEls.modal) logImportEls.modal.classList.remove('show');
    }

    function renderLogImportPreview(data) {
        logImportState.importId = data.import_id || '';
        logImportState.total = data.total_records || 0;
        logImportState.filename = data.filename || '';

        logImportEls.metaFile.textContent = data.filename || '';
        logImportEls.metaFmt.textContent = data.detected_format || '';
        logImportEls.metaTotal.textContent = String(data.total_records || 0);

        const devices = Array.isArray(data.devices) ? data.devices : [];
        logImportEls.deviceTable.innerHTML = devices.map(d => {
            const label = d.name ? `${d.name} (${d.uuid})` : (d.uuid || '');
            const cat = d.category ? ` <span class="text-muted">/ ${d.category}</span>` : '';
            return `
                <tr>
                    <td>${label}${cat}</td>
                    <td>${d.count || 0}</td>
                    <td>${d.start || ''}</td>
                    <td>${d.end || ''}</td>
                </tr>
            `;
        }).join('');

        const sample = Array.isArray(data.sample) ? data.sample : [];
        logImportEls.sampleTable.innerHTML = sample.map(r => `
            <tr>
                <td>${r.uuid || ''}</td>
                <td>${r.time || ''}</td>
                <td>${r.in_count ?? ''}</td>
                <td>${r.out_count ?? ''}</td>
                <td>${r.battery ?? ''}</td>
                <td>${r.btx ?? ''}</td>
                <td>${r.signal_strength ?? ''}</td>
                <td>${r.warn_status ?? ''}</td>
            </tr>
        `).join('');

        logImportEls.preview.style.display = 'block';
        logImportEls.start.disabled = !(logImportState.importId && logImportState.total > 0);
    }

    async function previewDeviceLogFile(file) {
        if (!file) return;
        logImportEls.loading.style.display = 'block';
        logImportEls.preview.style.display = 'none';
        logImportEls.start.disabled = true;

        try {
            const fd = new FormData();
            fd.append('file', file);
            const res = await fetch('/api/v1/admin/device-log/preview', { method: 'POST', body: fd });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            renderLogImportPreview(data);
        } catch (e) {
            await showAlert('è§£æå¤±è´¥: ' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'));
        } finally {
            logImportEls.loading.style.display = 'none';
        }
    }

    async function runLogImport() {
        if (!logImportState.importId || !logImportState.total) return;
        const ok = await showConfirm(`ç¡®è®¤å¯¼å…¥ ${logImportState.total} æ¡è®°å½•ï¼Ÿ`);
        if (!ok) return;

        logImportState.importing = true;
        logImportEls.cancel.disabled = true;
        logImportEls.file.disabled = true;
        logImportEls.start.disabled = true;
        logImportEls.stepSelect.style.display = 'none';
        logImportEls.stepProgress.style.display = 'block';

        const total = logImportState.total;
        const limit = 500;
        let offset = 0;
        let imported = 0;

        while (offset < total) {
            const res = await fetch('/api/v1/admin/device-log/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ import_id: logImportState.importId, offset: offset, limit: limit })
            });
            if (!res.ok) {
                const t = await res.text();
                logImportState.importing = false;
                logImportEls.cancel.disabled = false;
                logImportEls.stepSelect.style.display = 'block';
                logImportEls.stepProgress.style.display = 'none';
                throw new Error(t || 'å¯¼å…¥å¤±è´¥');
            }
            const data = await res.json();
            imported += data.imported || 0;
            offset = data.next_offset || (offset + limit);

            const pct = total ? Math.min(100, Math.round((imported / total) * 100)) : 0;
            logImportEls.bar.style.width = pct + '%';
            logImportEls.progressText.textContent = `å·²å¯¼å…¥ ${imported} / ${total} (${pct}%)`;
        }

        logImportState.importing = false;
        await showAlert(`å¯¼å…¥æˆåŠŸï¼š${total} æ¡è®°å½•`);
        closeLogImportModal();
        loadHistory();
    }

    if (logImportEls.openBtn) logImportEls.openBtn.addEventListener('click', openLogImportModal);
    if (logImportEls.cancel) logImportEls.cancel.addEventListener('click', closeLogImportModal);
    if (logImportEls.file) logImportEls.file.addEventListener('change', (e) => previewDeviceLogFile(e.target.files && e.target.files[0]));
    if (logImportEls.start) logImportEls.start.addEventListener('click', async () => {
        try {
            await runLogImport();
        } catch (e) {
            await showAlert('å¯¼å…¥å¤±è´¥: ' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'));
        }
    });

    async function loadDevices() {
        const mapRes = await fetch('/api/v1/devices/mapping');
        if(mapRes.ok) deviceMap = (await mapRes.json()).mapping || {};

        const res = await fetch('/api/v1/devices');
        const list = await res.json();
        
        els.device.innerHTML = list.map(d => {
            const uuid = typeof d === 'string' ? d : d.uuid;
            const entry = deviceMap[uuid];
            const name = entry ? (entry.name || uuid) : uuid;
            const display = name === uuid ? uuid : `${name} (${uuid})`;
            return `<option value="${uuid}">${display}</option>`;
        }).join('');
    }

    function fmtTime(s){ if(!s) return ''; const t = String(s).trim(); if(/^[0-9]{14}$/.test(t)) return t.slice(0,4)+'-'+t.slice(4,6)+'-'+t.slice(6,8)+' '+t.slice(8,10)+':'+t.slice(10,12)+':'+t.slice(12,14); return t; }
    function fmtTxOnline(s){return (s===0||s==='0')?'åœ¨çº¿':'ç¦»çº¿'}
    function fmtRecType(t){return (t===1||t==='1')?'å®æ—¶æ•°æ®':(t===2||t==='2')?'å†å²æ•°æ®':(t??'')}
    
    const datePicker = {
        btn: document.getElementById('dateRangeBtn'),
        label: document.getElementById('dateRangeLabel'),
        popup: document.getElementById('dateRangePopup'),
        grid: document.getElementById('calGrid'),
        yearSel: document.getElementById('calYear'),
        monthSel: document.getElementById('calMonth'),
        prev: document.getElementById('calPrev'),
        next: document.getElementById('calNext'),
        apply: document.getElementById('dateRangeApply'),
        clear: document.getElementById('dateRangeClear'),
        quickToday: document.getElementById('quickToday'),
        quickLast7: document.getElementById('quickLast7'),
        quickWeek: document.getElementById('quickWeek'),
        quickMonth: document.getElementById('quickMonth')
    };

    let calViewYear = new Date().getFullYear();
    let calViewMonth = new Date().getMonth();
    let calPickStart = '';
    let calPickEnd = '';

    function pad2(n) { return String(n).padStart(2, '0'); }
    function localYmd(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
    function parseYmd(s) {
        const parts = String(s || '').split('-').map(x => parseInt(x, 10));
        if (parts.length !== 3 || parts.some(n => Number.isNaN(n))) return null;
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    function daysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
    function mondayIndex(jsDay) { return (jsDay + 6) % 7; }
    function clampRange(a, b) {
        const s = a || '';
        const e = b || '';
        if (s && e && e < s) return [e, s];
        return [s, e];
    }
    function setRange(start, end) {
        const [s, e] = clampRange(start, end);
        els.start.value = s;
        els.end.value = e;
        updateDateLabel();
        renderCalendar();
    }
    function getRange() {
        const [s, e] = clampRange(els.start.value, els.end.value);
        return { start: s, end: e };
    }
    function updateDateLabel() {
        const { start, end } = getRange();
        if (start && end) {
            datePicker.label.textContent = `${start} è‡³ ${end}`;
            datePicker.label.classList.remove('text-muted');
        } else if (start) {
            datePicker.label.textContent = start;
            datePicker.label.classList.remove('text-muted');
        } else {
            datePicker.label.textContent = 'é€‰æ‹©æ—¥æœŸèŒƒå›´';
            datePicker.label.classList.add('text-muted');
        }
    }
    function syncCalViewFromSelection() {
        const { end, start } = getRange();
        const base = parseYmd(end || start) || new Date();
        calViewYear = base.getFullYear();
        calViewMonth = base.getMonth();
    }
    function ensureCalSelectors() {
        const nowY = new Date().getFullYear();
        const minY = nowY - 5;
        const maxY = nowY + 2;
        const years = [];
        for (let y = minY; y <= maxY; y++) years.push(y);
        if (datePicker.yearSel) {
            datePicker.yearSel.innerHTML = years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
        }
        if (datePicker.monthSel) {
            datePicker.monthSel.innerHTML = Array.from({ length: 12 }, (_, i) => `<option value="${i}">${i + 1}æœˆ</option>`).join('');
        }
    }
    function renderCalendar() {
        const wds = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
        const { start, end } = getRange();
        if (datePicker.yearSel && datePicker.monthSel) {
            if (!datePicker.yearSel.options.length || !datePicker.monthSel.options.length) ensureCalSelectors();
            datePicker.yearSel.value = String(calViewYear);
            datePicker.monthSel.value = String(calViewMonth);
        }
        datePicker.grid.innerHTML = '';

        for (const wd of wds) {
            const el = document.createElement('div');
            el.className = 'cal-wd';
            el.textContent = wd;
            datePicker.grid.appendChild(el);
        }

        const first = new Date(calViewYear, calViewMonth, 1);
        const lead = mondayIndex(first.getDay());
        for (let i = 0; i < lead; i++) {
            const el = document.createElement('div');
            datePicker.grid.appendChild(el);
        }

        const dim = daysInMonth(calViewYear, calViewMonth);
        for (let day = 1; day <= dim; day++) {
            const d = new Date(calViewYear, calViewMonth, day);
            const ds = localYmd(d);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'cal-day';
            btn.textContent = String(day);

            const inRange = start && end && ds >= start && ds <= end;
            const isSelected = (start && ds === start) || (end && ds === end);
            if (inRange) btn.classList.add('in-range');
            if (isSelected) btn.classList.add('selected');

            btn.addEventListener('click', () => {
                if (!calPickStart || (calPickStart && calPickEnd)) {
                    calPickStart = ds;
                    calPickEnd = '';
                    setRange(calPickStart, '');
                    return;
                }
                calPickEnd = ds;
                const [s, e] = clampRange(calPickStart, calPickEnd);
                setRange(s, e);
            });

            datePicker.grid.appendChild(btn);
        }
    }

    function setupDatePopup() {
        datePicker.btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const { start, end } = getRange();
            calPickStart = start;
            calPickEnd = end;
            syncCalViewFromSelection();
            ensureCalSelectors();
            renderCalendar();
            datePicker.popup.classList.toggle('show');
        });
        datePicker.popup.addEventListener('click', (e) => e.stopPropagation());
        document.addEventListener('click', () => datePicker.popup.classList.remove('show'));
    }

    datePicker.prev.addEventListener('click', () => {
        if (calViewMonth === 0) {
            calViewMonth = 11;
            calViewYear -= 1;
        } else {
            calViewMonth -= 1;
        }
        renderCalendar();
    });
    datePicker.next.addEventListener('click', () => {
        if (calViewMonth === 11) {
            calViewMonth = 0;
            calViewYear += 1;
        } else {
            calViewMonth += 1;
        }
        renderCalendar();
    });
    datePicker.clear.addEventListener('click', () => {
        calPickStart = '';
        calPickEnd = '';
        setRange('', '');
    });
    if (datePicker.yearSel) {
        datePicker.yearSel.addEventListener('change', () => {
            calViewYear = parseInt(datePicker.yearSel.value, 10);
            renderCalendar();
        });
    }
    if (datePicker.monthSel) {
        datePicker.monthSel.addEventListener('change', () => {
            calViewMonth = parseInt(datePicker.monthSel.value, 10);
            renderCalendar();
        });
    }
    datePicker.apply.addEventListener('click', async () => {
        const { start, end } = getRange();
        if (start && !end) setRange(start, start);
        datePicker.popup.classList.remove('show');
        await loadHistory();
    });
    datePicker.quickToday.addEventListener('click', async () => {
        const d = localYmd(new Date());
        calPickStart = d;
        calPickEnd = d;
        setRange(d, d);
        datePicker.popup.classList.remove('show');
        await loadHistory();
    });
    datePicker.quickLast7.addEventListener('click', async () => {
        const now = new Date();
        const end = localYmd(now);
        const start = localYmd(new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6));
        calPickStart = start;
        calPickEnd = end;
        setRange(start, end);
        datePicker.popup.classList.remove('show');
        await loadHistory();
    });
    datePicker.quickWeek.addEventListener('click', async () => {
        const now = new Date();
        const day = mondayIndex(now.getDay());
        const startD = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
        const endD = new Date(startD.getFullYear(), startD.getMonth(), startD.getDate() + 6);
        const start = localYmd(startD);
        const end = localYmd(endD);
        calPickStart = start;
        calPickEnd = end;
        setRange(start, end);
        datePicker.popup.classList.remove('show');
        await loadHistory();
    });
    datePicker.quickMonth.addEventListener('click', async () => {
        const now = new Date();
        const startD = new Date(now.getFullYear(), now.getMonth(), 1);
        const endD = new Date(now.getFullYear(), now.getMonth(), daysInMonth(now.getFullYear(), now.getMonth()));
        const start = localYmd(startD);
        const end = localYmd(endD);
        calPickStart = start;
        calPickEnd = end;
        setRange(start, end);
        datePicker.popup.classList.remove('show');
        await loadHistory();
    });

    updateDateLabel();
    syncCalViewFromSelection();
    ensureCalSelectors();
    renderCalendar();
    setupDatePopup();

    async function loadHistory() {
        const uuid = els.device.value;
        if(!uuid) return;
        
        const q = new URLSearchParams({uuid});
        if(els.start.value) q.append('start', els.start.value + ' 00:00:00');
        if(els.end.value) q.append('end', els.end.value + ' 23:59:59');
        if(els.fWarn.value) q.append('warn_status', els.fWarn.value);
        if(els.fRec.value) q.append('rec_type', els.fRec.value);
        if(els.fMin.value) q.append('batterytx_min', els.fMin.value);
        if(els.fMax.value) q.append('batterytx_max', els.fMax.value);
        
        const res = await fetch('/api/v1/records/history?' + q.toString());
        if(!res.ok) {
             console.error("Fetch history failed", res.status);
             return;
        }
        const rows = await res.json();
        if(!Array.isArray(rows)) {
            console.error("History data is not an array", rows);
            return;
        }
        
        els.tbl.innerHTML = rows.map(r => `
            <tr>
                <td><input type="checkbox" class="row-check" value="${r.id}"></td>
                <td>${fmtTime(r.time)}</td>
                <td>${r.in_count??r.in??''}</td>
                <td>${r.out_count??r.out??''}</td>
                <td>${r.battery_level??''}</td>
                <td>${fmtTxOnline(r.warn_status)}</td>
                <td>${r.batterytx_level??''}</td>
                <td>${fmtRecType(r.rec_type)}</td>
                <td>${r.activity_type || ''}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="onEdit('${r.id}', this)">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" onclick="onDel('${r.id}')">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        
        // Reset select all
        els.selectAll.checked = false;
    }

    document.getElementById('query').addEventListener('click', loadHistory);
    document.getElementById('reset').addEventListener('click', () => {
        els.device.selectedIndex = 0;
        setRange('', '');
        els.fWarn.value = ''; els.fRec.value = '';
        els.fMin.value = ''; els.fMax.value = '';
        loadHistory();
    });
    els.toggleAdv.addEventListener('click', () => {
        els.adv.style.display = els.adv.style.display === 'none' ? 'block' : 'none';
    });
    
    // Select All
    els.selectAll.addEventListener('change', (e) => {
        document.querySelectorAll('.row-check').forEach(c => c.checked = e.target.checked);
    });

    // --- Edit ---
    window.onEdit = (id, btn) => {
        currentEditId = id;
        els.modalTitle.textContent = 'ç¼–è¾‘è®°å½•';
        const tds = btn.closest('tr').querySelectorAll('td');
        // tds[0] is checkbox
        const t = tds[1].innerText.replace(' ', 'T');
        els.m_time.value = t;
        els.m_in.value = tds[2].innerText;
        els.m_out.value = tds[3].innerText;
        els.m_bat.value = tds[4].innerText;
        els.m_btx.value = tds[6].innerText;
        els.m_type.value = tds[8].innerText;
        els.editModal.classList.add('show');
    };

    // --- Add ---
    els.addBtn.addEventListener('click', () => {
        currentEditId = null;
        els.modalTitle.textContent = 'æ·»åŠ è®°å½•';
        // Default time to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        els.m_time.value = now.toISOString().slice(0,16);
        els.m_in.value = 0;
        els.m_out.value = 0;
        els.m_bat.value = 100;
        els.m_btx.value = 100;
        els.m_type.value = '';
        els.editModal.classList.add('show');
    });

    els.m_cancel.addEventListener('click', () => els.editModal.classList.remove('show'));
    
    els.m_save.addEventListener('click', async () => {
        const timeVal = els.m_time.value.replace('T', ' ').replace(/-/g, '').replace(/:/g, '') + '00';
        const payload = {
            time: timeVal,
            in_count: parseInt(els.m_in.value),
            out_count: parseInt(els.m_out.value),
            battery_level: parseInt(els.m_bat.value),
            batterytx_level: parseInt(els.m_btx.value),
            activity_type: els.m_type.value
        };

        let url = '/api/v1/admin/records';
        let method = 'POST';

        if (currentEditId) {
            url = '/api/v1/admin/records/' + currentEditId;
            method = 'PUT';
        } else {
            const uuid = els.device.value;
            if(!uuid) return showAlert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
            payload.uuid = uuid;
            // Default fields for create
            payload.rec_type = 2; // History
            payload.signal_strength = 0;
            payload.warn_status = 0;
        }

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            els.editModal.classList.remove('show');
            loadHistory();
        } else {
            const msg = await res.text();
            await showAlert('ä¿å­˜å¤±è´¥: ' + msg);
        }
    });

    // --- Delete ---
    window.onDel = async (id) => {
        if(!await showConfirm('ç¡®è®¤åˆ é™¤?')) return;
        const res = await fetch('/api/v1/admin/records/' + id, {
            method: 'DELETE'
        });
        if(res.ok) loadHistory();
        else await showAlert('åˆ é™¤å¤±è´¥');
    };

    // --- Batch Delete ---
    els.batchDelete.addEventListener('click', () => els.delRangeModal.classList.add('show'));
    els.delCancel.addEventListener('click', () => els.delRangeModal.classList.remove('show'));
    els.delConfirm.addEventListener('click', async () => {
        if(!await showConfirm('ç¡®å®šè¦åˆ é™¤è¯¥æ—¶é—´æ®µçš„æ•°æ®å—ï¼Ÿä¸å¯æ¢å¤ï¼')) return;
        // Format: YYYYMMDDHHMMSS
        const s = els.delStart.value.replace(/[-T:]/g, '') + '00';
        const e = els.delEnd.value.replace(/[-T:]/g, '') + '00';
        
        const q = new URLSearchParams({start: s, end: e});
        const res = await fetch('/api/v1/admin/records/range?' + q.toString(), {
            method: 'DELETE'
        });
        if(res.ok) {
            els.delRangeModal.classList.remove('show');
            loadHistory();
        } else {
            await showAlert('åˆ é™¤å¤±è´¥');
        }
    });

    // --- Batch Edit ---
    const elsBatch = {
        radios: document.getElementsByName('batchScope'),
        filterOpts: document.getElementById('batchFilterOptions'),
        checkCount: document.getElementById('batchCheckCount'),
        filterCount: document.getElementById('batchFilterCount'),
        start: document.getElementById('batchStart'),
        end: document.getElementById('batchEnd'),
        device: document.getElementById('batchDevice'),
        // Inputs
        in: document.getElementById('batch_in'),
        out: document.getElementById('batch_out'),
        bat: document.getElementById('batch_bat'),
        btx: document.getElementById('batch_btx'),
        rec_type: document.getElementById('batch_rec_type'),
        status: document.getElementById('batch_status'),
        act_type: document.getElementById('batch_act_type'),
        delFlag: document.getElementById('batchDeleteFlag')
    };

    els.batchEditBtn.addEventListener('click', () => {
        const checked = document.querySelectorAll('.row-check:checked');
        els.batchCount.textContent = checked.length;
        
        // Init UI
        elsBatch.radios[0].checked = true;
        elsBatch.filterOpts.style.display = 'none';
        
        // Populate devices if needed
        if(elsBatch.device.children.length === 0) {
             elsBatch.device.innerHTML = '<option value="">-- æ‰€æœ‰è®¾å¤‡ --</option>' + els.device.innerHTML;
        }
        
        els.batchEditModal.classList.add('show');
    });
    
    elsBatch.radios.forEach(r => {
        r.addEventListener('change', () => {
            elsBatch.filterOpts.style.display = (r.value === 'filter') ? 'block' : 'none';
        });
    });

    elsBatch.checkCount.addEventListener('click', async () => {
        const s = elsBatch.start.value ? elsBatch.start.value.replace('T', ' ') : '';
        const e = elsBatch.end.value ? elsBatch.end.value.replace('T', ' ') : '';
        const uuid = elsBatch.device.value;
        
        const q = new URLSearchParams({start: s, end: e, uuid: uuid, size: 1}); 
        try {
            const res = await fetch('/api/v1/admin/records?' + q.toString());
            const data = await res.json();
            elsBatch.filterCount.textContent = `åŒ¹é… ${data.total} æ¡`;
        } catch(e) {
            elsBatch.filterCount.textContent = 'æŸ¥è¯¢å‡ºé”™';
        }
    });

    els.batchEditCancel.addEventListener('click', () => els.batchEditModal.classList.remove('show'));
    
    els.batchEditConfirm.addEventListener('click', async () => {
        const scope = Array.from(elsBatch.radios).find(r => r.checked).value;
        let ids = [];
        
        if(scope === 'selection') {
            const checked = document.querySelectorAll('.row-check:checked');
            if(checked.length === 0) return showAlert('è¯·å…ˆé€‰æ‹©è®°å½•');
            ids = Array.from(checked).map(c => c.value);
        } else {
            const s = elsBatch.start.value ? elsBatch.start.value.replace('T', ' ') : '';
            const e = elsBatch.end.value ? elsBatch.end.value.replace('T', ' ') : '';
            const uuid = elsBatch.device.value;
            
            // Call ID fetch endpoint
            const q = new URLSearchParams({start: s, end: e, uuid: uuid});
            try {
                const res = await fetch('/api/v1/admin/records/ids?' + q.toString());
                if(!res.ok) throw new Error('æŸ¥è¯¢IDå¤±è´¥');
                const data = await res.json();
                ids = data.ids;
            } catch(err) {
                return showAlert(err.message);
            }
            
            if(ids.length === 0) return showAlert('æœªæ‰¾åˆ°åŒ¹é…è®°å½•');
            if(!await showConfirm(`ç¡®è®¤ä¿®æ”¹ç­›é€‰å‡ºçš„ ${ids.length} æ¡è®°å½•?`)) return;
        }
        
        // Delete Check
        if(elsBatch.delFlag.checked) {
             if(!await showConfirm(`è­¦å‘Š: ç¡®å®šè¦åˆ é™¤è¿™ ${ids.length} æ¡è®°å½•å—? æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
             const res = await fetch('/api/v1/admin/records/batch-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids })
             });
             if(res.ok) {
                 els.batchEditModal.classList.remove('show');
                 loadHistory();
                 showAlert('æ‰¹é‡åˆ é™¤æˆåŠŸ');
             } else {
                 showAlert('æ‰¹é‡åˆ é™¤å¤±è´¥');
             }
             return;
        }

        // Build updates
        const updates = {};
        if(elsBatch.in.value) updates.in_count = parseInt(elsBatch.in.value);
        if(elsBatch.out.value) updates.out_count = parseInt(elsBatch.out.value);
        if(elsBatch.bat.value) updates.battery = parseInt(elsBatch.bat.value);
        if(elsBatch.btx.value) updates.btx = parseInt(elsBatch.btx.value);
        if(elsBatch.rec_type.value) updates.rec_type = parseInt(elsBatch.rec_type.value);
        if(elsBatch.status.value) updates.warn_status = parseInt(elsBatch.status.value);
        if(elsBatch.act_type.value) updates.activity_type = elsBatch.act_type.value;
        
        if(Object.keys(updates).length === 0) return showAlert('æœªè®¾ç½®ä»»ä½•ä¿®æ”¹å€¼');
        
        const res = await fetch('/api/v1/admin/records/batch-update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ids: ids,
                updates: updates
            })
        });
        
        if(res.ok) {
            els.batchEditModal.classList.remove('show');
            loadHistory();
            showAlert('æ‰¹é‡ä¿®æ”¹æˆåŠŸ');
        } else {
            await showAlert('æ‰¹é‡ä¿®æ”¹å¤±è´¥');
        }
    });

    // --- Merge Data ---
    els.mergeDataBtn.addEventListener('click', () => {
        // Populate device select
        els.mergeTargetDevice.innerHTML = els.device.innerHTML;
        els.mergeTargetDevice.value = els.device.value;
        
        // Default range: last 7 days
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - 7);
        
        els.mergeStart.value = start.toISOString().slice(0,16);
        els.mergeEnd.value = end.toISOString().slice(0,16);
        
        els.mergeConfigModal.classList.add('show');
    });
    els.mergeConfigCancel.addEventListener('click', () => els.mergeConfigModal.classList.remove('show'));
    
    els.mergeFetchBtn.addEventListener('click', async () => {
        const uuid = els.mergeTargetDevice.value;
        
        if(!uuid) return showAlert('è¯·é€‰æ‹©è®¾å¤‡');
        
        const s = els.mergeStart.value.replace('T', ' ') + ':00';
        const e = els.mergeEnd.value.replace('T', ' ') + ':00';
        
        // 1. Fetch Remote Data (From Device via Backend)
        let remoteData = [];
        try {
            const res = await fetch('/api/v1/admin/sync/fetch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    uuid: uuid,
                    start: s,
                    end: e
                })
            });
            if(!res.ok) throw new Error(await res.text());
            const data = await res.json();
            remoteData = Array.isArray(data) ? data : (data.data || []); 
        } catch(err) {
            return showAlert('è·å–è®¾å¤‡æ•°æ®å¤±è´¥: ' + err.message);
        }
        
        if(remoteData.length === 0) return showAlert('è¯¥æ—¶é—´æ®µæ— æºæ•°æ®');
        
        // 2. Fetch Local for comparison
        const localQ = new URLSearchParams({uuid, start: s, end: e, limit: 10000});
        const localRes = await fetch('/api/v1/records/history?' + localQ);
        if(!localRes.ok) return showAlert('è·å–æœ¬åœ°æ•°æ®å¤±è´¥');
        const localData = await localRes.json();
        if(!Array.isArray(localData)) return showAlert('æœ¬åœ°æ•°æ®æ ¼å¼é”™è¯¯');
        
        // 3. Compare
        // Map local by time
        const localMap = {};
        localData.forEach(r => {
            // Ensure format matches. Remote usually returns 'YYYY-MM-DD HH:MM:SS'.
            // Local DB might return same.
            localMap[r.time] = r;
        });
        
        const conflicts = [];
        const newItems = [];
        
        remoteData.forEach(r => {
            const l = localMap[r.time];
            if(!l) {
                // New
                newItems.push(r);
            } else {
                // Check conflict
                // Compare in_count, out_count, battery, etc.
                // Assuming battery_level in remote maps to battery_level in local (or battery)
                // Remote keys based on doc: in_count, out_count, time, battery_level, signal_status
                // Local keys: in_count, out_count, time, battery_level, signal_strength
                
                // Normalize remote
                const r_bat = r.battery_level ?? r.battery;
                const l_bat = l.battery_level ?? l.battery;
                
                if (r.in_count != l.in_count || r.out_count != l.out_count || r_bat != l_bat) {
                    conflicts.push({remote: r, local: l});
                }
            }
        });
        
        if(newItems.length === 0 && conflicts.length === 0) {
            return showAlert('æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€åˆå¹¶');
        }
        
        // 4. Show Conflict UI
        els.mergeConfigModal.classList.remove('show');
        
        els.mergeNewCount.textContent = newItems.length;
        els.mergeConflictCount.textContent = conflicts.length;
        
        let html = '';
        
        // New items preview (limit 10)
        if(newItems.length > 0) {
            html += `<tr style="background:#f6ffed"><td colspan="6" style="font-weight:bold;text-align:center">æ–°å¢æ•°æ® (${newItems.length} æ¡) - é»˜è®¤å¯¼å…¥</td></tr>`;
            newItems.slice(0, 5).forEach(r => {
                html += `<tr style="opacity:0.7">
                    <td><input type="checkbox" checked disabled></td>
                    <td>${r.time}</td>
                    <td colspan="4">IN:${r.in_count}, OUT:${r.out_count}</td>
                </tr>`;
            });
            if(newItems.length > 5) html += `<tr><td colspan="6" style="text-align:center;color:#999">...è¿˜æœ‰ ${newItems.length - 5} æ¡...</td></tr>`;
        }
        
        // Conflicts
        if(conflicts.length > 0) {
            html += `<tr style="background:#fff7e6"><td colspan="6" style="font-weight:bold;text-align:center">å†²çªæ•°æ® (${conflicts.length} æ¡) - è¯·é€‰æ‹©å¤„ç†æ–¹å¼</td></tr>`;
            conflicts.forEach((c, idx) => {
                const r = c.remote;
                const l = c.local;
                html += `
                <tr>
                    <td><input type="checkbox" class="merge-check" data-idx="${idx}"></td>
                    <td>${r.time}</td>
                    <td>
                        <div>IN</div><div>OUT</div><div>ç”µé‡</div>
                    </td>
                    <td style="color:#666">
                        <div>${l.in_count}</div><div>${l.out_count}</div><div>${l.battery_level??l.battery}</div>
                    </td>
                    <td style="color:#1890ff;font-weight:bold">
                        <div>${r.in_count}</div><div>${r.out_count}</div><div>${r.battery_level??r.battery}</div>
                    </td>
                    <td>
                        <span style="font-size:12px;color:#999">å‹¾é€‰è¦†ç›–</span>
                    </td>
                </tr>`;
            });
        }
        
        els.mergeTableBody.innerHTML = html;
        
        // Store plan context
        mergePlan = { creates: newItems, conflicts: conflicts };
        
        els.mergeConflictModal.classList.add('show');
    });
    
    els.mergeConflictCancel.addEventListener('click', () => els.mergeConflictModal.classList.remove('show'));
    
    els.mergeConfirmBtn.addEventListener('click', async () => {
        // Build updates from conflicts
        const updates = [];
        document.querySelectorAll('.merge-check:checked').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            const c = mergePlan.conflicts[idx];
            // Prepare update payload using remote values
            // Need ID from local to update
            const up = {
                id: c.local.id,
                time: c.remote.time,
                in_count: c.remote.in_count,
                out_count: c.remote.out_count,
                battery_level: c.remote.battery_level ?? c.remote.battery,
                // remote might not have signal/btx, keep local or update if present
                // signal_status -> signal_strength
                signal_strength: c.remote.signal_status ?? c.remote.signal_strength
            };
            updates.push(up);
        });
        
        const payload = {
            creates: mergePlan.creates.map(r => ({
                uuid: els.mergeTargetDevice.value,
                time: r.time,
                in_count: r.in_count,
                out_count: r.out_count,
                battery_level: r.battery_level ?? r.battery,
                signal_strength: r.signal_status ?? r.signal_strength,
                rec_type: 2 // History
            })),
            updates: updates
        };
        
        const res = await fetch('/api/v1/admin/record/batch-save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if(res.ok) {
            els.mergeConflictModal.classList.remove('show');
            await showAlert('åˆå¹¶æˆåŠŸ');
            loadHistory();
        } else {
            await showAlert('åˆå¹¶å¤±è´¥');
        }
    });

    (async () => {
        await loadDevices();
        loadHistory();
    })();

</script>
</body>
</html>
