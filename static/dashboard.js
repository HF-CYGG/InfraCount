document.body.setAttribute('data-theme',(localStorage.getItem('theme')||'light'));
document.querySelectorAll('.sidebar a').forEach(a=>{if(a.getAttribute('href')===location.pathname){a.classList.add('active');}});
document.getElementById('themeToggle').addEventListener('click',()=>{const cur=document.body.getAttribute('data-theme')||'light';const nxt=cur==='light'?'dark':'light';document.body.setAttribute('data-theme',nxt);localStorage.setItem('theme',nxt);});
const deviceSel=document.getElementById('device');const startEl=document.getElementById('start');const endEl=document.getElementById('end');const autoEl=document.getElementById('auto');const tbl=document.getElementById('tbl');const filterWarn=document.getElementById('filterWarn');const filterRecType=document.getElementById('filterRecType');const filterBtxMin=document.getElementById('filterBtxMin');const filterBtxMax=document.getElementById('filterBtxMax');let dailyChart,hourChart,timer,fetchCtl;function fmtTime(s){if(!s)return'';const t=String(s).trim();if(/^[0-9]{14}$/.test(t))return t.slice(0,4)+'-'+t.slice(4,6)+'-'+t.slice(6,8)+' '+t.slice(8,10)+':'+t.slice(10,12)+':'+t.slice(12,14);return t;}function fmtSignal(s){return (s===0||s==='0')?'在线':'离线'}window.addEventListener('load',()=>{(async()=>{try{await loadDevices();await loadStats();if(typeof Chart==='undefined'){const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';s.onload=()=>loadStats();document.head.appendChild(s);}}catch(e){}})();});
async function loadDevices(){const res=await fetch('/api/v1/devices');const list=await res.json();deviceSel.innerHTML='';for(const d of list){const opt=document.createElement('option');opt.value=d.uuid;opt.textContent=(d.name? `${d.name} (${d.uuid})`:d.uuid);deviceSel.appendChild(opt);}}
async function loadAllTotals(){const r=await fetch('/api/v1/stats/total');if(!r.ok)return;const j=await r.json();document.getElementById('allTotals').textContent='全部设备 IN: '+(j.in_total||0)+'  OUT: '+(j.out_total||0)}
async function loadStats(){const uuid=deviceSel.value;const today=new Date().toISOString().slice(0,10);const startDate=startEl.value|| (endEl.value? '' : new Date(Date.now()-29*24*3600*1000).toISOString().slice(0,10));const endDate=endEl.value|| today;const start=startDate? startDate+' 00:00:00':'';const end=endDate? endDate+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);const sumRes=await fetch('/api/v1/stats/summary?'+new URLSearchParams({uuid}).toString());const sum=await sumRes.json();document.getElementById('sum_in').innerText='IN总计：'+(sum.in_total||0);document.getElementById('sum_out').innerText='OUT总计：'+(sum.out_total||0);document.getElementById('sum_net').innerText='净流量：'+((sum.in_total||0)-(sum.out_total||0));document.getElementById('sum_last').innerText='最近上报：'+fmtTime(sum.last_time||'')+' IN='+(sum.last_in??'')+' OUT='+(sum.last_out??'');const res=await fetch('/api/v1/stats/daily?'+q.toString());const daily=await res.json();const lab=daily.map(x=>x.day);const inData=daily.map(x=>x.in_total||0);const outData=daily.map(x=>x.out_total||0);try{if(typeof Chart!=='undefined'){const ctx=document.getElementById('dailyChart').getContext('2d');if(dailyChart)dailyChart.destroy();dailyChart=new Chart(ctx,{type:'line',data:{labels:lab,datasets:[{label:'IN',data:inData,borderColor:'#2b8a3e'},{label:'OUT',data:outData,borderColor:'#d9480f'}]},options:{responsive:true,maintainAspectRatio:false}});}}catch(e){}const hq=new URLSearchParams({uuid,date:endDate});const hres=await fetch('/api/v1/stats/hourly?'+hq.toString());const hourly=await hres.json();const hLab=hourly.map(x=>x.hour);const hIn=hourly.map(x=>x.in_total||0);const hOut=hourly.map(x=>x.out_total||0);try{if(typeof Chart!=='undefined'){const hctx=document.getElementById('hourChart').getContext('2d');if(hourChart)hourChart.destroy();hourChart=new Chart(hctx,{type:'bar',data:{labels:hLab,datasets:[{label:'IN',data:hIn,backgroundColor:'#74c69d'},{label:'OUT',data:hOut,backgroundColor:'#f48c06'}]},options:{responsive:true,maintainAspectRatio:false}});}}catch(e){}const tRes=await fetch('/api/v1/data/history?'+q.toString()+'&limit=50');const tData=await tRes.json();tbl.innerHTML='';for(const r of tData){const tr=document.createElement('tr');tr.innerHTML=`<td>${fmtTime(r.time)}</td><td>${r.in_count??r.in??''}</td><td>${r.out_count??r.out??''}</td><td>${r.battery_level??''}</td><td>${fmtSignal(r.signal_status)}</td><td>${r.batterytx_level??''}</td><td>${(r.rec_type===1||r.rec_type==='1')?'实时数据':(r.rec_type===2||r.rec_type==='2')?'历史数据':''}</td>`;tbl.appendChild(tr);}}
document.getElementById('load').addEventListener('click',async(e)=>{const b=e.currentTarget;b.classList.add('loading');await loadStats();await loadAllTotals();b.classList.remove('loading');});
document.getElementById('today').addEventListener('click',async(e)=>{const b=e.currentTarget;const d=new Date().toISOString().slice(0,10);startEl.value=d;endEl.value=d;b.classList.add('loading');await loadStats();await loadAllTotals();b.classList.remove('loading');});
document.getElementById('last7').addEventListener('click',async(e)=>{const b=e.currentTarget;const now=new Date();const end=now.toISOString().slice(0,10);const start=new Date(now.getTime()-6*24*3600*1000).toISOString().slice(0,10);startEl.value=start;endEl.value=end;b.classList.add('loading');await loadStats();await loadAllTotals();b.classList.remove('loading');});
document.getElementById('resetFilter').addEventListener('click',async(e)=>{const b=e.currentTarget;deviceSel.selectedIndex=0;startEl.value='';endEl.value='';if(filterWarn)filterWarn.value='';if(filterRecType)filterRecType.value='';if(filterBtxMin)filterBtxMin.value='';if(filterBtxMax)filterBtxMax.value='';autoEl.checked=false;if(timer)clearInterval(timer);b.classList.add('loading');await loadStats();await loadAllTotals();b.classList.remove('loading');});
autoEl.addEventListener('change',()=>{if(autoEl.checked){timer=setInterval(()=>{loadStats();loadAllTotals()},10000);}else{clearInterval(timer);}});
document.getElementById('exportDaily').addEventListener('click',()=>{const uuid=deviceSel.value;const start=startEl.value? startEl.value+' 00:00:00':'';const end=endEl.value? endEl.value+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);window.open('/api/v1/export/daily?'+q.toString(),'_blank');});
document.getElementById('exportHourly').addEventListener('click',()=>{const uuid=deviceSel.value;const date=endEl.value||new Date().toISOString().slice(0,10);window.open('/api/v1/export/hourly?'+new URLSearchParams({uuid,date}).toString(),'_blank');});
document.getElementById('exportHistory').addEventListener('click',()=>{const uuid=deviceSel.value;const start=startEl.value? startEl.value+' 00:00:00':'';const end=endEl.value? endEl.value+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);if(filterWarn&&filterWarn.value)q.append('warn_status',filterWarn.value);if(filterRecType&&filterRecType.value)q.append('rec_type',filterRecType.value);if(filterBtxMin&&filterBtxMin.value)q.append('batterytx_min',filterBtxMin.value);if(filterBtxMax&&filterBtxMax.value)q.append('batterytx_max',filterBtxMax.value);window.open('/api/v1/export/history?'+q.toString(),'_blank');});
(async()=>{await loadDevices();await loadStats();await loadAllTotals();})();
document.getElementById('runToastTests').addEventListener('click',()=>{const types=['info','success','warning','error'];const tr=document.getElementById('toastRoot');if(!tr)return;types.forEach((t,i)=>{setTimeout(()=>{const d=document.createElement('div');d.className='toast toast-'+t;const m=document.createElement('div');m.className='msg';m.textContent='测试 '+t;const c=document.createElement('button');c.className='close';c.textContent='×';d.appendChild(m);d.appendChild(c);tr.appendChild(d);requestAnimationFrame(()=>{d.classList.add('enter')});setTimeout(()=>{d.classList.remove('enter');d.classList.add('leave');setTimeout(()=>{if(d.parentNode)tr.removeChild(d)},300)},3000);c.addEventListener('click',()=>{d.classList.remove('enter');d.classList.add('leave');setTimeout(()=>{if(d.parentNode)tr.removeChild(d)},300)});},i*300)})});
document.getElementById('runAnimPerf').addEventListener('click',()=>{let frames=0;const start=performance.now();function step(ts){frames++;if(ts-start<1000){requestAnimationFrame(step);}else{const tr=document.getElementById('toastRoot');if(!tr)return;const d=document.createElement('div');d.className='toast toast-info';const m=document.createElement('div');m.className='msg';m.textContent='1s帧数:'+frames;const c=document.createElement('button');c.className='close';c.textContent='×';d.appendChild(m);d.appendChild(c);tr.appendChild(d);requestAnimationFrame(()=>{d.classList.add('enter')});setTimeout(()=>{d.classList.remove('enter');d.classList.add('leave');setTimeout(()=>{if(d.parentNode)tr.removeChild(d)},300)},3000);c.addEventListener('click',()=>{d.classList.remove('enter');d.classList.add('leave');setTimeout(()=>{if(d.parentNode)tr.removeChild(d)},300)});}}requestAnimationFrame(step)});
document.getElementById('refreshLatest').addEventListener('click',loadLatest);
document.getElementById('load').addEventListener('click',()=>{const v={device:deviceSel.value,start:startEl.value,end:endEl.value,warn:filterWarn?filterWarn.value:'',rectype:filterRecType?filterRecType.value:'',btxmin:filterBtxMin?filterBtxMin.value:'',btxmax:filterBtxMax?filterBtxMax.value:'',auto:autoEl?autoEl.checked:false};localStorage.setItem('dashboardFilters',JSON.stringify(v));},{capture:true});
document.getElementById('today').addEventListener('click',()=>{const d=new Date().toISOString().slice(0,10);startEl.value=d;endEl.value=d;const v={device:deviceSel.value,start:startEl.value,end:endEl.value,warn:filterWarn?filterWarn.value:'',rectype:filterRecType?filterRecType.value:'',btxmin:filterBtxMin?filterBtxMin.value:'',btxmax:filterBtxMax?filterBtxMax.value:'',auto:autoEl?autoEl.checked:false};localStorage.setItem('dashboardFilters',JSON.stringify(v));},{capture:true});
document.getElementById('last7').addEventListener('click',()=>{const now=new Date();const end=now.toISOString().slice(0,10);const start=new Date(now.getTime()-6*24*3600*1000).toISOString().slice(0,10);startEl.value=start;endEl.value=end;const v={device:deviceSel.value,start:startEl.value,end:endEl.value,warn:filterWarn?filterWarn.value:'',rectype:filterRecType?filterRecType.value:'',btxmin:filterBtxMin?filterBtxMin.value:'',btxmax:filterBtxMax?filterBtxMax.value:'',auto:autoEl?autoEl.checked:false};localStorage.setItem('dashboardFilters',JSON.stringify(v));},{capture:true});
document.getElementById('resetFilter').addEventListener('click',()=>{localStorage.removeItem('dashboardFilters');},{capture:true});
if(autoEl)autoEl.addEventListener('change',()=>{const v={device:deviceSel.value,start:startEl.value,end:endEl.value,warn:filterWarn?filterWarn.value:'',rectype:filterRecType?filterRecType.value:'',btxmin:filterBtxMin?filterBtxMin.value:'',btxmax:filterBtxMax?filterBtxMax.value:'',auto:autoEl?autoEl.checked:false};localStorage.setItem('dashboardFilters',JSON.stringify(v));});
let debounceT;function debounceSave(){if(debounceT)clearTimeout(debounceT);debounceT=setTimeout(()=>{const v={device:deviceSel.value,start:startEl.value,end:endEl.value,warn:filterWarn?filterWarn.value:'',rectype:filterRecType?filterRecType.value:'',btxmin:filterBtxMin?filterBtxMin.value:'',btxmax:filterBtxMax?filterBtxMax.value:'',auto:autoEl?autoEl.checked:false};localStorage.setItem('dashboardFilters',JSON.stringify(v));},200);}startEl.addEventListener('change',debounceSave);endEl.addEventListener('change',debounceSave);
async function loadLatest(){const uuid=deviceSel.value;await loadStats();const r=await fetch('/api/v1/data/latest?'+new URLSearchParams({uuid}).toString());const x=await r.json();const t=fmtTime(x.time||'');const inc=x.in_count??x.in??'';const outc=x.out_count??x.out??'';document.getElementById('sum_last').textContent='最近上报：'+t+' IN='+inc+' OUT='+outc;await fetch('/api/v1/device/time-sync/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuid})});}
function fmtTxOnline(s){return (s===0||s==='0')?'在线':'离线'}
function fmtRecType(t){return (t===1||t==='1')?'实时数据':(t===2||t==='2')?'历史数据':(t??'')}
