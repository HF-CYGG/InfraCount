# ğŸ”§ çº¢å¤–è®¡æ•°è®¾å¤‡åç«¯æœåŠ¡å™¨å¼€å‘æ–‡æ¡£ï¼ˆV1.0ï¼‰

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

çº¢å¤–è®¡æ•°è®¾å¤‡ç”¨äºç»Ÿè®¡äººå‘˜å‡ºå…¥æ•°é‡ï¼Œæ¯å°è®¾å¤‡é€šè¿‡ TCPï¼ˆç«¯å£ 8085ï¼‰ä¸ŠæŠ¥ XML
æ ¼å¼æ•°æ®ã€‚\
åç«¯æœåŠ¡å™¨éœ€æ¥æ”¶è®¾å¤‡æ•°æ®ã€è§£ææŠ¥æ–‡ã€å­˜å‚¨ç»“æœï¼Œå¹¶æä¾›æŸ¥è¯¢ä¸ç›‘æ§æ¥å£ã€‚

### 1.2 ç³»ç»Ÿç›®æ ‡

-   æ”¯æŒ 160+ çº¢å¤–è®¡æ•°è®¾å¤‡åŒæ—¶æ¥å…¥ï¼›
-   å…¼å®¹åè®®ä¸­å®šä¹‰çš„ **æ•°æ®ä¸ŠæŠ¥ (0x21)** ä¸ **æ—¶é—´åŒæ­¥ (0x22)**ï¼›
-   è‡ªåŠ¨è§£æ XML æŠ¥æ–‡ï¼ŒéªŒè¯å®Œæ•´æ€§ï¼›
-   æ•°æ®å…¥åº“ï¼ˆMySQLï¼‰ï¼›
-   æä¾› RESTful API ä¾›å‰ç«¯æŸ¥è¯¢ï¼›
-   å¯æ‰©å±•æ”¯æŒè®¾å¤‡ç®¡ç†ã€å®æ—¶ç›‘æ§ç­‰åŠŸèƒ½ã€‚

## äºŒã€ç³»ç»Ÿæ¶æ„è®¾è®¡

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       çº¢å¤–è®¾å¤‡ Ã— 160       â”‚
    â”‚  TCPä¸ŠæŠ¥XMLï¼ˆç«¯å£8085ï¼‰     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        TCPæ¥å…¥æœåŠ¡å±‚        â”‚
    â”‚ Python asyncio TCP Server â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     åè®®è§£ææ¨¡å—ï¼ˆXMLâ†’JSONï¼‰â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      æ•°æ®å­˜å‚¨å±‚ï¼ˆMySQLï¼‰    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     APIæœåŠ¡å±‚ï¼ˆFastAPIï¼‰   â”‚
    â”‚ æä¾›æŸ¥è¯¢ã€ç›‘æ§ã€é…ç½®æ¥å£     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     Webå‰ç«¯ / æŠ¥è¡¨å¯è§†åŒ–     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ä¸‰ã€è®¾å¤‡é€šä¿¡åè®®æ¦‚è¿°

### 3.1 é€šä¿¡æ–¹å¼

-   ä¼ è¾“åè®®ï¼šTCP\
-   ç«¯å£ï¼š8085\
-   æŠ¥æ–‡æ ¼å¼ï¼šäºŒè¿›åˆ¶ï¼ˆåå…­è¿›åˆ¶å¤´å°¾ï¼‰+ XML æ•°æ®ä½“\
-   ç¼–ç ï¼šUTF-8\
-   å®¢æˆ·ç«¯ï¼šçº¢å¤–è®¾å¤‡\
-   æœåŠ¡å™¨ï¼šæœ¬ç³»ç»Ÿ

### 3.2 æŠ¥æ–‡ç»“æ„å®šä¹‰

  å­—æ®µ   åç§°       é•¿åº¦     è¯´æ˜
  ------ ---------- -------- -------------------------------
  HEAD   èµ·å§‹å­—å¤´   3å­—èŠ‚    å›ºå®š `FA F5 F6`
  SEQ    æµæ°´å·     2å­—èŠ‚    ä» 0\~65535å¾ªç¯
  TYPE   å‘½ä»¤ç±»å‹   1å­—èŠ‚    0x21 æ•°æ®ä¸ŠæŠ¥ / 0x22 æ—¶é—´åŒæ­¥
  LEN    æ•°æ®é•¿åº¦   2å­—èŠ‚    é«˜ä½åœ¨å‰ï¼ˆå¤§ç«¯åºï¼‰
  DATA   æ•°æ®       ä¸å®šé•¿   XMLæ ¼å¼å­—ç¬¦ä¸²
  TAIL   ç»“æŸå­—èŠ‚   3å­—èŠ‚    å›ºå®š `FA F6 F5`

## å››ã€æœåŠ¡ç«¯æ ¸å¿ƒé€»è¾‘

``` python
import asyncio
import struct
import xml.etree.ElementTree as ET

async def handle_client(reader, writer):
    addr = writer.get_extra_info('peername')
    print(f"[è¿æ¥] {addr}")

    buffer = b""
    while True:
        data = await reader.read(1024)
        if not data:
            break
        buffer += data

        while b'\xFA\xF5\xF6' in buffer and b'\xFA\xF6\xF5' in buffer:
            start = buffer.find(b'\xFA\xF5\xF6')
            end = buffer.find(b'\xFA\xF6\xF5', start)
            if end == -1:
                break
            packet = buffer[start:end+3]
            buffer = buffer[end+3:]

            try:
                result = parse_packet(packet)
                if result:
                    print(f"[{result['uuid']}] IN:{result['in']} OUT:{result['out']}")
                    await save_to_db(result)
                    ack = f"<UP_SENSOR_DATA_RES><uuid>{result['uuid']}</uuid><ret>0</ret></UP_SENSOR_DATA_RES>"
                    writer.write(ack.encode())
                    await writer.drain()
            except Exception as e:
                print("è§£æå¼‚å¸¸:", e)
    writer.close()
    print(f"[æ–­å¼€] {addr}")
```

## äº”ã€æ•°æ®åº“è®¾è®¡

``` sql
CREATE TABLE device_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    uuid VARCHAR(32),
    in_count INT,
    out_count INT,
    time DATETIME,
    battery_level INT,
    signal_status TINYINT,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## å…­ã€API æœåŠ¡è®¾è®¡ï¼ˆFastAPIï¼‰

``` python
from fastapi import FastAPI
import pymysql

app = FastAPI()

@app.get("/api/data/latest")
def get_latest(uuid: str):
    db = pymysql.connect(host="localhost", user="root", password="123456", database="infrared")
    cursor = db.cursor()
    cursor.execute("SELECT * FROM device_data WHERE uuid=%s ORDER BY id DESC LIMIT 1", (uuid,))
    row = cursor.fetchone()
    return {"uuid": row[1], "in": row[2], "out": row[3], "time": row[4]}
```

## ä¸ƒã€éƒ¨ç½²æ–¹æ¡ˆ

``` bash
sudo apt install python3-pip mysql-server
pip install fastapi uvicorn aiomysql
nohup python3 tcp_server.py &
nohup uvicorn api:app --host 0.0.0.0 --port 8000 &
```

## å…«ã€æ‰©å±•è§„åˆ’

  åŠŸèƒ½æ¨¡å—         æè¿°
  ---------------- --------------------------
  è®¾å¤‡æ³¨å†Œä¸ç»‘å®š   ç®¡ç†è®¾å¤‡ä¸é—¨åº—çš„å¯¹åº”å…³ç³»
  å®æ—¶ç›‘æ§         WebSocketæ¨é€æœ€æ–°äººæ•°
  å¼‚å¸¸æŠ¥è­¦         ç”µé‡ä½ã€ä¿¡å·ä¸¢å¤±è‡ªåŠ¨å‘Šè­¦
  æŠ¥è¡¨ç»Ÿè®¡         æŒ‰æ—¥ã€å‘¨ã€æœˆç”Ÿæˆå‡ºå…¥ç»Ÿè®¡
