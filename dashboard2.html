
<!doctype html><html><head><meta charset='utf-8'><title>���ݿ���</title>
<script src="/static/chart.umd.min.js"></script>
<style>body{font-family:system-ui,Arial;margin:0;display:flex}.sidebar{width:220px;background:#f1f3f5;height:100vh;padding:16px;box-sizing:border-box}.sidebar a{display:block;margin:8px 0;color:#222;text-decoration:none}.main{flex:1;padding:24px}.row{display:flex;gap:24px;flex-wrap:wrap}.card{border:1px solid #ddd;border-radius:8px;padding:16px;flex:1;min-width:320px}.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}.mini{border:1px solid #eee;border-radius:6px;padding:10px;background:#fafafa}table{width:100%;border-collapse:collapse}th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:13px}.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}.btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}.btn-primary{background:#2b8a3e;color:#fff;border:0}</style></head><body>
          <div class='sidebar'><h3>����</h3><a href='/dashboard'>���ݿ���</a><a href='/admin/db'>���ݹ���</a><a href='/classification'>�豸����</a><a href='/alerts'>�澯����</a><a href='/device'>�豸�༭</a></div>
<div class='main'>
  <h2>����������ݿ���</h2>
  <div class='toolbar'>�豸��<select id='device'></select> ���ڷ�Χ��<input id='start' type='date'> - <input id='end' type='date'> <button id='load' class='btn btn-primary'>����</button> <button id='refreshLatest' class='btn'>��������</button> <label><input type='checkbox' id='auto'>�Զ�ˢ��</label> <button id='today' class='btn'>����</button> <button id='last7' class='btn'>���7��</button> <button id='exportDaily' class='btn'>������ͳ��CSV</button> <button id='exportHourly' class='btn'>����Сʱͳ��CSV</button> <button id='exportHistory' class='btn'>������ʷCSV</button></div>
  <div class='row'><div class='card'><canvas id='dailyChart' style='height:320px'></canvas></div><div class='card'><canvas id='hourChart' style='height:320px'></canvas></div></div>
  <div class='grid' style='margin-top:16px'><div class='mini' id='sum_in'>IN�ܼƣ�</div><div class='mini' id='sum_out'>OUT�ܼƣ�</div><div class='mini' id='sum_net'>��������</div><div class='mini' id='sum_last'>����ϱ���</div></div>
  <div class='card' style='margin-top:16px'><h3>�����¼</h3><table><thead><tr><th>ʱ��</th><th>IN</th><th>OUT</th><th>����</th><th>�ź�</th></tr></thead><tbody id='tbl'></tbody></table></div>
</div>
<script>
const deviceSel=document.getElementById('device');const startEl=document.getElementById('start');const endEl=document.getElementById('end');const autoEl=document.getElementById('auto');const tbl=document.getElementById('tbl');let dailyChart,hourChart,timer;function fmtTime(s){if(!s)return'';const t=String(s).trim();if(/^[0-9]{14}$/.test(t))return t.slice(0,4)+'-'+t.slice(4,6)+'-'+t.slice(6,8)+' '+t.slice(8,10)+':'+t.slice(10,12)+':'+t.slice(12,14);return t;}window.addEventListener('load',()=>{(async()=>{try{await loadDevices();await loadStats();if(typeof Chart==='undefined'){const s=document.createElement('script');s.src='/static/chart.umd.min.js';s.onload=()=>loadStats();document.head.appendChild(s);}}catch(e){}})();});
async function loadDevices(){const res=await fetch('/api/v1/devices');const list=await res.json();deviceSel.innerHTML='';for(const d of list){const opt=document.createElement('option');opt.value=d.uuid;opt.textContent=(d.name? `${d.name} (${d.uuid})`:d.uuid);deviceSel.appendChild(opt);}}
async function loadStats(){const uuid=deviceSel.value;const today=new Date().toISOString().slice(0,10);const startDate=startEl.value|| (endEl.value? '' : new Date(Date.now()-29*24*3600*1000).toISOString().slice(0,10));const endDate=endEl.value|| today;const start=startDate? startDate+' 00:00:00':'';const end=endDate? endDate+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);const sumRes=await fetch('/api/v1/stats/summary?'+new URLSearchParams({uuid}).toString());const sum=await sumRes.json();document.getElementById('sum_in').innerText='IN�ܼƣ�'+(sum.in_total||0);document.getElementById('sum_out').innerText='OUT�ܼƣ�'+(sum.out_total||0);document.getElementById('sum_net').innerText='��������'+((sum.in_total||0)-(sum.out_total||0));document.getElementById('sum_last').innerText='����ϱ���'+fmtTime(sum.last_time||'')+' IN='+(sum.last_in??'')+' OUT='+(sum.last_out??'');const res=await fetch('/api/v1/stats/daily?'+q.toString());const daily=await res.json();const lab=daily.map(x=>x.day);const inData=daily.map(x=>x.in_total||0);const outData=daily.map(x=>x.out_total||0);try{if(typeof Chart!=='undefined'){const ctx=document.getElementById('dailyChart').getContext('2d');if(dailyChart)dailyChart.destroy();dailyChart=new Chart(ctx,{type:'line',data:{labels:lab,datasets:[{label:'IN',data:inData,borderColor:'#2b8a3e'},{label:'OUT',data:outData,borderColor:'#d9480f'}]},options:{responsive:true,maintainAspectRatio:false}});}}catch(e){}const hq=new URLSearchParams({uuid,date:endDate});const hres=await fetch('/api/v1/stats/hourly?'+hq.toString());const hourly=await hres.json();const hLab=hourly.map(x=>x.hour);const hIn=hourly.map(x=>x.in_total||0);const hOut=hourly.map(x=>x.out_total||0);try{if(typeof Chart!=='undefined'){const hctx=document.getElementById('hourChart').getContext('2d');if(hourChart)hourChart.destroy();hourChart=new Chart(hctx,{type:'bar',data:{labels:hLab,datasets:[{label:'IN',data:hIn,backgroundColor:'#74c69d'},{label:'OUT',data:hOut,backgroundColor:'#f4a261'}]},options:{responsive:true,maintainAspectRatio:false}});}}catch(e){}const hparams=new URLSearchParams({uuid,limit:200});const hist=await (await fetch('/api/v1/data/history?'+hparams.toString())).json();tbl.innerHTML='';for(const r of hist){const tr=document.createElement('tr');tr.innerHTML=`<td>${fmtTime(r.time)}</td><td>${r.in_count??r.in??''}</td><td>${r.out_count??r.out??''}</td><td>${r.battery_level??''}</td><td>${r.signal_status??''}</td>`;tbl.appendChild(tr);}}
document.getElementById('load').addEventListener('click',loadStats);document.getElementById('today').addEventListener('click',()=>{const d=new Date().toISOString().slice(0,10);startEl.value=d;endEl.value=d;loadStats();});document.getElementById('last7').addEventListener('click',()=>{const now=new Date();const end=now.toISOString().slice(0,10);const start=new Date(now.getTime()-6*24*3600*1000).toISOString().slice(0,10);startEl.value=start;endEl.value=end;loadStats();});autoEl.addEventListener('change',()=>{if(autoEl.checked){timer=setInterval(loadStats,10000);}else{clearInterval(timer);}});document.getElementById('exportDaily').addEventListener('click',()=>{const uuid=deviceSel.value;const start=startEl.value? startEl.value+' 00:00:00':'';const end=endEl.value? endEl.value+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);window.open('/api/v1/export/daily?'+q.toString(),'_blank');});document.getElementById('exportHourly').addEventListener('click',()=>{const uuid=deviceSel.value;const date=endEl.value||new Date().toISOString().slice(0,10);window.open('/api/v1/export/hourly?'+new URLSearchParams({uuid,date}).toString(),'_blank');});document.getElementById('exportHistory').addEventListener('click',()=>{const uuid=deviceSel.value;const start=startEl.value? startEl.value+' 00:00:00':'';const end=endEl.value? endEl.value+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);window.open('/api/v1/export/history?'+q.toString(),'_blank');});(async()=>{await loadDevices();await loadStats();})();
document.getElementById('refreshLatest').addEventListener('click',loadLatest);
async function loadLatest(){const uuid=deviceSel.value;await loadStats();const r=await fetch('/api/v1/data/latest?'+new URLSearchParams({uuid}).toString());const x=await r.json();const t=fmtTime(x.time||'');const inc=x.in_count??x.in??'';const outc=x.out_count??x.out??'';document.getElementById('sum_last').textContent='����ϱ���'+t+' IN='+inc+' OUT='+outc;await fetch('/api/v1/device/time-sync/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuid})});}
</script>
</body></html>

