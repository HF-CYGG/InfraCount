
<!doctype html><html><head><meta charset='utf-8'><title>数据看板</title>
<script src="/static/chart.min.js"></script>
<style>body{font-family:Consolas,Menlo,monospace;margin:0;display:flex;background:#0d1117;color:#c9d1d9}a{color:#8b949e}.sidebar{width:220px;background:#0b0f14;height:100vh;padding:16px;box-sizing:border-box;border-right:1px solid #161b22}.sidebar a{display:block;margin:8px 0;color:#c9d1d9;text-decoration:none}.sidebar a:hover{color:#58a6ff}.main{flex:1;padding:24px}.row{display:flex;gap:24px;flex-wrap:wrap}.card{background:#161b22;border:1px solid #1f2630;border-radius:10px;padding:16px;flex:1;min-width:320px;box-shadow:0 2px 8px rgba(0,0,0,.35);position:relative}.card::before{content:'';position:absolute;left:0;top:0;width:100%;height:3px;background:linear-gradient(90deg,#00e676,#58a6ff)}.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}.mini{border:1px solid #1f2630;border-radius:8px;padding:12px;background:#0d1117}.mini{display:flex;align-items:center;gap:8px}.mini:before{content:'?';color:#58a6ff}.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}.btn{padding:8px 14px;border-radius:8px;border:1px solid #1f2630;background:#0d1117;color:#c9d1d9;cursor:pointer;transition:all .2s}.btn:hover{border-color:#58a6ff;box-shadow:0 0 0 2px rgba(88,166,255,.15)}.btn-primary{background:#0b1e11;color:#00e676;border:1px solid #173b28}.btn-primary:hover{box-shadow:0 0 0 2px rgba(0,230,118,.15)}canvas{background:transparent}table{width:100%;border-collapse:collapse;background:#161b22;border:1px solid #1f2630}th,td{border:1px solid #1f2630;padding:10px;text-align:left;font-size:13px}th{color:#8b949e}</style></head><body>
          <div class='sidebar'><h3>导航</h3><a href='/dashboard'>数据看板</a><a href='/admin/db'>数据管理</a><a href='/classification'>设备分类</a><a href='/alerts'>告警中心</a><a href='/device'>设备编辑</a></div>
<div class='main'>
  <h2>红外计数数据看板</h2>
  <div class='toolbar'>设备：<select id='device'></select> 日期范围：<input id='start' type='date'> - <input id='end' type='date'> <button id='load' class='btn btn-primary'>加载</button> <button id='refreshLatest' class='btn'>加载最新</button> <label><input type='checkbox' id='auto'>自动刷新</label> <button id='today' class='btn'>今天</button> <button id='last7' class='btn'>最近7天</button> <button id='exportDaily' class='btn'>导出日统计CSV</button> <button id='exportHourly' class='btn'>导出小时统计CSV</button> <button id='exportHistory' class='btn'>导出历史CSV</button></div>
  <div class='row'><div class='card'><canvas id='dailyChart' style='height:320px'></canvas></div><div class='card'><canvas id='hourChart' style='height:320px'></canvas></div></div>
  <div class='grid' style='margin-top:16px'><div class='mini' id='sum_in'></div><div class='mini' id='sum_out'></div><div class='mini' id='sum_net'></div><div class='mini' id='sum_last'></div></div>
  <div class='card' style='margin-top:16px'><h3>最近记录</h3><table><thead><tr><th>时间</th><th>IN</th><th>OUT</th><th>电量</th><th>信号</th></tr></thead><tbody id='tbl'></tbody></table></div>
</div>
<script>
Chart.defaults.color='#c9d1d9';Chart.defaults.font.family='Consolas, Menlo, monospace';const deviceSel=document.getElementById('device');const startEl=document.getElementById('start');const endEl=document.getElementById('end');const autoEl=document.getElementById('auto');const tbl=document.getElementById('tbl');let dailyChart,hourChart,timer;function fmtTime(s){if(!s)return'';const t=String(s).trim();if(/^[0-9]{14}$/.test(t))return t.slice(0,4)+'-'+t.slice(4,6)+'-'+t.slice(6,8)+' '+t.slice(8,10)+':'+t.slice(10,12)+':'+t.slice(12,14);return t;}
async function loadDevices(){const res=await fetch('/api/v1/devices');const list=await res.json();deviceSel.innerHTML='';for(const d of list){const opt=document.createElement('option');opt.value=d.uuid;opt.textContent=(d.name? `${d.name} (${d.uuid})`:d.uuid);deviceSel.appendChild(opt);}}
async function loadStats(){const uuid=deviceSel.value;const today=new Date().toISOString().slice(0,10);const startDate=startEl.value|| (endEl.value? '' : new Date(Date.now()-29*24*3600*1000).toISOString().slice(0,10));const endDate=endEl.value|| today;const start=startDate? startDate+' 00:00:00':'';const end=endDate? endDate+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);const res=await fetch('/api/v1/stats/daily?'+q.toString());const daily=await res.json();const lab=daily.map(x=>x.day);const inData=daily.map(x=>x.in_total||0);const outData=daily.map(x=>x.out_total||0);const ctx=document.getElementById('dailyChart').getContext('2d');if(dailyChart)dailyChart.destroy();dailyChart=new Chart(ctx,{type:'line',data:{labels:lab,datasets:[{label:'IN',data:inData,borderColor:'#2b8a3e'},{label:'OUT',data:outData,borderColor:'#d9480f'}]},options:{responsive:true,maintainAspectRatio:false}});const sumRes=await fetch('/api/v1/stats/summary?'+new URLSearchParams({uuid}).toString());const sum=await sumRes.json();document.getElementById('sum_in').innerText='IN总计：'+(sum.in_total||0);document.getElementById('sum_out').innerText='OUT总计：'+(sum.out_total||0);document.getElementById('sum_net').innerText='净流量：'+((sum.in_total||0)-(sum.out_total||0));document.getElementById('sum_last').innerText='最近上报：'+fmtTime(sum.last_time||'')+' IN='+(sum.last_in??'')+' OUT='+(sum.last_out??'');const hq=new URLSearchParams({uuid,date:endDate});const hres=await fetch('/api/v1/stats/hourly?'+hq.toString());const hourly=await hres.json();const hLab=hourly.map(x=>x.hour);const hIn=hourly.map(x=>x.in_total||0);const hOut=hourly.map(x=>x.out_total||0);const hctx=document.getElementById('hourChart').getContext('2d');if(hourChart)hourChart.destroy();hourChart=new Chart(hctx,{type:'bar',data:{labels:hLab,datasets:[{label:'IN',data:hIn,backgroundColor:'#74c69d'},{label:'OUT',data:hOut,backgroundColor:'#f4a261'}]},options:{responsive:true,maintainAspectRatio:false}});const hparams=new URLSearchParams({uuid,limit:200});const hist=await (await fetch('/api/v1/data/history?'+hparams.toString())).json();tbl.innerHTML='';for(const r of hist){const tr=document.createElement('tr');tr.innerHTML=`<td>${fmtTime(r.time)}</td><td>${r.in_count??r.in??''}</td><td>${r.out_count??r.out??''}</td><td>${r.battery_level??''}</td><td>${r.signal_status??''}</td>`;tbl.appendChild(tr);}}
document.getElementById('load').addEventListener('click',loadStats);document.getElementById('today').addEventListener('click',()=>{const d=new Date().toISOString().slice(0,10);startEl.value=d;endEl.value=d;loadStats();});document.getElementById('last7').addEventListener('click',()=>{const now=new Date();const end=now.toISOString().slice(0,10);const start=new Date(now.getTime()-6*24*3600*1000).toISOString().slice(0,10);startEl.value=start;endEl.value=end;loadStats();});autoEl.addEventListener('change',()=>{if(autoEl.checked){timer=setInterval(loadStats,10000);}else{clearInterval(timer);}});document.getElementById('exportDaily').addEventListener('click',()=>{const uuid=deviceSel.value;const start=startEl.value? startEl.value+' 00:00:00':'';const end=endEl.value? endEl.value+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);window.open('/api/v1/export/daily?'+q.toString(),'_blank');});document.getElementById('exportHourly').addEventListener('click',()=>{const uuid=deviceSel.value;const date=endEl.value||new Date().toISOString().slice(0,10);window.open('/api/v1/export/hourly?'+new URLSearchParams({uuid,date}).toString(),'_blank');});document.getElementById('exportHistory').addEventListener('click',()=>{const uuid=deviceSel.value;const start=startEl.value? startEl.value+' 00:00:00':'';const end=endEl.value? endEl.value+' 23:59:59':'';const q=new URLSearchParams({uuid});if(start)q.append('start',start);if(end)q.append('end',end);window.open('/api/v1/export/history?'+q.toString(),'_blank');});(async()=>{await loadDevices();await loadStats();})();
document.getElementById('refreshLatest').addEventListener('click',loadLatest);
async function loadLatest(){const uuid=deviceSel.value;await loadStats();const r=await fetch('/api/v1/data/latest?'+new URLSearchParams({uuid}).toString());const x=await r.json();const t=fmtTime(x.time||'');const inc=x.in_count??x.in??'';const outc=x.out_count??x.out??'';document.getElementById('sum_last').textContent='最近上报：'+t+' IN='+inc+' OUT='+outc;await fetch('/api/v1/device/time-sync/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuid})});}
</script>
</body></html>

